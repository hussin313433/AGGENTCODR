<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Code Editor</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/tomorrow-night-blue.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

  <style>
    :root {
      --bg-color: #0a0a0b;
      --panel-bg-color: #181821;
      --border-color: #2a2a36;
      --text-color: #e8e8f0;
      --primary-color: #7c3aed;
      --primary-hover-color: #6d28d9;
      --secondary-color: #06b6d4;
      --secondary-hover-color: #0891b2;
      --accent-color: #f59e0b;
      --accent-hover-color: #d97706;
      --input-bg-color: #1f1f2e;
      --header-bg-color: #131318;
      --button-bg-color: #2a2a36;
      --button-hover-bg-color: #3a3a48;
      --user-message-bg: linear-gradient(135deg, #7c3aed, #a855f7);
      --ai-message-bg: linear-gradient(135deg, #1f1f2e, #2a2a36);
      --task-bg-color: #1a1a24;
      --success-color: #10b981;
      --error-color: #ef4444;
      --warning-color: #f59e0b;
      --font-family: 'IBM Plex Sans Arabic', sans-serif;
      --font-mono: 'SF Mono', 'Fira Code', 'Menlo', monospace;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.6);
      --glass-bg: rgba(42, 42, 54, 0.8);
      --glass-border: rgba(255, 255, 255, 0.1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
      overflow: hidden;
    }

    body {
      background: linear-gradient(135deg, var(--bg-color) 0%, #0f0f1a 50%, var(--bg-color) 100%);
      color: var(--text-color);
      font-family: var(--font-family);
      display: flex;
      position: relative;
    }
    
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 20%, rgba(124, 58, 237, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(6, 182, 212, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 40% 60%, rgba(245, 158, 11, 0.05) 0%, transparent 50%);
      pointer-events: none;
      z-index: -1;
    }

    .app-container {
      display: flex;
      width: 100%;
      height: 100%;
    }

    .chat-panel, .editor-panel {
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .chat-panel {
      width: 40%;
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border-left: 1px solid var(--glass-border);
      padding: 0.75rem;
      gap: 0.75rem;
      position: relative;
    }
    
    .chat-panel::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--primary-color), transparent);
    }

    .editor-panel {
      width: 60%;
    }
    
    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border-color);
      gap: 0.5rem;
    }
    
    .panel-header h1 {
      font-size: 1.2rem;
      font-weight: 500;
      text-shadow: 0 0 8px rgba(0,0,0,0.5);
      flex: 1;
      text-align: center;
      margin: 0;
    }

    .header-icon-btn {
      background-color: var(--button-bg-color);
      border: 1px solid var(--border-color);
      color: var(--text-color);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      font-size: 1.5rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s ease;
    }
    .header-icon-btn:hover {
       background-color: var(--button-hover-bg-color);
    }
    
    .task-progress {
        background-color: var(--task-bg-color);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        flex-shrink: 0;
    }
    .task-header {
        padding: 0.75rem 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
    }
    .task-header > div {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-weight: 500;
    }
    .task-meta {
        display: flex;
        align-items: center;
        gap: 1rem;
        color: #888;
    }
    .chevron-icon {
        transition: transform 0.3s ease;
    }
    .task-progress.collapsed .chevron-icon {
        transform: rotate(-90deg);
    }
    .task-list {
        padding: 0 1rem 1rem 1rem;
        max-height: 500px;
        overflow: hidden;
        transition: max-height 0.3s ease, padding 0.3s ease;
    }
    .task-progress.collapsed .task-list {
        max-height: 0;
        padding-top: 0;
        padding-bottom: 0;
    }
    .task-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.5rem 0.5rem;
        color: #a0a0a0;
    }
    .task-icon {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
    }
    .task-icon .check-icon { color: var(--success-color); }
    .task-icon .error-icon { color: var(--error-color); }
    .task-icon .spinner {
       width: 16px; height: 16px;
       border: 2px solid rgba(255,255,255,0.3);
       border-top-color: var(--primary-color);
    }


    .messages-container {
      flex-grow: 1;
      overflow-y: auto;
      padding: 1rem;
    }
    
    .message {
      padding: 1rem 1.25rem;
      border-radius: 16px;
      margin-bottom: 1rem;
      max-width: 85%;
      line-height: 1.6;
      white-space: pre-wrap;
      position: relative;
      box-shadow: var(--shadow-sm);
      transition: all 0.3s ease;
    }

    .message:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .message.user {
      background: var(--user-message-bg);
      color: white;
      align-self: flex-start;
      margin-left: auto;
      border-bottom-left-radius: 6px;
    }

    .message.user::before {
      content: '';
      position: absolute;
      bottom: 0;
      right: -8px;
      width: 0;
      height: 0;
      border: 8px solid transparent;
      border-left-color: #a855f7;
      border-bottom: none;
    }

    .message.ai {
      background: var(--ai-message-bg);
      border: 1px solid var(--border-color);
      align-self: flex-end;
      margin-right: auto;
      border-bottom-right-radius: 6px;
    }

    .message.ai::before {
      content: '';
      position: absolute;
      bottom: 0;
      left: -8px;
      width: 0;
      height: 0;
      border: 8px solid transparent;
      border-right-color: var(--ai-message-bg);
      border-bottom: none;
    }
    
    .message.loading {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .spinner {
      width: 20px; height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: var(--primary-color);
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    #chat-form {
      border-top: 1px solid var(--border-color);
      background: var(--glass-bg);
      backdrop-filter: blur(12px);
      padding: 1rem;
      flex-shrink: 0;
      position: relative;
    }

    .input-bar {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      background: var(--input-bg-color);
      border: 2px solid var(--border-color);
      border-radius: 50px;
      padding: 0.5rem;
      transition: all 0.3s ease;
      box-shadow: var(--shadow-sm);
    }

    .input-bar:focus-within {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
    }

    .tools-button {
      background: var(--button-bg-color);
      color: var(--text-color);
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      flex-shrink: 0;
    }

    .tools-button:hover {
      background: var(--primary-color);
      color: white;
      transform: rotate(90deg);
    }

    .tools-button.active {
      background: var(--primary-color);
      color: white;
    }

    .input-wrapper {
      flex: 1;
      position: relative;
    }

    .active-tool-indicator {
      position: absolute;
      top: -28px;
      left: 0;
      right: 0;
      background: var(--primary-color);
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: var(--shadow-sm);
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .clear-tool-btn {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 1rem;
      padding: 0;
      margin-left: 0.5rem;
      opacity: 0.8;
      transition: opacity 0.2s ease;
    }

    .clear-tool-btn:hover {
      opacity: 1;
    }

    #prompt-input {
      width: 100%;
      background: transparent;
      color: var(--text-color);
      border: none;
      padding: 0.75rem 1rem;
      font-family: inherit;
      font-size: 1rem;
      outline: none;
    }

    #prompt-input::placeholder {
      color: #888;
    }

    #send-button {
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      flex-shrink: 0;
    }

    #send-button:hover {
      background: var(--primary-hover-color);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    #send-button:disabled {
      background: var(--button-bg-color);
      cursor: not-allowed;
      transform: none;
    }

    /* Compact Tools Menu */
    .tools-menu {
      position: absolute;
      bottom: 60px;
      left: 0.5rem;
      background: var(--panel-bg-color);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      box-shadow: var(--shadow-xl);
      backdrop-filter: blur(16px);
      z-index: 1000;
      min-width: 200px;
      overflow: hidden;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .tool-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      border-bottom: 1px solid var(--border-color);
    }

    .tool-item:last-child {
      border-bottom: none;
    }

    .tool-item:hover {
      background: var(--button-bg-color);
    }

    .tool-item.active {
      background: var(--primary-color);
      color: white;
    }

    .tool-emoji {
      font-size: 1.2rem;
      width: 24px;
      text-align: center;
      flex-shrink: 0;
    }

    .tool-text {
      font-size: 0.9rem;
      font-weight: 500;
    }

    .tool-divider {
      height: 1px;
      background: var(--border-color);
      margin: 0.25rem 0;
    }

    .editor-header {
      display: flex; justify-content: space-between;
      align-items: center; padding: 0.75rem 1rem;
      background-color: #1e1e1e; flex-shrink: 0;
    }

    .editor-header h2 { font-size: 1rem; font-weight: 500; }
    .editor-toolbar { display: flex; gap: 0.5rem; align-items: center; }

    .editor-toolbar button {
      background-color: var(--button-bg-color);
      border: 1px solid var(--border-color);
      color: var(--text-color); padding: 0.5rem 1rem;
      border-radius: 5px; cursor: pointer;
      transition: background-color 0.2s ease;
      font-family: inherit; display: flex;
      align-items: center; gap: 0.5rem;
    }

    .editor-toolbar button:hover { background-color: var(--button-hover-bg-color); }
    .editor-toolbar button:disabled { background-color: #333; color: #777; cursor: not-allowed; border-color: #444; }
    .editor-toolbar button#apply-btn { background-color: var(--primary-color); color: white; }
    .editor-toolbar button#apply-btn:hover { background-color: var(--primary-hover-color); }

    .editor-content {
      flex-grow: 1;
      overflow: auto;
      background-color: #1e1e1e;
      display: flex;
      direction: ltr;
    }
    
    .line-numbers-gutter {
        flex-shrink: 0;
        padding: 1rem;
        font-family: var(--font-mono);
        font-size: 14px;
        line-height: 1.5;
        color: #888;
        text-align: right;
        user-select: none;
        background-color: var(--panel-bg-color);
        border-right: 1px solid var(--border-color);
    }

    #code-display {
      padding: 1rem;
      white-space: pre;
      font-family: var(--font-mono);
      font-size: 14px;
      line-height: 1.5;
      outline: none;
      flex-grow: 1;
    }
    
    .modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex; align-items: center; justify-content: center;
      z-index: 1000;
    }

    .modal-content {
      background-color: var(--bg-color);
      width: 90%; height: 90%;
      border-radius: 8px; display: flex; flex-direction: column;
      box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    }

    .modal-header {
      padding: 0.5rem 1rem; display: flex;
      justify-content: flex-end; background-color: var(--header-bg-color);
      border-bottom: 1px solid var(--border-color);
      border-top-left-radius: 8px; border-top-right-radius: 8px;
    }

    #close-preview-btn {
      background: none; border: none;
      color: var(--text-color); font-size: 1.5rem; cursor: pointer;
    }

    #preview-frame {
      width: 100%; height: 100%; border: none;
      flex-grow: 1; border-bottom-left-radius: 8px; border-bottom-right-radius: 8px;
    }
    
    /* Custom Highlight.js theme overrides to match image */
    #code-display.hljs {
      background: var(--bg-color);
      color: var(--text-color);
    }
    .hljs-comment {
      color: #7f848e;
    }
    .hljs-selector-tag,
    .hljs-selector-class,
    .hljs-selector-id {
      color: #98c379; /* Green for selectors */
    }
    .hljs-attribute {
      color: #56c4d8; /* Cyan for properties */
    }
    .hljs-number,
    .hljs-string,
    .hljs-literal,
    .hljs-attr { /* attr is for HTML attributes */
      color: #e5c07b; /* Orange for values and attributes */
    }
    .hljs-built_in {
      color: #56c4d8; /* Cyan for built-ins like var() */
    }
    .hljs-name, /* For HTML/XML tags */
    .hljs-tag {
      color: #e06c75; /* Soft red for tags */
    }
    .hljs-keyword {
      color: #c678dd; /* Purple for keywords */
    }
    .highlight-modified {
      background: rgba(52, 211, 153, 0.18); /* ÿ¥ŸÅÿßŸÅÿ© ÿ£ÿÆÿ∂ÿ± */
      transition: background 0.5s;
    }
    .ai-step-code {
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      color: #e8e8f0;
      padding: 1.25rem;
      border-radius: 0 0 12px 12px;
      border: 1px solid var(--border-color);
      border-top: none;
      font-family: var(--font-mono);
      font-size: 14px;
      max-height: 300px;
      overflow: auto;
      margin: 0;
      direction: ltr;
      white-space: pre;
      position: relative;
      box-shadow: var(--shadow-lg);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
      line-height: 1.6;
    }
    
    .ai-step-code:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-xl);
      border-color: var(--primary-color);
    }
    
    .ai-step-code::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color), var(--accent-color));
      border-radius: 12px 12px 0 0;
    }
    
    .step-result-container {
      background: var(--ai-message-bg);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 1rem;
      margin: 1rem 0;
      position: relative;
      box-shadow: var(--shadow-md);
    }
    
    .step-result-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid var(--border-color);
    }
    
    .step-result-icon {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--success-color), #10b981);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1rem;
      flex-shrink: 0;
    }
    
    .step-result-title {
      font-weight: 600;
      color: var(--success-color);
      font-size: 1rem;
    }
    
    .step-result-description {
      color: #888;
      font-size: 0.9rem;
      margin-top: 0.25rem;
    }
    
    .code-preview-actions {
      display: flex;
      gap: 0.5rem;
      margin: 1rem 0 0.5rem 0;
      justify-content: flex-start;
    }
    
    .code-action-btn {
      background: var(--button-bg-color);
      border: 1px solid var(--border-color);
      color: var(--text-color);
      padding: 0.5rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .code-action-btn:hover {
      background: var(--button-hover-bg-color);
      transform: translateY(-1px);
    }
    
    .code-action-btn.primary {
      background: var(--primary-color);
      color: white;
    }
    
    .code-action-btn.primary:hover {
      background: var(--primary-hover-color);
    }
    
    .code-container {
      position: relative;
    }
    
    .code-stats {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--glass-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px 8px 0 0;
      padding: 0.5rem 1rem;
      font-size: 0.8rem;
      color: #888;
      font-family: var(--font-mono);
    }
    
    .lines-count, .chars-count {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    
    .lines-count::before {
      content: 'üìÑ';
      font-size: 0.9rem;
    }
    
    .chars-count::before {
      content: 'üìù';
      font-size: 0.9rem;
    }
    
    /* Diff View Styles */
    .diff-container {
      background: var(--panel-bg-color);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      overflow: hidden;
      margin: 1rem 0;
      box-shadow: var(--shadow-lg);
    }
    
    .diff-header {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 0.75rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-family: var(--font-mono);
      font-size: 0.9rem;
    }
    
    .diff-stats {
      display: flex;
      gap: 1rem;
      align-items: center;
    }
    
    .diff-stat {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      font-weight: 600;
    }
    
    .additions {
      color: #22c55e;
    }
    
    .deletions {
      color: #ef4444;
    }
    
    .diff-toggle {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: background 0.2s ease;
    }
    
    .diff-toggle:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    .diff-content {
      max-height: 400px;
      overflow: auto;
      font-family: var(--font-mono);
      font-size: 14px;
      line-height: 1.4;
      direction: ltr;
    }
    
    .diff-line {
      display: flex;
      min-height: 20px;
      padding: 0;
      margin: 0;
      border: none;
      width: 100%;
    }
    
    .line-number {
      background: var(--panel-bg-color);
      color: #666;
      padding: 0.125rem 0.5rem;
      min-width: 50px;
      text-align: right;
      border-right: 1px solid var(--border-color);
      user-select: none;
      flex-shrink: 0;
      font-size: 12px;
    }
    
    .line-content {
      padding: 0.125rem 0.75rem;
      flex: 1;
      white-space: pre;
      min-height: 20px;
      overflow-x: auto;
    }
    
    .diff-line.added {
      background: rgba(34, 197, 94, 0.15);
      border-left: 3px solid #22c55e;
    }
    
    .diff-line.added .line-number {
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
    }
    
    .diff-line.removed {
      background: rgba(239, 68, 68, 0.15);
      border-left: 3px solid #ef4444;
    }
    
    .diff-line.removed .line-number {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }
    
    .diff-line.context {
      background: var(--bg-color);
    }
    
    .diff-line.context .line-number {
      color: #666;
    }
    
    .diff-line-indicator {
      width: 20px;
      padding: 0.125rem 0;
      text-align: center;
      font-weight: bold;
      flex-shrink: 0;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .diff-line.added .diff-line-indicator {
      background: rgba(34, 197, 94, 0.3);
      color: #22c55e;
    }
    
    .diff-line.added .diff-line-indicator::before {
      content: '+';
      font-weight: bold;
    }
    
    .diff-line.removed .diff-line-indicator {
      background: rgba(239, 68, 68, 0.3);
      color: #ef4444;
    }
    
    .diff-line.removed .diff-line-indicator::before {
      content: '‚àí';
      font-weight: bold;
    }
    
    .diff-line.context .diff-line-indicator {
      background: var(--panel-bg-color);
      color: #666;
    }
    
    .diff-line.context .diff-line-indicator::before {
      content: ' ';
    }
    
    /* Responsive diff view */
    @media (max-width: 768px) {
      .diff-content {
        font-size: 12px;
      }
      
      .line-number {
        min-width: 35px;
        font-size: 10px;
      }
      
      .diff-line-indicator {
        width: 15px;
        font-size: 10px;
      }
    }
    
    /* Horizontal scroll for long lines */
    .diff-content::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    .diff-content::-webkit-scrollbar-track {
      background: var(--panel-bg-color);
    }
    
    .diff-content::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 4px;
    }
    
    .diff-content::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
    
    /* General modern enhancements */
    html {
      scroll-behavior: smooth;
    }

    /* Custom Scrollbar Styles */
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }

    ::-webkit-scrollbar-track {
      background: var(--panel-bg-color);
      border-radius: 5px;
    }

    ::-webkit-scrollbar-thumb {
      background: #555;
      border-radius: 5px;
      border: 2px solid var(--panel-bg-color);
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #777;
    }
    
    /* Scrollbar ÿÆÿßÿµ ÿ®ŸÖÿ±ÿ®ÿπ ÿßŸÑŸÉŸàÿØ */
    .ai-step-code::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    .ai-step-code::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }

    .ai-step-code::-webkit-scrollbar-thumb {
      background: var(--primary-color);
      border-radius: 4px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .ai-step-code::-webkit-scrollbar-thumb:hover {
      background: var(--primary-hover-color);
    }

    /* Better focus outline for accessibility and aesthetics */
    :focus-visible {
      outline: 2px solid var(--primary-color);
      outline-offset: 2px;
      border-radius: 3px; /* So it applies nicely to various shapes */
    }

    /* Selection highlight color */
    ::selection {
      background-color: var(--primary-color);
      color: white;
    }

    /* Enhance inputs and textareas */
    #prompt-input,
    #code-display[contenteditable="true"] {
      border: 1px solid var(--border-color);
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    #prompt-input:focus,
    #code-display[contenteditable="true"]:focus {
      border-color: var(--primary-color);
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3), 0 0 0 1px var(--primary-color);
    }

    /* Enhance buttons */
    button {
      transition: background-color 0.2s ease, transform 0.1s ease;
    }

    button:active {
      transform: translateY(1px);
    }

    /* Panel and container styling for depth */
    .chat-panel,
    .task-progress,
    .modal-content {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .modal-content {
      border: 1px solid var(--border-color);
    }
    .chat-list {
      margin: 0.5rem 0 0.5rem 0;
      background: var(--panel-bg-color);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      max-height: 180px;
      overflow-y: auto;
      padding: 0.25rem 0.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    .chat-list-item {
      padding: 0.5rem 0.75rem;
      border-radius: 6px;
      cursor: pointer;
      color: var(--text-color);
      background: none;
      border: none;
      text-align: right;
      font-family: inherit;
      font-size: 1rem;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .chat-list-item.active {
      background: var(--primary-color);
      color: #fff;
      font-weight: bold;
    }
    .chat-list-item:hover:not(.active) {
      background: #333;
    }
    .chat-list-item .chat-icon {
      width: 18px;
      height: 18px;
      color: var(--primary-color);
      flex-shrink: 0;
    }
    .chat-list-overlay {
      position: fixed;
      top: 0; right: 0; bottom: 0; left: 0;
      background: rgba(0,0,0,0.35);
      z-index: 2000;
      display: none;
    }
    .chat-list-sidebar {
      position: fixed;
      top: 0; right: 0;
      width: 340px;
      max-width: 100vw;
      height: 100vh;
      background: var(--panel-bg-color);
      border-left: 1px solid var(--border-color);
      box-shadow: -2px 0 16px rgba(0,0,0,0.18);
      z-index: 2100;
      display: flex;
      flex-direction: column;
      transform: translateX(100%);
      transition: transform 0.3s cubic-bezier(.4,1.4,.6,1);
    }
    .chat-list-sidebar.open {
      transform: translateX(0);
    }
    .chat-list-sidebar-header {
      padding: 1rem 1.5rem 0.5rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border-color);
      background: var(--panel-bg-color);
    }
    .chat-list-sidebar-header h2 {
      font-size: 1.1rem;
      font-weight: 600;
      margin: 0;
      color: var(--primary-color);
    }
    .chat-list-sidebar-close {
      background: none;
      border: none;
      color: var(--text-color);
      font-size: 1.7rem;
      cursor: pointer;
      padding: 0 0.5rem;
    }
    .chat-list-sidebar-list {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem 1rem 1rem 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    .chat-list-item {
      padding: 0.5rem 0.75rem;
      border-radius: 6px;
      cursor: pointer;
      color: var(--text-color);
      background: none;
      border: none;
      text-align: right;
      font-family: inherit;
      font-size: 1rem;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .chat-list-item.active {
      background: var(--primary-color);
      color: #fff;
      font-weight: bold;
    }
    .chat-list-item:hover:not(.active) {
      background: #333;
    }
    .chat-list-item .chat-icon {
      width: 18px;
      height: 18px;
      color: var(--primary-color);
      flex-shrink: 0;
    }
    .chat-list-new-btn {
      margin: 1rem 1rem 0.5rem 1rem;
      background: var(--primary-color);
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 0.5rem 1.5rem;
      font-size: 1rem;
      font-family: inherit;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .chat-list-new-btn:hover {
      background: var(--primary-hover-color);
    }
    @media (max-width: 500px) {
      .chat-list-sidebar { width: 100vw; }
    }
  </style>
<link rel="stylesheet" href="/index.css">
</head>
<body>
  <div class="app-container">
    <div class="chat-panel">
      <header class="panel-header">
        <div style="flex:1;"></div>
        <h1 style="text-align:center; margin:0;">ŸÖÿ≥ÿßÿπÿØ ÿßŸÑŸÉŸàÿØ ÿßŸÑÿ∞ŸÉŸä</h1>
        <div style="flex:1; display:flex; justify-content:flex-end;">
          <button id="chat-list-toggle-btn" class="header-icon-btn" title="ÿπÿ±ÿ∂ ÿßŸÑÿØÿ±ÿØÿ¥ÿßÿ™">
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
          </button>
        </div>

      </header>
      <div id="chat-list-overlay" class="chat-list-overlay"></div>
      <aside id="chat-list-sidebar" class="chat-list-sidebar">
        <div class="chat-list-sidebar-header">
          <h2>ÿßŸÑÿØÿ±ÿØÿ¥ÿßÿ™</h2>
          <button id="chat-list-sidebar-close" class="chat-list-sidebar-close" title="ÿ•ÿ∫ŸÑÿßŸÇ">&times;</button>
        </div>

        <button id="chat-list-new-btn" class="chat-list-new-btn" style="margin:1rem 1rem 0.5rem 1rem; background:var(--primary-color); color:#fff; border:none; border-radius:6px; padding:0.5rem 1.5rem; font-size:1rem; font-family:inherit; font-weight:500; cursor:pointer; transition:background 0.2s; display:flex; align-items:center; gap:0.5rem;">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
          ÿØÿ±ÿØÿ¥ÿ© ÿ¨ÿØŸäÿØÿ©
        </button>
        <div id="chat-list-sidebar-list" class="chat-list-sidebar-list"></div>
        <button id="delete-chats-btn" style="background:#f87171; color:#fff; border:none; border-radius:6px; padding:0.5rem 1.5rem; font-size:1rem; font-family:inherit; font-weight:500; cursor:pointer; margin:1rem;">ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑÿØÿ±ÿØÿ¥ÿßÿ™</button>
      </aside>

      <div class="task-progress" id="task-progress-container" style="display: none;">
        <header class="task-header" id="task-header">
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="check-icon"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                <span id="task-title">ÿÆÿ∑ÿ© ÿßŸÑÿπŸÖŸÑ</span>
            </div>
            <div class="task-meta">
                <span id="task-counter"></span>
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="chevron-icon"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </div>
        </header>
        <div class="task-list" id="task-list"></div>
      </div>

      <div class="messages-container" id="messages-container"></div>
            <form id="chat-form">
        <div class="input-bar">
          <button type="button" id="tools-btn" class="tools-button" title="ÿßŸÑÿ£ÿØŸàÿßÿ™">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="3"></circle>
              <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
          </button>
          
          <div class="input-wrapper">
            <div id="active-tool-indicator" class="active-tool-indicator" style="display: none;">
              <span id="tool-indicator-text">ÿßŸÑŸàÿ∂ÿπ ÿßŸÑÿπÿßÿØŸä</span>
              <button type="button" id="clear-tool" class="clear-tool-btn">&times;</button>
            </div>
            <input type="text" id="prompt-input" placeholder="ÿßÿ≥ÿ£ŸÑ ÿπŸÜ ÿ£Ÿä ÿ¥Ÿäÿ°..." />
          </div>
          
          <button type="submit" id="send-button">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="12" y1="19" x2="12" y2="5"></line>
              <polyline points="5 12 12 5 19 12"></polyline>
            </svg>
          </button>
        </div>
        
        <!-- Compact Tools Menu -->
        <div id="tools-menu" class="tools-menu" style="display: none;">
          <div class="tool-item" data-mode="self-development">
            <span class="tool-emoji">üöÄ</span>
            <span class="tool-text">ÿ™ÿ∑ŸàŸäÿ± ÿ∞ÿßÿ™Ÿä</span>
          </div>
          <div class="tool-item" data-mode="deep-thinking">
            <span class="tool-emoji">üß†</span>
            <span class="tool-text">ÿ™ŸÅŸÉŸäÿ± ÿπŸÖŸäŸÇ</span>
          </div>
          <div class="tool-item" data-mode="code-research">
            <span class="tool-emoji">üîç</span>
            <span class="tool-text">ÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑŸÉŸàÿØ</span>
          </div>
          <div class="tool-item" data-mode="bug-hunter">
            <span class="tool-emoji">üêõ</span>
            <span class="tool-text">ŸÖÿ∑ÿßÿ±ÿØ ÿßŸÑÿ£ÿÆÿ∑ÿßÿ°</span>
          </div>
          <div class="tool-item" data-mode="performance-optimizer">
            <span class="tool-emoji">‚ö°</span>
            <span class="tool-text">ŸÖÿ≠ÿ≥ŸÜ ÿßŸÑÿ£ÿØÿßÿ°</span>
          </div>
          <div class="tool-item" data-mode="creative-mode">
            <span class="tool-emoji">üé®</span>
            <span class="tool-text">Ÿàÿ∂ÿπ ÿ•ÿ®ÿØÿßÿπŸä</span>
          </div>
          <div class="tool-divider"></div>
          <div class="tool-item" data-mode="normal">
            <span class="tool-emoji">üîÑ</span>
            <span class="tool-text">Ÿàÿ∂ÿπ ÿπÿßÿØŸä</span>
          </div>
        </div>
      </form>
    </div>

    <div class="editor-panel">
      <header class="editor-header">
        <div class="editor-toolbar">
           <button id="undo-btn" title="ÿ±ÿ¨Ÿàÿπ">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 9H8a5 5 0 0 0-5 5v0a5 5 0 0 0 5 5h10"></path><polyline points="12 13 8 9 12 5"></polyline></svg>

            </button>
            <button id="redo-btn" title="ÿ™ŸÇÿØŸÖ">

                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9h13a5 5 0 0 1 5 5v0a5 5 0 0 1-5 5H5"></path><polyline points="12 5 16 9 12 13"></polyline></svg>
            </button>
             <div style="width:1px; height: 24px; background-color: var(--border-color); margin: 0 0.5rem;"></div>
          <button id="preview-btn" title="ŸÖÿπÿßŸäŸÜÿ©">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z"></path><circle cx="12" cy="12" r="3"></circle></svg>
          </button>
          <button id="improve-btn" title="ÿ™ÿ∑ŸàŸäÿ±">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3v2m6.364 1.636l-1.414 1.414M21 12h-2M17.364 17.364l-1.414-1.414M12 21v-2M6.636 17.364l1.414-1.414M3 12h2M6.636 6.636l1.414 1.414M12 8a4 4 0 1 1 0 8 4 4 0 0 1 0-8z"></path></svg>
          </button>
          <button id="self-improve-btn" title="ÿ™ÿ∑ŸàŸäÿ± ÿ∞ÿßÿ™Ÿä">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
          </button>
          <button id="apply-btn" title="ÿ™ÿ∑ÿ®ŸäŸÇ Ÿàÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
          </button>
        </div>
        <h2>ŸÖÿ≠ÿ±ÿ± ÿßŸÑŸÉŸàÿØ</h2>
      </header>
      <div class="editor-content">
        <div id="line-numbers" class="line-numbers-gutter"></div>
        <pre id="code-display" class="language-html" contenteditable="true" tabindex="0"></pre>
      </div>
    </div>
  </div>

  <div id="preview-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <button id="close-preview-btn">&times;</button>
      </div>
      <iframe id="preview-frame" title="Live Preview"></iframe>
    </div>
  </div>

  <!-- Modal for AI Discussion -->
  <div id="ai-discussion-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 800px; max-height: 90vh;">
      <div class="modal-header">
        <button id="close-discussion-btn">&times;</button>
      </div>
      <div id="ai-discussion-content" style="flex:1; overflow-y:auto; padding:1rem; direction:ltr; background:var(--bg-color); color:var(--text-color); font-family:var(--font-mono); font-size:15px; border-radius:8px; min-height:200px;"></div>
      <div id="ai-discussion-actions" style="padding:1rem; text-align:left;">
        <button id="stop-discussion-btn" style="background:var(--error-color); color:white; border:none; border-radius:6px; padding:0.5rem 1.5rem; font-size:1rem; cursor:pointer; margin-left:0.5rem;">ÿ•ŸäŸÇÿßŸÅ ÿßŸÑÿ¨ŸàŸÑÿßÿ™</button>
        <button id="apply-improved-btn" style="display:none; background:var(--primary-color); color:white; border:none; border-radius:6px; padding:0.5rem 1.5rem; font-size:1rem; cursor:pointer;">ÿßÿπÿ™ŸÖÿßÿØ ÿßŸÑŸÉŸàÿØ ÿßŸÑŸÖÿ≠ÿ≥ŸÜ</button>
      </div>
    </div>
  </div>

  <script type="importmap">
    {
      "imports": {
        "@google/genai": "https://esm.sh/@google/genai@^0.12.0"
      }
    }
  </script>
  <script type="module">
    import { GoogleGenAI, Type } from "@google/genai";

    // --- API KEYS ROTATION LOGIC ---
    const API_KEYS = [
      "AIzaSyBd6z7ru09s2hbI7c-9PrF34gjR9r4o5iE",
      "AIzaSyCYlSM0arXvt1GMnsUMIPrTF4T3U-jsxKI",
      "AIzaSyBA5fBhhxIRuJxG9kNPu1JQ8wLMce9p_bg",
      "AIzaSyCJhj0oJaRQeKudyDyvtSf-fz-xbpL-Mm8",
      "AIzaSyBQOFjawlE69tA4Nuuq_hpyX2KPMsXzXDw",
      "AIzaSyBJvsgVcIoJHPkoO8Ru1-maazHlS_efXUI"
    ];
    let apiKeyIndex = 0;
    function getNextApiKey() {
      const key = API_KEYS[apiKeyIndex];
      apiKeyIndex = (apiKeyIndex + 1) % API_KEYS.length;
      return key;
    }
    // ÿØÿßŸÑÿ© ÿ™ÿ∫ŸÑŸÅ ÿßÿ≥ÿ™ÿØÿπÿßÿ° GoogleGenAI Ÿàÿ™ÿπŸäÿØ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ÿπŸÜÿØ ÿ∏ŸáŸàÿ± ÿÆÿ∑ÿ£ quota
    async function callGenAI(fn) {
      let lastError;
      for (let i = 0; i < API_KEYS.length; i++) {
        const ai = new GoogleGenAI({ apiKey: getNextApiKey() });
        try {
          return await fn(ai);
        } catch (err) {
          lastError = err;
          if (err && err.message && /quota|exceeded|API key/i.test(err.message)) {
            continue; // ÿ¨ÿ±ÿ® ÿßŸÑŸÖŸÅÿ™ÿßÿ≠ ÿßŸÑÿ™ÿßŸÑŸä
          } else {
            throw err;
          }
        }
      }
      throw lastError || new Error("All API keys quota exceeded or failed.");
    }

    const API_KEY = "AIzaSyCYlSM0arXvt1GMnsUMIPrTF4T3U-jsxKI";
    if (!API_KEY) {
        document.body.innerHTML = `<div style="color:red; padding: 2rem; text-align: right; font-size: 1.2rem;">ÿÆÿ∑ÿ£: ŸÖÿ™ÿ∫Ÿäÿ± ÿßŸÑÿ®Ÿäÿ¶ÿ© API_KEY ÿ∫Ÿäÿ± ŸÖÿπŸäŸÜ. ŸÑÿß ŸäŸÖŸÉŸÜ ÿ®ÿØÿ° ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ.</div>`;
        throw new Error("API key not found");
    }
    const ai = new GoogleGenAI({ apiKey: API_KEY });

    // DOM Elements
    const codeDisplay = document.getElementById('code-display');
    const lineNumbersGutter = document.getElementById('line-numbers');
    const messagesContainer = document.getElementById('messages-container');
    const chatForm = document.getElementById('chat-form');
    const promptInput = document.getElementById('prompt-input');
    const sendButton = document.getElementById('send-button');
    const toolsBtn = document.getElementById('tools-btn');
    const toolsMenu = document.getElementById('tools-menu');
    const activeToolIndicator = document.getElementById('active-tool-indicator');
    const toolIndicatorText = document.getElementById('tool-indicator-text');
    const clearToolBtn = document.getElementById('clear-tool');
    const previewBtn = document.getElementById('preview-btn');
    const improveBtn = document.getElementById('improve-btn');
    const selfImproveBtn = document.getElementById('self-improve-btn');
    const applyBtn = document.getElementById('apply-btn');
    const previewModal = document.getElementById('preview-modal');
    const closePreviewBtn = document.getElementById('close-preview-btn');
    const previewFrame = document.getElementById('preview-frame');

    const taskProgressContainer = document.getElementById('task-progress-container');
    const taskHeader = document.getElementById('task-header');
    const taskList = document.getElementById('task-list');
    const taskCounter = document.getElementById('task-counter');
    const undoBtn = document.getElementById('undo-btn');
    const redoBtn = document.getElementById('redo-btn');
    // AI Discussion Modal Elements
    const aiDiscussionModal = document.getElementById('ai-discussion-modal');
    const closeDiscussionBtn = document.getElementById('close-discussion-btn');
    const aiDiscussionContent = document.getElementById('ai-discussion-content');
    const applyImprovedBtn = document.getElementById('apply-improved-btn');
    const stopDiscussionBtn = document.getElementById('stop-discussion-btn');
    const chatListSidebar = document.getElementById('chat-list-sidebar');
    const chatListSidebarList = document.getElementById('chat-list-sidebar-list');
    const chatListSidebarClose = document.getElementById('chat-list-sidebar-close');

    const chatListToggleBtn = document.getElementById('chat-list-toggle-btn');
    const chatListOverlay = document.getElementById('chat-list-overlay'); // ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© Ÿáÿ∞ÿß ÿßŸÑÿ≥ÿ∑ÿ±
    const chatListNewBtn = document.getElementById('chat-list-new-btn');
    const deleteChatsBtn = document.getElementById('delete-chats-btn');

    // App State
    let sessions = {};
    let currentSessionId = null;
    const initialCode = ''; // Start with a blank slate
    let currentMode = 'normal'; // ŸÜŸÖÿ∑ ÿßŸÑÿπŸÖŸÑ ÿßŸÑÿ≠ÿßŸÑŸä
    let isProcessing = false; // ŸÑŸÖŸÜÿπ ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑŸÖÿ™ÿØÿßÿÆŸÑÿ©
    let errorRetryCount = 0; // ÿπÿØÿßÿØ ÿ•ÿπÿßÿØÿ© ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ÿπŸÜÿØ ÿßŸÑÿ£ÿÆÿ∑ÿßÿ°
    const maxRetries = 3; // ÿ£ŸÇÿµŸâ ÿπÿØÿØ ŸÖÿ≠ÿßŸàŸÑÿßÿ™
    
    // ŸÜÿ∏ÿßŸÖ ÿßŸÑŸàŸÉŸäŸÑ ÿßŸÑÿ∞ŸÉŸä ÿßŸÑŸÖÿ™ŸÇÿØŸÖ
    class SmartAgent {
      constructor() {
        this.memory = [];
        this.context = '';
        this.currentTask = null;
        this.errorHistory = [];
        this.learningData = [];
      }
      
      // ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÖÿ¥ŸÉŸÑÿ© ŸàŸÅŸáŸÖ ÿßŸÑÿ≥ŸäÿßŸÇ
      async analyzeContext(userInput, currentCode) {
        const analysisPrompt = `ÿ£ŸÜÿ™ ŸàŸÉŸäŸÑ ÿ∞ŸÉŸä ŸÖÿ™ŸÇÿØŸÖ. ÿ≠ŸÑŸÑ ÿ∑ŸÑÿ® ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸàÿßŸÑŸÉŸàÿØ ÿßŸÑÿ≠ÿßŸÑŸä Ÿàÿßÿ≥ÿ™ÿÆÿ±ÿ¨ ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ™ÿßŸÑŸäÿ©:
        
ÿ∑ŸÑÿ® ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: ${userInput}
ÿßŸÑŸÉŸàÿØ ÿßŸÑÿ≠ÿßŸÑŸä: ${currentCode || 'ŸÅÿßÿ±ÿ∫'}
ÿßŸÑÿ≥ŸäÿßŸÇ ÿßŸÑÿ≥ÿßÿ®ŸÇ: ${this.context}

Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ÿ≠ÿØÿØ:
1. ŸÜŸàÿπ ÿßŸÑŸÖŸáŸÖÿ© (ÿ•ŸÜÿ¥ÿßÿ°ÿå ÿ™ÿπÿØŸäŸÑÿå ÿ•ÿµŸÑÿßÿ≠ÿå ÿ™ÿ≠ÿ≥ŸäŸÜ)
2. ŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑÿ™ÿπŸÇŸäÿØ (ÿ®ÿ≥Ÿäÿ∑ÿå ŸÖÿ™Ÿàÿ≥ÿ∑ÿå ŸÖÿπŸÇÿØ)
3. ÿßŸÑÿ™ŸÇŸÜŸäÿßÿ™ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©
4. ÿßŸÑŸÖÿÆÿßÿ∑ÿ± ÿßŸÑŸÖÿ≠ÿ™ŸÖŸÑÿ©
5. ÿßÿ≥ÿ™ÿ±ÿßÿ™Ÿäÿ¨Ÿäÿ© ÿßŸÑÿ™ŸÜŸÅŸäÿ∞`;

        try {
          const analysis = await callGenAI(ai => ai.models.generateContent({
            model: 'gemini-2.5-flash',
            contents: analysisPrompt,
            config: {
              responseMimeType: "application/json",
              responseSchema: {
                type: Type.OBJECT,
                properties: {
                  task_type: { type: Type.STRING },
                  complexity: { type: Type.STRING },
                  technologies: { type: Type.ARRAY, items: { type: Type.STRING } },
                  risks: { type: Type.ARRAY, items: { type: Type.STRING } },
                  strategy: { type: Type.STRING }
                }
              }
            }
          }));
          return JSON.parse(analysis.text);
        } catch (error) {
          return this.handleError(error, 'ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ≥ŸäÿßŸÇ');
        }
      }
      
      // ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ£ÿÆÿ∑ÿßÿ° ŸàÿßŸÑÿ™ÿπÿßŸÅŸä ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä
      handleError(error, operation) {
        this.errorHistory.push({ error: error.message, operation, timestamp: Date.now() });
        errorRetryCount++;
        
        if (errorRetryCount <= maxRetries) {
          console.log(`ŸÖÿ≠ÿßŸàŸÑÿ© ÿ•ÿπÿßÿØÿ© ÿ™ŸÜŸÅŸäÿ∞ ${operation} - ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ${errorRetryCount}`);
          return { error: true, retry: true, message: error.message };
        } else {
          console.log(`ŸÅÿ¥ŸÑ ŸÜŸáÿßÿ¶ŸäÿßŸã ŸÅŸä ${operation} ÿ®ÿπÿØ ${maxRetries} ŸÖÿ≠ÿßŸàŸÑÿßÿ™`);
          errorRetryCount = 0;
          return { error: true, retry: false, message: error.message };
        }
      }
      
      // ÿ™ÿπŸÑŸÖ ŸÖŸÜ ÿßŸÑÿ™ŸÅÿßÿπŸÑÿßÿ™ ÿßŸÑÿ≥ÿßÿ®ŸÇÿ©
      learnFromInteraction(input, output, success) {
        this.learningData.push({
          input,
          output,
          success,
          timestamp: Date.now(),
          mode: currentMode
        });
        
        // ÿßŸÑÿßÿ≠ÿ™ŸÅÿßÿ∏ ÿ®ÿ¢ÿÆÿ± 50 ÿ™ŸÅÿßÿπŸÑ ŸÅŸÇÿ∑
        if (this.learningData.length > 50) {
          this.learningData = this.learningData.slice(-50);
        }
      }
      
      // ÿ™ÿ≠ÿ≥ŸäŸÜ ÿßŸÑÿ£ÿØÿßÿ° ÿ®ŸÜÿßÿ° ÿπŸÑŸâ ÿßŸÑÿ™ÿπŸÑŸÖ
      getOptimizedStrategy(taskType) {
        const successfulInteractions = this.learningData.filter(
          data => data.success && data.input.includes(taskType)
        );
        
        if (successfulInteractions.length > 0) {
          const lastSuccessful = successfulInteractions[successfulInteractions.length - 1];
          return lastSuccessful.output;
        }
        
        return null;
      }
    }
    
    const smartAgent = new SmartAgent();

    function saveState() {
        localStorage.setItem('ai-code-editor-sessions', JSON.stringify(sessions));
        localStorage.setItem('ai-code-editor-last-session', currentSessionId);
    }

    function loadState() {
        const savedSessions = localStorage.getItem('ai-code-editor-sessions');
        const lastSessionId = localStorage.getItem('ai-code-editor-last-session');
        
        if (savedSessions) {
            sessions = JSON.parse(savedSessions);
            if (lastSessionId && sessions[lastSessionId]) {
                currentSessionId = lastSessionId;
            } else {
                const sessionIds = Object.keys(sessions);
                currentSessionId = sessionIds.length > 0 ? sessionIds[sessionIds.length - 1] : null;
            }
        }

        if (!currentSessionId) {
            startNewChat();
        } else {
            renderCurrentSession();
            renderChatList();
        }
    }
    
    function startNewChat() {
        console.log('ÿ•ŸÜÿ¥ÿßÿ° ÿØÿ±ÿØÿ¥ÿ© ÿ¨ÿØŸäÿØÿ©...');
        const newId = Date.now().toString();
        sessions[newId] = {
            id: newId,
            messages: [{
                sender: 'ai',
                text: 'ÿ£ŸáŸÑÿßŸã ÿ®ŸÉ! ÿ£ŸÜÿß ŸÖÿ≥ÿßÿπÿØŸÉ ÿßŸÑÿ®ÿ±ŸÖÿ¨Ÿä. ÿµŸÅ ŸÑŸä ÿßŸÑŸÉŸàÿØ ÿßŸÑÿ∞Ÿä ÿ™ÿ±ŸäÿØ ŸÉÿ™ÿßÿ®ÿ™Ÿáÿå Ÿàÿ≥ÿ£ÿ®ÿØÿ£ ŸÅŸàÿ±ÿßŸã.'
            }],
            codeHistory: [initialCode],
            historyIndex: 0
        };
        currentSessionId = newId;
        renderCurrentSession();
        renderChatList();
        saveState();
        console.log('ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿØÿ±ÿØÿ¥ÿ© ÿ¨ÿØŸäÿØÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
    }
    
    function updateCodeAndView(code, highlightLines = []) {
        codeDisplay.textContent = code;
        hljs.highlightElement(codeDisplay);
        
        const lineCount = code.split('\n').length;
        lineNumbersGutter.innerHTML = Array.from({length: lineCount}, (_, i) => i + 1).join('<br>');

        // Highlight modified lines
        if (highlightLines.length > 0) {
          // Wait for DOM update
          setTimeout(() => {
            const codeHtml = codeDisplay.innerHTML.split('\n');
            for (const lineNum of highlightLines) {
              if (codeHtml[lineNum - 1] !== undefined) {
                codeHtml[lineNum - 1] = `<span class="highlight-modified">${codeHtml[lineNum - 1]}</span>`;
              }
            }
            codeDisplay.innerHTML = codeHtml.join('\n');
            // Remove highlight after 1.5s
            setTimeout(() => {
              codeDisplay.innerHTML = codeDisplay.innerHTML.replace(/<span class="highlight-modified">(.*?)<\/span>/g, '$1');
            }, 1500);
          }, 0);
        }
    }

    function renderCurrentSession() {
        if (!currentSessionId || !sessions[currentSessionId]) return;
        const session = sessions[currentSessionId];

        messagesContainer.innerHTML = '';
        session.messages.forEach(message => {
            _createMessageElement(message.text, message.sender);
        });
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        const currentCode = session.codeHistory[session.historyIndex];
        updateCodeAndView(currentCode);
        updateUndoRedoButtons();
        
        taskProgressContainer.style.display = 'none';
        renderChatList();
    }

    function _createMessageElement(text, sender, isLoading = false) {
      const messageEl = document.createElement('div');
      messageEl.classList.add('message', sender);
      
      if (isLoading) {
        messageEl.classList.add('loading');
        messageEl.innerHTML = `<div class="spinner"></div><span>${text}</span>`;
      } else if (sender === 'ai' && text.startsWith('ÿßŸÑŸÉŸàÿØ ÿ®ÿπÿØ ÿ™ŸÜŸÅŸäÿ∞ ÿßŸÑÿÆÿ∑Ÿàÿ©:')) {
        // ÿπÿ±ÿ∂ ÿßŸÑŸÉŸàÿØ ŸÅŸä ÿ™ÿµŸÖŸäŸÖ ÿ£ŸÜŸäŸÇ ŸàŸÖÿ≠ÿ≥ŸÜ
        const code = text.replace(/^ÿßŸÑŸÉŸàÿØ ÿ®ÿπÿØ ÿ™ŸÜŸÅŸäÿ∞ ÿßŸÑÿÆÿ∑Ÿàÿ©:\s*/,'');
        const stepNumber = (sessions[currentSessionId]?.messages.filter(m => m.text.startsWith('ÿßŸÑŸÉŸàÿØ ÿ®ÿπÿØ ÿ™ŸÜŸÅŸäÿ∞ ÿßŸÑÿÆÿ∑Ÿàÿ©:')).length || 0) + 1;
        
        messageEl.innerHTML = `
          <div class="step-result-container">
            <div class="step-result-header">
              <div class="step-result-icon">‚úÖ</div>
              <div>
                <div class="step-result-title">ÿ™ŸÖ ÿ™ŸÜŸÅŸäÿ∞ ÿßŸÑÿÆÿ∑Ÿàÿ© ${stepNumber} ÿ®ŸÜÿ¨ÿßÿ≠</div>
                <div class="step-result-description">ÿ™ŸÖ ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ÿßÿ™ ÿπŸÑŸâ ÿßŸÑŸÉŸàÿØ</div>
              </div>
            </div>
            
            <div class="code-preview-actions">
              <button class="code-action-btn primary" onclick="copyCodeToClipboard(this)" data-code="${encodeURIComponent(code)}">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                  <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
                ŸÜÿ≥ÿÆ ÿßŸÑŸÉŸàÿØ
              </button>
              <button class="code-action-btn" onclick="toggleCodeVisibility(this)">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z"></path>
                  <circle cx="12" cy="12" r="3"></circle>
                </svg>
                <span>ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸÉŸàÿØ</span>
              </button>
                             <button class="code-action-btn" onclick="formatCodeDisplay(this)">
                 <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                   <polyline points="16 18 22 12 16 6"></polyline>
                   <polyline points="8 6 2 12 8 18"></polyline>
                 </svg>
                 ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑŸÉŸàÿØ
               </button>
               <button class="code-action-btn" onclick="showDiffForStep(this)" data-step="${stepNumber}">
                 <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                   <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                   <polyline points="14 2 14 8 20 8"></polyline>
                   <line x1="16" y1="13" x2="8" y2="13"></line>
                   <line x1="16" y1="17" x2="8" y2="17"></line>
                   <polyline points="10 9 9 9 8 9"></polyline>
                 </svg>
                 ÿπÿ±ÿ∂ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™
               </button>
            </div>
            
                         <div class="code-container">
               <div class="code-stats">
                 <span class="lines-count">${code.split('\n').length} ÿ≥ÿ∑ÿ±</span>
                 <span class="chars-count">${code.length} ÿ≠ÿ±ŸÅ</span>
               </div>
               <pre class="ai-step-code" id="step-code-${Date.now()}"><code>${escapeHtml(code)}</code></pre>
             </div>
          </div>
        `;
      } else if (sender === 'ai' && sessions[currentSessionId] && sessions[currentSessionId].messages[sessions[currentSessionId].messages.length-1]?.text === text) {
        // Typewriter effect ONLY for the latest AI message
        let i = 0;
        messageEl.textContent = '';
        function typeWriter() {
          if (i < text.length) {
            messageEl.textContent += text.charAt(i);
            i++;
            setTimeout(typeWriter, 12 + Math.random() * 30);
          }
        }
        typeWriter();
      } else {
        messageEl.textContent = text;
      }
      
      messagesContainer.appendChild(messageEl);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
      return messageEl;
    }
    
    // ÿØÿßŸÑÿ© ŸÖÿ≥ÿßÿπÿØÿ© ŸÑÿ™ÿ¥ŸÅŸäÿ± HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // ÿØÿßŸÑÿ© ÿ•ŸÜÿ¥ÿßÿ° ÿπÿ±ÿ∂ ÿßŸÑÿßÿÆÿ™ŸÑÿßŸÅÿßÿ™ (Diff View)
    function createDiffView(oldCode, newCode, stepNumber) {
      const oldLines = oldCode.split('\n');
      const newLines = newCode.split('\n');
      
      // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿßÿÆÿ™ŸÑÿßŸÅÿßÿ™ ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿÆŸàÿßÿ±ÿ≤ŸÖŸäÿ© ÿ®ÿ≥Ÿäÿ∑ÿ©
      const diff = calculateDiff(oldLines, newLines);
      
      let addedCount = 0;
      let removedCount = 0;
      
      // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™
      diff.forEach(line => {
        if (line.type === 'added') addedCount++;
        if (line.type === 'removed') removedCount++;
      });
      
      const diffId = `diff-${stepNumber}-${Date.now()}`;
      
      return `
        <div class="diff-container">
          <div class="diff-header">
            <div class="diff-stats">
              <span>ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ŸÅŸä ÿßŸÑÿÆÿ∑Ÿàÿ© ${stepNumber}</span>
              <div class="diff-stat additions">+${addedCount}</div>
              <div class="diff-stat deletions">-${removedCount}</div>
            </div>
            <button class="diff-toggle" onclick="toggleDiffView('${diffId}')">
              ÿ•ÿÆŸÅÿßÿ° ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ
            </button>
          </div>
          <div class="diff-content" id="${diffId}">
            ${diff.map((line, index) => createDiffLine(line, index)).join('')}
          </div>
        </div>
      `;
    }
    
    // ÿØÿßŸÑÿ© ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿßÿÆÿ™ŸÑÿßŸÅÿßÿ™ ÿßŸÑÿ®ÿ≥Ÿäÿ∑ÿ©
    function calculateDiff(oldLines, newLines) {
      const diff = [];
      let oldIndex = 0;
      let newIndex = 0;
      
      while (oldIndex < oldLines.length || newIndex < newLines.length) {
        const oldLine = oldLines[oldIndex];
        const newLine = newLines[newIndex];
        
        if (oldIndex >= oldLines.length) {
          // ÿ£ÿ≥ÿ∑ÿ± ÿ¨ÿØŸäÿØÿ© ŸÖÿ™ÿ®ŸÇŸäÿ©
          diff.push({
            type: 'added',
            content: newLine,
            lineNumber: newIndex + 1,
            indicator: '+'
          });
          newIndex++;
        } else if (newIndex >= newLines.length) {
          // ÿ£ÿ≥ÿ∑ÿ± ŸÖÿ≠ÿ∞ŸàŸÅÿ© ŸÖÿ™ÿ®ŸÇŸäÿ©
          diff.push({
            type: 'removed',
            content: oldLine,
            lineNumber: oldIndex + 1,
            indicator: '-'
          });
          oldIndex++;
        } else if (oldLine === newLine) {
          // ÿ£ÿ≥ÿ∑ÿ± ŸÖÿ™ÿ∑ÿßÿ®ŸÇÿ© (ÿ≥ŸäÿßŸÇ)
          diff.push({
            type: 'context',
            content: oldLine,
            lineNumber: newIndex + 1,
            indicator: ' '
          });
          oldIndex++;
          newIndex++;
        } else {
          // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿ™ÿ∑ÿßÿ®ŸÇ ŸÅŸä ÿßŸÑÿ£ÿ≥ÿ∑ÿ± ÿßŸÑŸÇÿßÿØŸÖÿ©
          let foundMatch = false;
          
          // ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑÿ£ÿ≥ÿ∑ÿ± ÿßŸÑÿ¨ÿØŸäÿØÿ©
          for (let i = newIndex + 1; i < Math.min(newIndex + 5, newLines.length); i++) {
            if (oldLine === newLines[i]) {
              // Ÿàÿ¨ÿØŸÜÿß ÿ™ÿ∑ÿßÿ®ŸÇÿå ÿßŸÑÿ£ÿ≥ÿ∑ÿ± ŸÇÿ®ŸÑŸá ÿ¨ÿØŸäÿØÿ©
              for (let j = newIndex; j < i; j++) {
                diff.push({
                  type: 'added',
                  content: newLines[j],
                  lineNumber: j + 1,
                  indicator: '+'
                });
              }
              newIndex = i;
              foundMatch = true;
              break;
            }
          }
          
          if (!foundMatch) {
            // ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑÿ£ÿ≥ÿ∑ÿ± ÿßŸÑŸÇÿØŸäŸÖÿ©
            for (let i = oldIndex + 1; i < Math.min(oldIndex + 5, oldLines.length); i++) {
              if (newLine === oldLines[i]) {
                // Ÿàÿ¨ÿØŸÜÿß ÿ™ÿ∑ÿßÿ®ŸÇÿå ÿßŸÑÿ£ÿ≥ÿ∑ÿ± ŸÇÿ®ŸÑŸá ŸÖÿ≠ÿ∞ŸàŸÅÿ©
                for (let j = oldIndex; j < i; j++) {
                  diff.push({
                    type: 'removed',
                    content: oldLines[j],
                    lineNumber: j + 1,
                    indicator: '-'
                  });
                }
                oldIndex = i;
                foundMatch = true;
                break;
              }
            }
          }
          
          if (!foundMatch) {
            // ŸÑÿß ŸäŸàÿ¨ÿØ ÿ™ÿ∑ÿßÿ®ŸÇÿå ÿßÿπÿ™ÿ®ÿ± ÿßŸÑÿ≥ÿ∑ÿ± ÿßŸÑŸÇÿØŸäŸÖ ŸÖÿ≠ÿ∞ŸàŸÅ ŸàÿßŸÑÿ¨ÿØŸäÿØ ŸÖÿ∂ÿßŸÅ
            diff.push({
              type: 'removed',
              content: oldLine,
              lineNumber: oldIndex + 1,
              indicator: '-'
            });
            diff.push({
              type: 'added',
              content: newLine,
              lineNumber: newIndex + 1,
              indicator: '+'
            });
            oldIndex++;
            newIndex++;
          }
        }
      }
      
      return diff;
    }
    
    // ÿØÿßŸÑÿ© ÿ•ŸÜÿ¥ÿßÿ° ÿ≥ÿ∑ÿ± ŸÅŸä ÿπÿ±ÿ∂ ÿßŸÑÿßÿÆÿ™ŸÑÿßŸÅÿßÿ™
    function createDiffLine(line, index) {
      return `
        <div class="diff-line ${line.type}">
          <div class="diff-line-indicator"></div>
          <div class="line-number">${line.lineNumber}</div>
          <div class="line-content">${escapeHtml(line.content)}</div>
        </div>
      `;
    }
    
    // ÿØÿßŸÑÿ© ÿ™ÿ®ÿØŸäŸÑ ÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ
    function toggleDiffView(diffId) {
      const diffContent = document.getElementById(diffId);
      const button = diffContent.previousElementSibling.querySelector('.diff-toggle');
      
      if (diffContent.style.display === 'none') {
        diffContent.style.display = 'block';
        button.textContent = 'ÿ•ÿÆŸÅÿßÿ° ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ';
      } else {
        diffContent.style.display = 'none';
        button.textContent = 'ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ';
      }
    }
    
    // ÿØŸàÿßŸÑ ÿ™ŸÅÿßÿπŸÑŸäÿ© ŸÑÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑŸÉŸàÿØ
    function copyCodeToClipboard(button) {
      const code = decodeURIComponent(button.dataset.code);
      navigator.clipboard.writeText(code).then(() => {
        const originalText = button.innerHTML;
        button.innerHTML = `
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
          ÿ™ŸÖ ÿßŸÑŸÜÿ≥ÿÆ!
        `;
        button.style.background = 'var(--success-color)';
        
        setTimeout(() => {
          button.innerHTML = originalText;
          button.style.background = '';
        }, 2000);
      }).catch(err => {
        console.error('ŸÅÿ¥ŸÑ ŸÅŸä ŸÜÿ≥ÿÆ ÿßŸÑŸÉŸàÿØ:', err);
        button.innerHTML = `
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
          ŸÅÿ¥ŸÑ ÿßŸÑŸÜÿ≥ÿÆ
        `;
      });
    }
    
    function toggleCodeVisibility(button) {
      const container = button.closest('.step-result-container');
      const codeElement = container.querySelector('.ai-step-code');
      const span = button.querySelector('span');
      
      if (codeElement.style.display === 'none') {
        codeElement.style.display = 'block';
        span.textContent = 'ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸÉŸàÿØ';
        button.querySelector('svg').innerHTML = `
          <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z"></path>
          <circle cx="12" cy="12" r="3"></circle>
        `;
      } else {
        codeElement.style.display = 'none';
        span.textContent = 'ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑŸÉŸàÿØ';
        button.querySelector('svg').innerHTML = `
          <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
          <line x1="1" y1="1" x2="23" y2="23"></line>
        `;
      }
    }
    
    function formatCodeDisplay(button) {
      const container = button.closest('.step-result-container');
      const codeElement = container.querySelector('.ai-step-code code');
      
      if (codeElement) {
        // ÿ•ÿπÿßÿØÿ© ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑŸÉŸàÿØ ÿ®ŸÄ highlight.js
        hljs.highlightElement(codeElement);
        
        // ÿ™ÿ£ÿ´Ÿäÿ± ÿ®ÿµÿ±Ÿä ŸÑŸÑÿ•ÿ¥ÿßÿ±ÿ© ÿ•ŸÑŸâ ÿ£ŸÜ ÿßŸÑÿ™ŸÜÿ≥ŸäŸÇ ÿ™ŸÖ
        button.style.background = 'var(--success-color)';
        button.innerHTML = `
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
          ÿ™ŸÖ ÿßŸÑÿ™ŸÜÿ≥ŸäŸÇ!
        `;
        
        setTimeout(() => {
          button.style.background = '';
          button.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="16 18 22 12 16 6"></polyline>
              <polyline points="8 6 2 12 8 18"></polyline>
            </svg>
            ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑŸÉŸàÿØ
          `;
        }, 2000);
      }
    }
    
    function showDiffForStep(button) {
      const stepNumber = button.dataset.step;
      const session = sessions[currentSessionId];
      
      if (!session || !session.codeHistory) return;
      
      // ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿßŸÑŸÉŸàÿØ ŸÇÿ®ŸÑ Ÿàÿ®ÿπÿØ Ÿáÿ∞Ÿá ÿßŸÑÿÆÿ∑Ÿàÿ©
      const currentIndex = session.historyIndex;
      if (currentIndex > 0) {
        const oldCode = session.codeHistory[Math.max(0, currentIndex - parseInt(stepNumber))];
        const newCode = session.codeHistory[currentIndex];
        
        // ÿ•ŸÜÿ¥ÿßÿ° ŸÜÿßŸÅÿ∞ÿ© ŸÖŸÜÿ®ÿ´ŸÇÿ© ŸÑÿπÿ±ÿ∂ ÿßŸÑÿßÿÆÿ™ŸÑÿßŸÅÿßÿ™
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.style.zIndex = '2000';
        modal.innerHTML = `
          <div class="modal-content" style="max-width: 90%; max-height: 90%;">
            <div class="modal-header" style="justify-content: space-between;">
              <h3 style="margin: 0; color: var(--text-color);">ŸÖŸÇÿßÿ±ŸÜÿ© ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ - ÿßŸÑÿÆÿ∑Ÿàÿ© ${stepNumber}</h3>
              <button id="close-diff-modal" style="background: none; border: none; color: var(--text-color); font-size: 1.5rem; cursor: pointer;">&times;</button>
            </div>
            <div style="flex: 1; overflow: hidden;">
              ${createDiffView(oldCode, newCode, stepNumber)}
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        // ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÜÿßŸÅÿ∞ÿ©
        modal.querySelector('#close-diff-modal').onclick = () => {
          document.body.removeChild(modal);
        };
        
        modal.onclick = (e) => {
          if (e.target === modal) {
            document.body.removeChild(modal);
          }
        };
      }
    }
    
    function addMessageToState(text, sender) {
        sessions[currentSessionId].messages.push({ text, sender });
        saveState();
    }
    
    function addCodeToHistory(newCode) {
        const session = sessions[currentSessionId];
        if (session.historyIndex < session.codeHistory.length - 1) {
            session.codeHistory = session.codeHistory.slice(0, session.historyIndex + 1);
        }
        session.codeHistory.push(newCode);
        session.historyIndex = session.codeHistory.length - 1;
        updateUndoRedoButtons();
        saveState();
    }

    function updateUndoRedoButtons() {
        const session = sessions[currentSessionId];
        undoBtn.disabled = session.historyIndex <= 0;
        redoBtn.disabled = session.historyIndex >= session.codeHistory.length - 1;
    }

    function undo() {
        const session = sessions[currentSessionId];
        if (session.historyIndex > 0) {
            session.historyIndex--;
            const code = session.codeHistory[session.historyIndex];
            updateCodeAndView(code);
            updateUndoRedoButtons();
            saveState();
        }
    }

    function redo() {
        const session = sessions[currentSessionId];
        if (session.historyIndex < session.codeHistory.length - 1) {
            session.historyIndex++;
            const code = session.codeHistory[session.historyIndex];
            updateCodeAndView(code);
            updateUndoRedoButtons();
            saveState();
        }
    }


    async function handleSendMessage(e) {
      e.preventDefault();
      
      if (isProcessing) {
        _createMessageElement('ÿ¨ÿßÿ±Ÿä ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ©... Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±', 'ai');
        return;
      }
      
      isProcessing = true;
      
      // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÉŸàÿØ ÿßŸÑÿ≠ÿßŸÑŸä ŸÖŸÜ ÿßŸÑŸÖÿ≠ÿ±ÿ± ŸÇÿ®ŸÑ ÿ£Ÿä ŸÖÿπÿßŸÑÿ¨ÿ©
      const session = sessions[currentSessionId];
      if (session) {
        session.codeHistory[session.historyIndex] = codeDisplay.textContent;
        saveState();
      }
      
      const prompt = promptInput.value.trim();
      if (!prompt) {
        isProcessing = false;
        return;
      }

      const currentCode = codeDisplay.textContent;

      // ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÅŸàÿ±ÿßŸã
      _createMessageElement(prompt, 'user');
      addMessageToState(prompt, 'user');
      
      promptInput.value = '';
      promptInput.disabled = true;
      sendButton.disabled = true;
      
      // ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ≥ŸäÿßŸÇ ÿ®ÿßŸÑŸàŸÉŸäŸÑ ÿßŸÑÿ∞ŸÉŸä
      const analysis = await smartAgent.analyzeContext(prompt, currentCode);
      if (analysis.error && !analysis.retry) {
        _createMessageElement(`ŸÅÿ¥ŸÑ ŸÅŸä ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÖŸáŸÖÿ©: ${analysis.message}`, 'ai');
        isProcessing = false;
        promptInput.disabled = false;
        sendButton.disabled = false;
        return;
      }
      
      // ÿπÿ±ÿ∂ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
      if (!analysis.error) {
        _createMessageElement(`üîç ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÖŸáŸÖÿ©:
ŸÜŸàÿπ ÿßŸÑŸÖŸáŸÖÿ©: ${analysis.task_type}
ŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑÿ™ÿπŸÇŸäÿØ: ${analysis.complexity}
ÿßŸÑÿ™ŸÇŸÜŸäÿßÿ™ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©: ${analysis.technologies?.join(', ')}
ÿßÿ≥ÿ™ÿ±ÿßÿ™Ÿäÿ¨Ÿäÿ© ÿßŸÑÿ™ŸÜŸÅŸäÿ∞: ${analysis.strategy}`, 'ai');
      }
        
        // ÿ™ŸàŸÑŸäÿØ ÿπŸÜŸàÿßŸÜ ŸÑŸÑÿØÿ±ÿØÿ¥ÿ© ÿ®ÿπÿØ ÿ£ŸàŸÑ ÿ±ÿ≥ÿßŸÑÿ© ŸÖŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
        if (session.messages.length === 2) { // ÿ£ŸàŸÑ ÿ±ÿ≥ÿßŸÑÿ© ŸÖŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
          try {
            const titlePrompt = `ÿßŸÇÿ™ÿ±ÿ≠ ÿπŸÜŸàÿßŸÜŸãÿß ŸÖÿÆÿ™ÿµÿ±Ÿãÿß (3-6 ŸÉŸÑŸÖÿßÿ™) ŸäÿµŸÅ ÿ∑ŸÑÿ® ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ™ÿßŸÑŸä ÿ®ÿ¥ŸÉŸÑ Ÿàÿßÿ∂ÿ≠ÿå ÿ®ÿØŸàŸÜ ÿπŸÑÿßŸÖÿßÿ™ ÿ™ÿ±ŸÇŸäŸÖ ÿ•ÿ∂ÿßŸÅŸäÿ© ÿ£Ÿà ÿ±ŸÖŸàÿ≤ÿå ŸÅŸÇÿ∑ ŸÜÿµ Ÿàÿßÿ∂ÿ≠:
\n\n${prompt}`;
            callGenAI(ai => ai.models.generateContent({
              model: 'gemini-2.5-flash',
              contents: titlePrompt
            })).then(titleRes => {
              let title = titleRes.text.trim().replace(/[\n\r]+/g, ' ');
              if (title.length > 32) title = title.slice(0, 32) + '‚Ä¶';
              session.title = title;
              saveState();
              renderChatList();
            }).catch(e => { 
              console.log('ŸÅÿ¥ŸÑ ŸÅŸä ÿ™ŸàŸÑŸäÿØ ÿßŸÑÿπŸÜŸàÿßŸÜ:', e);
            });
          } catch (e) { 
            console.log('ŸÅÿ¥ŸÑ ŸÅŸä ÿ™ŸàŸÑŸäÿØ ÿßŸÑÿπŸÜŸàÿßŸÜ:', e);
          }
        }
      const loadingMessage = _createMessageElement('ÿ£ÿ≠ŸÑŸÑ ÿ∑ŸÑÿ®ŸÉ...', 'ai', true);

      try {
        const session = sessions[currentSessionId];
        const formattedHistory = session.messages.map(m => `${m.sender === 'user' ? 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ' : 'ŸÖÿ≥ÿßÿπÿØ'}: ${m.text}`).join('\n\n');

        const planningPrompt = `You are an intelligent AI assistant. Your responses must be in Arabic.\nBased on the full conversation history provided below, analyze ONLY the latest user request.\n\nConversation History:\n---\n${formattedHistory}\n---\n\nCurrent Code:\n---\n${currentCode || '(empty)'}\n---\n\nBased on this latest request, decide if it is a 'code_modification' or a 'general_question'.\n- If it's a 'code_modification', create a step-by-step plan. The tasks in the plan MUST be in Arabic.\n- If it's a 'general_question', provide a direct, helpful answer in Arabic, taking the full conversation history into account for context.\n\nŸÖŸÑÿßÿ≠ÿ∏ÿ© ŸáÿßŸÖÿ©: Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ ÿßŸÑŸÉŸàÿØ ÿßŸÑŸÜÿßÿ™ÿ¨ ÿπÿ®ÿßÿ±ÿ© ÿπŸÜ ŸÖŸÑŸÅ HTML Ÿàÿßÿ≠ÿØ ŸÅŸÇÿ∑ÿå ŸàŸäÿ≠ÿ™ŸàŸä ÿ®ÿØÿßÿÆŸÑŸá ÿπŸÑŸâ ÿ¨ŸÖŸäÿπ ÿ£ŸÉŸàÿßÿØ CSS ŸàJavaScript ÿßŸÑŸÑÿßÿ≤ŸÖÿ© ÿØÿßÿÆŸÑ Ÿàÿ≥ŸàŸÖ <style> Ÿà<script>.`;

        const planningResponse = await callGenAI(ai => ai.models.generateContent({
            model: 'gemini-2.5-flash',
            contents: planningPrompt,
            config: {
                responseMimeType: "application/json",
                responseSchema: {
                    type: Type.OBJECT,
                    properties: {
                        request_type: { type: Type.STRING, enum: ["code_modification", "general_question"] },
                        tasks: {
                            type: Type.ARRAY,
                            items: { type: Type.STRING },
                            description: "ŸÇÿßÿ¶ŸÖÿ© ŸÖŸáÿßŸÖ ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÉŸàÿØ ÿ®ÿßŸÑŸÑÿ∫ÿ© ÿßŸÑÿπÿ±ÿ®Ÿäÿ©."
                        },
                        answer: { type: Type.STRING, description: "ÿ•ÿ¨ÿßÿ®ÿ© ŸÑŸÑÿ≥ÿ§ÿßŸÑ ÿßŸÑÿπÿßŸÖ ÿ®ÿßŸÑŸÑÿ∫ÿ© ÿßŸÑÿπÿ±ÿ®Ÿäÿ©." }
                    }
                }
            }
        }));
        
        loadingMessage.remove();
        const plan = JSON.parse(planningResponse.text);

        if (plan.request_type === 'general_question') {
            _createMessageElement(plan.answer, 'ai');
            addMessageToState(plan.answer, 'ai');
        } else if (plan.request_type === 'code_modification' && plan.tasks && plan.tasks.length > 0) {
            if (currentMode !== 'normal') {
              await executeAdvancedTaskPlan(plan.tasks, prompt, currentMode);
            } else {
              await executeTaskPlan(plan.tasks, formattedHistory, prompt);
            }
            
            // ÿ™ÿ≥ÿ¨ŸäŸÑ ŸÜÿ¨ÿßÿ≠ ÿßŸÑÿ™ŸÅÿßÿπŸÑ ŸÑŸÑÿ™ÿπŸÑŸÖ
            smartAgent.learnFromInteraction(prompt, 'ŸÜÿ¨ÿ≠ ÿ™ŸÜŸÅŸäÿ∞ ÿßŸÑŸÖŸáÿßŸÖ', true);
        } else {
            const fallbackMsg = "ŸÑŸÖ ÿ£ÿ™ŸÖŸÉŸÜ ŸÖŸÜ ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ° ÿßŸÑŸÖÿ∑ŸÑŸàÿ®. ŸáŸÑ ŸäŸÖŸÉŸÜŸÉ ÿ•ÿπÿßÿØÿ© ÿµŸäÿßÿ∫ÿ© ÿ∑ŸÑÿ®ŸÉÿü";
             _createMessageElement(fallbackMsg, 'ai');
             addMessageToState(fallbackMsg, 'ai');
        }

      } catch (error) {
        console.error(error);
        loadingMessage.remove();
        
        // ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿÆÿ∑ÿ£ ÿ®ÿßŸÑŸàŸÉŸäŸÑ ÿßŸÑÿ∞ŸÉŸä
        const errorHandling = smartAgent.handleError(error, 'ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©');
        if (errorHandling.retry) {
          _createMessageElement(`‚ö†Ô∏è ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ÿå ÿ¨ÿßÿ±Ÿä ÿ•ÿπÿßÿØÿ© ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ©... (ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ${errorRetryCount})`, 'ai');
          // ÿ•ÿπÿßÿØÿ© ÿ™ŸÜŸÅŸäÿ∞ ÿßŸÑÿπŸÖŸÑŸäÿ©
          setTimeout(() => handleSendMessage(e), 2000);
          return;
        }
        
        const errorMsg = `‚ùå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£: ${error.message}
        
üîß ÿßŸÇÿ™ÿ±ÿßÿ≠ÿßÿ™ ÿßŸÑÿ•ÿµŸÑÿßÿ≠:
- ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßÿ™ÿµÿßŸÑ ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™
- ÿ¨ÿ±ÿ® ÿ•ÿπÿßÿØÿ© ÿµŸäÿßÿ∫ÿ© ÿßŸÑÿ∑ŸÑÿ®
- ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿ£ÿ≠ÿØ ÿßŸÑÿ£ÿØŸàÿßÿ™ ÿßŸÑŸÖÿ™ÿÆÿµÿµÿ© ŸÖŸÜ ÿßŸÑŸÇÿßÿ¶ŸÖÿ©`;
        _createMessageElement(errorMsg, 'ai');
        addMessageToState(errorMsg, 'ai');
        
        // ÿ™ÿ≥ÿ¨ŸäŸÑ ŸÅÿ¥ŸÑ ÿßŸÑÿ™ŸÅÿßÿπŸÑ ŸÑŸÑÿ™ÿπŸÑŸÖ
        smartAgent.learnFromInteraction(prompt, error.message, false);
      } finally {
        isProcessing = false;
        promptInput.disabled = false;
        sendButton.disabled = false;
        promptInput.focus();
      }
    }
    
    async function executeTaskPlan(tasks, formattedHistory, originalPrompt, specialPrompt = '') {
        // ÿ•ÿ∂ÿßŸÅÿ© ÿÆÿ∑Ÿàÿ© CSS ÿ™ŸÑŸÇÿßÿ¶Ÿäÿ© ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™Ÿàÿ¨ÿØ ÿÆÿ∑Ÿàÿ© ÿ™ÿµŸÖŸäŸÖ ÿ£Ÿà CSS
        const hasCssStep = tasks.some(task => /css|ÿ™ÿµŸÖŸäŸÖ|ÿ™ŸÜÿ≥ŸäŸÇ|style|ÿ≥ÿ™ÿßŸäŸÑ/i.test(task));
        if (!hasCssStep) {
            tasks.unshift('ÿ£ÿ∂ŸÅ ÿ™ŸÜÿ≥ŸäŸÇÿßÿ™ CSS ÿ≠ÿØŸäÿ´ÿ© Ÿàÿ¨ŸÖŸäŸÑÿ© ŸÑŸÑŸÖŸàŸÇÿπ.');
        }
        renderTaskList(tasks);
        let currentCode = sessions[currentSessionId].codeHistory[sessions[currentSessionId].historyIndex];
        let completedTasks = 0;
        let lastModifiedLines = [];
        
        for (let i = 0; i < tasks.length; i++) {
            const taskDesc = tasks[i];
            updateTaskStatus(i, 'in-progress');
            const oldCode = currentCode; // ÿ≠ŸÅÿ∏ ÿßŸÑŸÉŸàÿØ ÿßŸÑŸÇÿØŸäŸÖ ŸÇÿ®ŸÑ ÿßŸÑÿ™ÿπÿØŸäŸÑ
            const numberedCode = currentCode.split('\n').map((line, index) => `${index + 1}: ${line}`).join('\n');
            try {
                const executionPrompt = `You are a surgical code editing AI. ${specialPrompt} Your task is to modify the provided code to accomplish a specific task.\nYou MUST respond with ONLY the JSON object for the modification, without any explanation, description, or extra text.\nThe format is: { \"start_line\": number, \"end_line\": number, \"new_code\": \"string_of_new_code\" }\n- \"start_line\" and \"end_line\" are 1-based indices corresponding to the line numbers in the input.\n- To insert code at a specific line, set \"end_line\" to \"start_line - 1\". The code will be inserted before \"start_line\". For example, to insert at the beginning of the file, use start_line: 1, end_line: 0.\n- To delete lines, set \"new_code\" to an empty string \"\".\n- \"new_code\" should be a single string, with newlines represented by '\\n'.\n\nConversation History (for context):\n---\n${formattedHistory}\n---\n\nUser's original high-level request: \"${originalPrompt}\"\n\nThe specific, single task to execute now is: \"${taskDesc}\"\n\nCurrent Code (with 1-based line numbers):\n---\n${numberedCode || "(empty)"}\n---\n\nNow, provide ONLY the JSON object for the modification.`;

                const response = await callGenAI(ai => ai.models.generateContent({
                    model: "gemini-2.5-flash",
                    contents: executionPrompt,
                    config: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: Type.OBJECT,
                            properties: {
                                start_line: { type: Type.NUMBER, description: "The 1-based starting line number for the code modification." },
                                end_line: { type: Type.NUMBER, description: "The 1-based ending line number for the code modification." },
                                new_code: { type: Type.STRING, description: "The new code to insert/replace, with newlines as \\n." }
                            },
                            required: ["start_line", "end_line", "new_code"]
                        }
                    }
                }));
                const modification = JSON.parse(response.text);
                const { start_line, end_line, new_code } = modification;
                let codeLines = currentCode.split('\n');
                if (codeLines.length === 1 && codeLines[0] === '') {
                    codeLines = [];
                }
                const startIdx = start_line - 1;
                const endIdx = end_line - 1;
                const deleteCount = Math.max(0, endIdx - startIdx + 1);
                if (startIdx < -1 || startIdx > codeLines.length) {
                   throw new Error(`AI provided an invalid start line: ${start_line}. File has ${codeLines.length} lines.`);
                }
                const newCodeLines = (new_code === null || new_code === undefined) ? [] : new_code.split('\n');
                // Highlight the lines that will be modified (after the change)
                lastModifiedLines = [];
                if (newCodeLines.length > 0) {
                  for (let l = 0; l < newCodeLines.length; l++) {
                    lastModifiedLines.push(startIdx + 1 + l);
                  }
                }
                codeLines.splice(startIdx, deleteCount, ...newCodeLines);
                currentCode = codeLines.join('\n');
                // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÉŸàÿØ ŸÅŸä ÿßŸÑŸÖÿ≠ÿ±ÿ± ŸÖÿ®ÿßÿ¥ÿ±ÿ© ÿ®ÿπÿØ ŸÉŸÑ ÿÆÿ∑Ÿàÿ©
                updateCodeAndView(currentCode, lastModifiedLines);
                addCodeToHistory(currentCode);
                
                // ÿ•ŸÜÿ¥ÿßÿ° ÿπÿ±ÿ∂ ÿßŸÑÿßÿÆÿ™ŸÑÿßŸÅÿßÿ™ Ÿàÿπÿ±ÿ∂Ÿá ŸÅŸä ÿ±ÿ≥ÿßŸÑÿ© AI
                const stepNumber = i + 1;
                const diffHtml = createDiffView(oldCode, currentCode, stepNumber);
                
                const messageEl = document.createElement('div');
                messageEl.classList.add('message', 'ai');
                messageEl.innerHTML = diffHtml;
                messagesContainer.appendChild(messageEl);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                // ÿ≠ŸÅÿ∏ ÿ±ÿ≥ÿßŸÑÿ© ŸÖÿ®ÿ≥ÿ∑ÿ© ŸÅŸä ÿßŸÑÿ∞ÿßŸÉÿ±ÿ©
                addMessageToState(`ÿ™ŸÖ ÿ™ŸÜŸÅŸäÿ∞ ÿßŸÑÿÆÿ∑Ÿàÿ© ${stepNumber}: ${taskDesc}`, 'ai');
                updateTaskStatus(i, 'completed');
                completedTasks++;
                taskCounter.textContent = `${completedTasks} / ${tasks.length}`;
            } catch(err) {
                console.error(`Error on task ${i}:`, err);
                const errorDetails = err.message || JSON.stringify(err);
                updateTaskStatus(i, 'failed', errorDetails);
                const failMsg = `ŸÅÿ¥ŸÑÿ™ ŸÅŸä ÿ•ŸÉŸÖÿßŸÑ ÿßŸÑŸÖŸáŸÖÿ©: "${taskDesc}"\nÿßŸÑÿ≥ÿ®ÿ®: ${errorDetails}`;
                _createMessageElement(failMsg, 'ai');
                addMessageToState(failMsg, 'ai');
                return; 
            }
        }
        // ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÜŸáÿßÿ¶Ÿä ŸÅŸä ŸÜŸáÿßŸäÿ© ÿßŸÑÿØÿßŸÑÿ©
        const successMsg = 'ŸÑŸÇÿØ ÿ£ŸÉŸÖŸÑÿ™ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸáÿßŸÖ ÿ®ŸÜÿ¨ÿßÿ≠.';
        _createMessageElement(successMsg, 'ai');
        addMessageToState(successMsg, 'ai');
    }

    function renderTaskList(tasks) {
        taskList.innerHTML = '';
        tasks.forEach((taskDesc, index) => {
            const taskItem = document.createElement('div');
            taskItem.className = 'task-item';
            taskItem.dataset.index = index;
            taskItem.innerHTML = `
                <div class="task-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="pending-icon"><circle cx="12" cy="12" r="10"></circle></svg>
                </div>
                <span>${taskDesc}</span>`;
            taskList.appendChild(taskItem);
        });
        taskCounter.textContent = `0 / ${tasks.length}`;
        taskProgressContainer.classList.remove('collapsed');
        taskProgressContainer.style.display = 'block';
    }

    function updateTaskStatus(index, status, errorMsg = '') {
        const taskItem = taskList.querySelector(`.task-item[data-index='${index}']`);
        if (!taskItem) return;
        const iconContainer = taskItem.querySelector('.task-icon');
        
        let iconHtml = '';
        switch (status) {
            case 'in-progress':
                iconHtml = `<div class="spinner"></div>`; break;
            case 'completed':
                iconHtml = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="check-icon"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
                taskItem.style.color = 'var(--success-color)'; break;
            case 'failed':
                iconHtml = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="error-icon"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>`;
                taskItem.style.color = 'var(--error-color)';
                taskItem.title = errorMsg; break;
        }
        iconContainer.innerHTML = iconHtml;
    }


    function showPreview() {
      const currentCode = sessions[currentSessionId].codeHistory[sessions[currentSessionId].historyIndex];
      previewFrame.srcdoc = currentCode;
      previewModal.style.display = 'flex';
    }

    function hidePreview() {
      previewModal.style.display = 'none';
      previewFrame.srcdoc = ''; 
    }

    function applyChanges() {
      if (confirm("ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØÿü ÿ≥Ÿäÿ§ÿØŸä Ÿáÿ∞ÿß ÿ•ŸÑŸâ ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ© ÿ®ÿßŸÑŸÉŸàÿØ ÿßŸÑÿ¨ÿØŸäÿØ.")) {
        const newCode = sessions[currentSessionId].codeHistory[sessions[currentSessionId].historyIndex];
        const blob = new Blob([newCode], {type: 'text/html'});
        const url = URL.createObjectURL(blob);
        window.location.href = url;
      }
    }

    // ========== AI Discussion Logic ==========
    let stopAIDiscussion = false;
    async function startAIDiscussionLoop() {
      stopAIDiscussion = false;
      aiDiscussionContent.innerHTML = '';
      let ai1Memory = [];
      let ai2Memory = [];
      let currentCode = sessions[currentSessionId].codeHistory[sessions[currentSessionId].historyIndex];
      let improvedCode = currentCode;
      let round = 1;

      // ÿ•ÿπÿØÿßÿØ ŸÜŸÖÿßÿ∞ÿ¨ ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä
      const ai1 = new GoogleGenAI({ apiKey: "AIzaSyCYlSM0arXvt1GMnsUMIPrTF4T3U-jsxKI" });
      const ai2 = new GoogleGenAI({ apiKey: "AIzaSyCJhj0oJaRQeKudyDyvtSf-fz-xbpL-Mm8" });

      while (!stopAIDiscussion) {
        // AI1: ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ≥ŸÑÿ®Ÿäÿßÿ™
        const ai1Prompt = `ÿ£ŸÜÿ™ ÿÆÿ®Ÿäÿ± ÿ™ÿ¨ÿ±ÿ®ÿ© ŸÖÿ≥ÿ™ÿÆÿØŸÖ (UX) ŸàŸÖŸáŸÖÿ™ŸÉ ÿ™ÿ≠ŸÑŸäŸÑ ŸÉŸàÿØ HTML ÿßŸÑÿ™ÿßŸÑŸä ŸÅŸÇÿ∑ ŸÖŸÜ ŸÜÿßÿ≠Ÿäÿ© ÿ™ÿ¨ÿ±ÿ®ÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖÿå Ÿàÿ∞ŸÉÿ± ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≥ŸÑÿ®Ÿäÿßÿ™ ŸàÿßŸÑŸÖÿ¥ÿßŸÉŸÑ ÿßŸÑÿ™Ÿä ŸÇÿØ ÿ™ÿ§ÿ´ÿ± ÿπŸÑŸâ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ®ÿ¥ŸÉŸÑ ŸÖŸÜÿ∑ŸÇŸä ŸàŸÖŸÜŸáÿ¨Ÿäÿå ŸÖÿπ ÿßŸÇÿ™ÿ±ÿßÿ≠ ÿÆÿ∑Ÿàÿßÿ™ ÿπŸÖŸÑ Ÿàÿßÿ∂ÿ≠ÿ© ŸÑŸÑÿ™ÿ≠ÿ≥ŸäŸÜ. ŸÑÿß ÿ™ŸÉÿ™ÿ® ÿ£Ÿä ŸÉŸàÿØÿå ŸÅŸÇÿ∑ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ ŸàÿßŸÑÿÆÿ∑Ÿàÿßÿ™.\n\n${ai1Memory.length > 0 ? 'ÿ≥ŸäÿßŸÇ ÿ≥ÿßÿ®ŸÇ:\n' + ai1Memory.join('\n---\n') + '\n' : ''}ÿßŸÑŸÉŸàÿØ ÿßŸÑÿ≠ÿßŸÑŸä:\n---\n${improvedCode}\n---`;
        aiDiscussionContent.innerHTML += `<div style="margin-bottom:1rem;"><b>AI1 (ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ≥ŸÑÿ®Ÿäÿßÿ™):</b><br><span style="color:#e06c75;">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ...</span></div>`;
        aiDiscussionContent.scrollTop = aiDiscussionContent.scrollHeight;
        let ai1Analysis = '';
        try {
          const ai1Res = await callGenAI(ai => ai.models.generateContent({
            model: 'gemini-2.5-flash',
            contents: ai1Prompt
          }));
          ai1Analysis = ai1Res.text.trim();
        } catch (err) {
          ai1Analysis = 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÑŸäŸÑ AI1: ' + err.message;
          stopAIDiscussion = true;
        }
        ai1Memory.push(ai1Analysis);
        aiDiscussionContent.innerHTML = aiDiscussionContent.innerHTML.replace('ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ...', ai1Analysis.replace(/\n/g, '<br>'));
        aiDiscussionContent.scrollTop = aiDiscussionContent.scrollHeight;
        if (stopAIDiscussion) break;

        // AI2: ÿ™ŸÜŸÅŸäÿ∞ ÿßŸÑÿ™ÿ≠ÿ≥ŸäŸÜÿßÿ™
        // ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿßŸÑÿÆÿ∑Ÿàÿßÿ™ ŸÖŸÜ ÿ™ÿ≠ŸÑŸäŸÑ AI1
        let steps = [];
        const stepRegex = /(?:^|\n)\s*(?:\d+\.|-)[ \t]*(.+?)(?=\n|$)/g;
        let match;
        while ((match = stepRegex.exec(ai1Analysis)) !== null) {
          steps.push(match[1].trim());
        }
        if (steps.length === 0) {
          // ÿ•ÿ∞ÿß ŸÑŸÖ Ÿäÿ™ŸÖŸÉŸÜ ŸÖŸÜ ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿÆÿ∑Ÿàÿßÿ™ÿå ŸÜŸÅÿ∞ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ ŸÉŸÑŸá ÿØŸÅÿπÿ© Ÿàÿßÿ≠ÿØÿ©
            steps = [ai1Analysis];
        }
        for (let i = 0; i < steps.length; i++) {
          if (stopAIDiscussion) break;
          const step = steps[i];
          const ai2StepPrompt = `ÿ£ŸÜÿ™ ÿÆÿ®Ÿäÿ± ÿ™ÿ∑ŸàŸäÿ± Ÿàÿßÿ¨Ÿáÿßÿ™ ŸàŸäÿ®. ŸÑÿØŸäŸÉ ŸÉŸàÿØ HTML ŸÅŸÇÿ∑ (ÿ®ÿØŸàŸÜ CSS ÿ£Ÿà JS ÿÆÿßÿ±ÿ¨Ÿä). ŸÖŸáŸÖÿ™ŸÉ ÿ™ŸÜŸÅŸäÿ∞ ÿßŸÑÿÆÿ∑Ÿàÿ© ÿßŸÑÿ™ÿßŸÑŸäÿ© ŸÅŸÇÿ∑ ÿπŸÑŸâ ÿßŸÑŸÉŸàÿØ ÿßŸÑÿ≠ÿßŸÑŸäÿå ÿ´ŸÖ ÿ™ÿπŸäÿØ ÿßŸÑŸÉŸàÿØ ÿßŸÑÿ¨ÿØŸäÿØ ŸÅŸÇÿ∑ (ÿ®ÿØŸàŸÜ ÿ¥ÿ±ÿ≠ ÿ£Ÿà ÿ™ÿπŸÑŸäŸÇ ÿ£Ÿà ÿ£Ÿä ŸÜÿµ ÿ¢ÿÆÿ±).\n\nÿßŸÑÿÆÿ∑Ÿàÿ© ÿßŸÑŸÖÿ∑ŸÑŸàÿ® ÿ™ŸÜŸÅŸäÿ∞Ÿáÿß:\n${step}\n\nÿßŸÑŸÉŸàÿØ ÿßŸÑÿ≠ÿßŸÑŸä:\n---\n${improvedCode}\n---`;
          aiDiscussionContent.innerHTML += `<div style=\"margin-bottom:1rem;\"><b>AI2 (ÿ™ŸÜŸÅŸäÿ∞ ÿÆÿ∑Ÿàÿ©: ${step.replace(/[&<>]/g, function(tag) {
            const charsToReplace = { '&': '&amp;', '<': '&lt;', '>': '&gt;' };
            return charsToReplace[tag] || tag;
          })}):</b><br><span style=\"color:#56c4d8;\">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ŸÜŸÅŸäÿ∞...</span></div>`;
          aiDiscussionContent.scrollTop = aiDiscussionContent.scrollHeight;
          let ai2StepCode = '';
          try {
            const ai2StepRes = await callGenAI(ai => ai.models.generateContent({
              model: 'gemini-2.5-flash',
              contents: ai2StepPrompt
            }));
            ai2StepCode = ai2StepRes.text.trim();
          } catch (err) {
            ai2StepCode = 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ŸÜŸÅŸäÿ∞ AI2: ' + err.message;
            stopAIDiscussion = true;
          }
          ai2Memory.push(ai2StepCode);
          aiDiscussionContent.innerHTML = aiDiscussionContent.innerHTML.replace(
            'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ŸÜŸÅŸäÿ∞...',
            `<div style=\"margin-bottom:0.5rem; color:#aaa; font-size:13px;\">(ÿ™ŸÖ ÿ™ŸÜŸÅŸäÿ∞ ÿßŸÑÿÆÿ∑Ÿàÿ©: ${step.replace(/[&<>]/g, function(tag) {
              const charsToReplace = { '&': '&amp;', '<': '&lt;', '>': '&gt;' };
              return charsToReplace[tag] || tag;
            })}. ÿßŸÑŸÉŸàÿØ ÿßŸÑŸÉÿßŸÖŸÑ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´Ÿá ŸÅŸä ÿßŸÑŸÖÿ≠ÿ±ÿ± ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä ŸàŸäŸÖŸÉŸÜŸÉ ÿ™ÿπÿØŸäŸÑŸá ÿ£Ÿà ŸÖÿπÿßŸäŸÜÿ™Ÿá ŸÖÿ®ÿßÿ¥ÿ±ÿ©)</div><pre style=\"background:#222; color:#fff; padding:0.5rem; border-radius:6px; overflow:auto; max-height:200px;\">${ai2StepCode.replace(/[&<>]/g, function(tag) {
              const charsToReplace = { '&': '&amp;', '<': '&lt;', '>': '&gt;' };
              return charsToReplace[tag] || tag;
            })}</pre>`
          );
          aiDiscussionContent.scrollTop = aiDiscussionContent.scrollHeight;
          if (stopAIDiscussion) break;
          // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÉŸàÿØ ŸÅŸä ÿßŸÑŸÖÿ≠ÿ±ÿ± ÿ®ÿπÿØ ŸÉŸÑ ÿÆÿ∑Ÿàÿ©
          improvedCode = ai2StepCode;
          updateCodeAndView(improvedCode);
          applyImprovedBtn.style.display = 'inline-block';
          // ÿßŸÜÿ™ÿ∏ÿßÿ± ŸÇÿµŸäÿ± ŸÑÿ•ÿ™ÿßÿ≠ÿ© ÿßŸÑÿ•ŸäŸÇÿßŸÅ
          await new Promise(res => setTimeout(res, 400));
        }

        // ÿπŸÜÿØ ÿßŸÑÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ "ÿßÿπÿ™ŸÖÿßÿØ ÿßŸÑŸÉŸàÿØ ÿßŸÑŸÖÿ≠ÿ≥ŸÜ"
        applyImprovedBtn.onclick = () => {
          addCodeToHistory(improvedCode);
          updateCodeAndView(improvedCode);
          aiDiscussionModal.style.display = 'none';
        };

        // ÿßŸÜÿ™ÿ∏ÿßÿ± ŸÇÿµŸäÿ± ÿ®ŸäŸÜ ÿßŸÑÿ¨ŸàŸÑÿßÿ™ (ŸÑÿ•ÿ™ÿßÿ≠ÿ© ÿßŸÑÿ•ŸäŸÇÿßŸÅ)
        await new Promise(res => setTimeout(res, 500));
      }
    }

    // ========== Self-Improvement Logic ==========
    let stopSelfImprove = false;
    selfImproveBtn.addEventListener('click', async () => {
      stopSelfImprove = false;
      selfImproveBtn.disabled = true;
      selfImproveBtn.textContent = 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ∑ŸàŸäÿ± ÿßŸÑÿ∞ÿßÿ™Ÿä...';
      let currentCode = sessions[currentSessionId].codeHistory[sessions[currentSessionId].historyIndex];
      let round = 1;
      while (!stopSelfImprove) {
        // ÿßÿ≠ÿ∞ŸÅ ÿ±ÿ≥ÿßÿ¶ŸÑ ÿßŸÑÿ™ÿ∑ŸàŸäÿ± ÿßŸÑÿ∞ÿßÿ™Ÿä ÿßŸÑÿ≥ÿßÿ®ŸÇÿ© ŸÇÿ®ŸÑ ŸÉŸÑ ÿ¨ŸàŸÑÿ© ÿ¨ÿØŸäÿØÿ©
        clearSelfImproveMessages();
        // 1. ÿßÿ∑ŸÑÿ® ŸÖŸÜ ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä ÿ™ŸàŸÑŸäÿØ ÿÆÿ∑ÿ© ÿ™ÿ∑ŸàŸäÿ± ÿ¨ÿØŸäÿØÿ© ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿßŸÑŸÉŸàÿØ ÿßŸÑÿ≠ÿßŸÑŸä
        const planningPrompt = `ÿ£ŸÜÿ™ ŸÖÿ≥ÿßÿπÿØ ÿ®ÿ±ŸÖÿ¨Ÿä ÿ∞ÿßÿ™Ÿä ÿßŸÑÿ™ÿ∑ŸàŸäÿ±. ŸÖŸáŸÖÿ™ŸÉ ÿßŸÑŸàÿ≠ŸäÿØÿ© ÿ™ÿ≠ÿ≥ŸäŸÜ ÿßŸÑÿ¨ŸÖÿßŸÑŸäÿßÿ™ ŸàÿßŸÑÿ™ŸÜÿ≥ŸäŸÇ ŸàÿßŸÑÿ¥ŸÉŸÑ Ÿàÿ™ÿ¨ÿ±ÿ®ÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ (UI/UX) ŸÑŸÑŸÉŸàÿØ ÿßŸÑÿ≠ÿßŸÑŸä ŸÅŸÇÿ∑ÿå ŸÖÿ´ŸÑ ÿßŸÑÿ£ŸÑŸàÿßŸÜÿå ÿßŸÑÿÆÿ∑Ÿàÿ∑ÿå ÿßŸÑÿ™ÿ®ÿßÿπÿØÿå ÿßŸÑÿ±ÿ≥ŸàŸÖŸäÿßÿ™ÿå ÿßŸÑÿ™ŸÅÿßÿπŸÑ ÿßŸÑÿ®ÿµÿ±Ÿäÿå Ÿàÿ™ÿ≠ÿ≥ŸäŸÜ ÿßŸÑÿπÿ±ÿ∂ ÿπŸÑŸâ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ÿ¨Ÿáÿ≤ÿ©. ŸÑÿß ÿ™ŸÇÿ™ÿ±ÿ≠ ÿ£Ÿà ÿ™ŸÜŸÅÿ∞ ÿ£Ÿä ÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ÿπŸÑŸâ ÿßŸÑŸàÿ∏ÿßÿ¶ŸÅ ÿ£Ÿà ÿßŸÑŸÖŸÜÿ∑ŸÇ ÿ£Ÿà ÿ™ÿ∂ŸäŸÅ ŸÖŸäÿ≤ÿßÿ™ ÿ¨ÿØŸäÿØÿ©. ÿ±ŸÉÿ≤ ŸÅŸÇÿ∑ ÿπŸÑŸâ ÿ™ÿ≠ÿ≥ŸäŸÜ CSS ŸàHTML presentation. ŸÅŸä ŸÉŸÑ ÿ¨ŸàŸÑÿ©ÿå ÿ≠ŸÑŸÑ ÿßŸÑŸÉŸàÿØ ÿßŸÑÿ≠ÿßŸÑŸä ŸàÿßŸÇÿ™ÿ±ÿ≠ ÿÆÿ∑ÿ© ÿ™ÿ∑ŸàŸäÿ± ÿ¨ÿØŸäÿØÿ© ŸÑÿ™ÿ≠ÿ≥ŸäŸÜ ÿßŸÑÿ¥ŸÉŸÑ ŸàÿßŸÑÿ™ÿ¨ÿ±ÿ®ÿ© ÿßŸÑÿ®ÿµÿ±Ÿäÿ© ŸÅŸÇÿ∑. ÿ•ÿ∞ÿß ŸÑŸÖ ŸäÿπÿØ ŸáŸÜÿßŸÉ ŸÖÿß ŸäŸÖŸÉŸÜ ÿ™ÿ≠ÿ≥ŸäŸÜŸá ŸÅŸä ÿßŸÑÿ¨ŸÖÿßŸÑŸäÿßÿ™ÿå ÿ£ÿ¨ÿ® ŸÅŸÇÿ∑: 'ÿßŸÜÿ™ŸáŸâ ÿßŸÑÿ™ÿ∑ŸàŸäÿ± ÿßŸÑÿ∞ÿßÿ™Ÿä.'\n\nÿßŸÑŸÉŸàÿØ ÿßŸÑÿ≠ÿßŸÑŸä:\n---\n${currentCode}\n---`;
        let plan;
        try {
          const planningResponse = await callGenAI(ai => ai.models.generateContent({
            model: 'gemini-2.5-flash',
            contents: planningPrompt,
            config: {
              responseMimeType: "application/json",
              responseSchema: {
                type: Type.OBJECT,
                properties: {
                  tasks: { type: Type.ARRAY, items: { type: Type.STRING }, description: "ÿÆÿ∑Ÿàÿßÿ™ ÿ™ÿ∑ŸàŸäÿ± ÿ∞ÿßÿ™Ÿä ÿ¨ÿØŸäÿØÿ© (ÿ™ÿ≠ÿ≥ŸäŸÜÿßÿ™ ÿ¨ŸÖÿßŸÑŸäÿ© ŸÅŸÇÿ∑)." },
                  finished: { type: Type.BOOLEAN, description: "ŸáŸÑ ÿßŸÜÿ™ŸáŸâ ÿßŸÑÿ™ÿ∑ŸàŸäÿ± ÿßŸÑÿ∞ÿßÿ™Ÿäÿü" }
                },
                required: ["tasks", "finished"]
              }
            }
          }));
          plan = JSON.parse(planningResponse.text);
        } catch (err) {
          _createMessageElement('ŸÅÿ¥ŸÑ ŸÅŸä ÿ™ŸàŸÑŸäÿØ ÿÆÿ∑ÿ© ÿ™ÿ∑ŸàŸäÿ± ÿ∞ÿßÿ™Ÿä: ' + err.message, 'ai');
          break;
        }
        if (plan.finished || !plan.tasks || plan.tasks.length === 0) {
          _createMessageElement('ÿßŸÜÿ™ŸáŸâ ÿßŸÑÿ™ÿ∑ŸàŸäÿ± ÿßŸÑÿ∞ÿßÿ™Ÿä.', 'ai');
          taskProgressContainer.style.display = 'none';
          break;
        }
        // ÿπÿ±ÿ∂ ÿÆÿ∑Ÿàÿßÿ™ ÿßŸÑÿ¨ŸàŸÑÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ© ŸÅŸä ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖŸáÿßŸÖ
        renderTaskList(plan.tasks);
        let completedTasks = 0;
        for (let i = 0; i < plan.tasks.length; i++) {
          if (stopSelfImprove) break;
          const taskDesc = plan.tasks[i];
          updateTaskStatus(i, 'in-progress');
          const numberedCode = currentCode.split('\n').map((line, index) => `${index + 1}: ${line}`).join('\n');
          try {
            const executionPrompt = `ÿ£ŸÜÿ™ ŸÖÿ≥ÿßÿπÿØ ÿ®ÿ±ŸÖÿ¨Ÿä ŸÖÿ™ÿÆÿµÿµ ŸÅŸä ÿ™ÿ≠ÿ≥ŸäŸÜ ÿßŸÑÿ¨ŸÖÿßŸÑŸäÿßÿ™ ŸàÿßŸÑÿ™ŸÜÿ≥ŸäŸÇ ŸàÿßŸÑÿ¥ŸÉŸÑ (UI/UX, CSS, presentation) ŸÅŸÇÿ∑. ŸÖŸáŸÖÿ™ŸÉ ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÉŸàÿØ ÿßŸÑÿ≠ÿßŸÑŸä ŸÑÿ™ÿ≠ŸÇŸäŸÇ ÿßŸÑÿÆÿ∑Ÿàÿ© ÿßŸÑÿ™ÿßŸÑŸäÿ© ŸÅŸÇÿ∑ÿå ÿØŸàŸÜ ÿ£Ÿä ÿ™ÿ∫ŸäŸäÿ± ŸÅŸä ÿßŸÑŸàÿ∏ÿßÿ¶ŸÅ ÿ£Ÿà ÿßŸÑŸÖŸÜÿ∑ŸÇ ÿ£Ÿà ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸäÿ≤ÿßÿ™ ÿ¨ÿØŸäÿØÿ©.\n\nŸäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ ÿ±ÿØŸÉ ŸÉÿßÿ¶ŸÜ JSON ŸÅŸÇÿ∑ ÿ®Ÿáÿ∞ÿß ÿßŸÑÿ¥ŸÉŸÑ: { \"start_line\": ÿ±ŸÇŸÖ, \"end_line\": ÿ±ŸÇŸÖ, \"new_code\": \"ÿßŸÑŸÉŸàÿØ ÿßŸÑÿ¨ÿØŸäÿØ\" }\n- \"start_line\" Ÿà\"end_line\" ÿ£ÿ±ŸÇÿßŸÖ ÿßŸÑÿ£ÿ≥ÿ∑ÿ± (1-based) ÿßŸÑŸÖÿ∑ŸÑŸàÿ® ÿ™ÿπÿØŸäŸÑŸáÿß ÿ£Ÿà ÿßÿ≥ÿ™ÿ®ÿØÿßŸÑŸáÿß.\n- ÿ•ÿ∞ÿß ÿ£ÿ±ÿØÿ™ ÿ•ÿØÿ±ÿßÿ¨ ŸÉŸàÿØÿå ÿßÿ¨ÿπŸÑ end_line = start_line - 1.\n- ÿ•ÿ∞ÿß ÿ£ÿ±ÿØÿ™ ÿ≠ÿ∞ŸÅ ÿ£ÿ≥ÿ∑ÿ±ÿå ÿßÿ¨ÿπŸÑ new_code ŸÅÿßÿ±ÿ∫ÿßŸã.\n- new_code Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ ŸÜÿµÿßŸã Ÿàÿßÿ≠ÿØÿßŸã ŸÖÿπ \n ŸÑŸÑŸÅŸàÿßÿµŸÑ.\n\nÿßŸÑÿÆÿ∑Ÿàÿ©: ${taskDesc}\n\nÿßŸÑŸÉŸàÿØ ÿßŸÑÿ≠ÿßŸÑŸä (ŸÖÿπ ÿ£ÿ±ŸÇÿßŸÖ ÿßŸÑÿ£ÿ≥ÿ∑ÿ±):\n---\n${numberedCode}\n---\n\nÿ£ÿπÿØ ŸÅŸÇÿ∑ ŸÉÿßÿ¶ŸÜ JSON ÿßŸÑŸÖÿ∑ŸÑŸàÿ® ÿ®ÿØŸàŸÜ ÿ£Ÿä ÿ¥ÿ±ÿ≠ ÿ£Ÿà ŸÜÿµ ÿ•ÿ∂ÿßŸÅŸä.`;
            const response = await callGenAI(ai => ai.models.generateContent({
              model: 'gemini-2.5-flash',
              contents: executionPrompt,
              config: {
                responseMimeType: "application/json",
                responseSchema: {
                  type: Type.OBJECT,
                  properties: {
                    start_line: { type: Type.NUMBER, description: "ÿ±ŸÇŸÖ ÿßŸÑÿ≥ÿ∑ÿ± ÿßŸÑÿ£ŸàŸÑ (1-based) ŸÑŸÑÿ™ÿπÿØŸäŸÑ." },
                    end_line: { type: Type.NUMBER, description: "ÿ±ŸÇŸÖ ÿßŸÑÿ≥ÿ∑ÿ± ÿßŸÑÿ£ÿÆŸäÿ± (1-based) ŸÑŸÑÿ™ÿπÿØŸäŸÑ." },
                    new_code: { type: Type.STRING, description: "ÿßŸÑŸÉŸàÿØ ÿßŸÑÿ¨ÿØŸäÿØ ÿßŸÑŸÖÿ∑ŸÑŸàÿ® ÿ•ÿØÿ±ÿßÿ¨Ÿá ÿ£Ÿà ÿßÿ≥ÿ™ÿ®ÿØÿßŸÑŸáÿå ŸÖÿπ \n ŸÑŸÑŸÅŸàÿßÿµŸÑ." }
                  },
                  required: ["start_line", "end_line", "new_code"]
                }
              }
            }));
            const modification = JSON.parse(response.text);
            const { start_line, end_line, new_code } = modification;
            let codeLines = currentCode.split('\n');
            if (codeLines.length === 1 && codeLines[0] === '') {
                codeLines = [];
            }
            const startIdx = start_line - 1;
            const endIdx = end_line - 1;
            const deleteCount = Math.max(0, endIdx - startIdx + 1);
            if (startIdx < -1 || startIdx > codeLines.length) {
               throw new Error(`AI provided an invalid start line: ${start_line}. File has ${codeLines.length} lines.`);
            }
            const newCodeLines = (new_code === null || new_code === undefined) ? [] : new_code.split('\n');
            // Highlight the lines that will be modified (after the change)
            let lastModifiedLines = [];
            if (newCodeLines.length > 0) {
              for (let l = 0; l < newCodeLines.length; l++) {
                lastModifiedLines.push(startIdx + 1 + l);
              }
            }
            codeLines.splice(startIdx, deleteCount, ...newCodeLines);
            currentCode = codeLines.join('\n');
            updateCodeAndView(currentCode, lastModifiedLines);
            addCodeToHistory(currentCode);
            updateTaskStatus(i, 'completed');
            completedTasks++;
            taskCounter.textContent = `${completedTasks} / ${plan.tasks.length}`;
          } catch (err) {
            updateTaskStatus(i, 'failed', err.message);
            _createMessageElement('ŸÅÿ¥ŸÑ ÿ™ŸÜŸÅŸäÿ∞ ÿÆÿ∑Ÿàÿ© ÿ™ÿ∑ŸàŸäÿ± ÿ∞ÿßÿ™Ÿä: ' + err.message, 'ai');
            stopSelfImprove = true;
            break;
          }
        }
        round++;
        await new Promise(res => setTimeout(res, 500));
      }
      selfImproveBtn.disabled = false;
      selfImproveBtn.textContent = 'ÿ™ÿ∑ŸàŸäÿ± ÿ∞ÿßÿ™Ÿä';
    });
    // ÿ≤ÿ± ŸÑÿ•ŸäŸÇÿßŸÅ ÿßŸÑÿ™ÿ∑ŸàŸäÿ± ÿßŸÑÿ∞ÿßÿ™Ÿä (ŸäŸÖŸÉŸÜŸÉ ÿ™ÿ≠ÿ≥ŸäŸÜŸá ŸÑÿßÿ≠ŸÇÿßŸã)
    selfImproveBtn.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      stopSelfImprove = true;
      selfImproveBtn.disabled = false;
      selfImproveBtn.textContent = 'ÿ™ÿ∑ŸàŸäÿ± ÿ∞ÿßÿ™Ÿä';
      _createMessageElement('ÿ™ŸÖ ÿ•ŸäŸÇÿßŸÅ ÿßŸÑÿ™ÿ∑ŸàŸäÿ± ÿßŸÑÿ∞ÿßÿ™Ÿä.', 'ai');
      taskProgressContainer.style.display = 'none';
    });



    // ÿØÿßŸÑÿ© ŸÑÿ≠ÿ∞ŸÅ ÿ±ÿ≥ÿßÿ¶ŸÑ ÿßŸÑÿ™ÿ∑ŸàŸäÿ± ÿßŸÑÿ∞ÿßÿ™Ÿä ÿßŸÑÿ≥ÿßÿ®ŸÇÿ© ŸÖŸÜ ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿ©
    function clearSelfImproveMessages() {
      const session = sessions[currentSessionId];
      if (!session) return;
      // ÿßÿ≠ÿ∞ŸÅ ŸÉŸÑ ÿ±ÿ≥ÿßŸÑÿ© AI ÿ™ÿ≠ÿ™ŸàŸä ÿπŸÑŸâ 'ÿ¨ŸàŸÑÿ© ÿ™ÿ∑ŸàŸäÿ± ÿ∞ÿßÿ™Ÿä' ÿ£Ÿà 'ÿßŸÑŸÉŸàÿØ ÿ®ÿπÿØ ÿ™ÿ∑ŸàŸäÿ± ÿßŸÑÿÆÿ∑Ÿàÿ©' ÿ£Ÿà 'ÿßŸÜÿ™ŸáŸâ ÿßŸÑÿ™ÿ∑ŸàŸäÿ± ÿßŸÑÿ∞ÿßÿ™Ÿä.'
      session.messages = session.messages.filter(m => {
        if (m.sender !== 'ai') return true;
        if (/ÿ¨ŸàŸÑÿ© ÿ™ÿ∑ŸàŸäÿ± ÿ∞ÿßÿ™Ÿä|ÿßŸÑŸÉŸàÿØ ÿ®ÿπÿØ ÿ™ÿ∑ŸàŸäÿ± ÿßŸÑÿÆÿ∑Ÿàÿ©|ÿßŸÜÿ™ŸáŸâ ÿßŸÑÿ™ÿ∑ŸàŸäÿ± ÿßŸÑÿ∞ÿßÿ™Ÿä|ŸÅÿ¥ŸÑ ÿ™ŸÜŸÅŸäÿ∞ ÿÆÿ∑Ÿàÿ© ÿ™ÿ∑ŸàŸäÿ± ÿ∞ÿßÿ™Ÿä|ŸÅÿ¥ŸÑ ŸÅŸä ÿ™ŸàŸÑŸäÿØ ÿÆÿ∑ÿ© ÿ™ÿ∑ŸàŸäÿ± ÿ∞ÿßÿ™Ÿä|ÿ™ŸÖ ÿ•ŸäŸÇÿßŸÅ ÿßŸÑÿ™ÿ∑ŸàŸäÿ± ÿßŸÑÿ∞ÿßÿ™Ÿä/.test(m.text)) return false;
        return true;
      });
      saveState();
      renderCurrentSession();
    }

    function renderChatList() {
      // Render sidebar chat list
      chatListSidebarList.innerHTML = '';
      const sessionIds = Object.keys(sessions);
      if (sessionIds.length === 0) return;
      sessionIds.forEach(sessionId => {
        const session = sessions[sessionId];
        let title = session.title || 'ÿØÿ±ÿØÿ¥ÿ© ÿ¨ÿØŸäÿØÿ©';
        if (!session.title) {
          for (const msg of session.messages) {
            if (msg.sender === 'user' && msg.text.trim()) {
              title = msg.text.trim().slice(0, 24) + (msg.text.trim().length > 24 ? '‚Ä¶' : '');
              break;
            }
          }
        }
        const item = document.createElement('button');
        item.className = 'chat-list-item' + (sessionId === currentSessionId ? ' active' : '');
        item.innerHTML = `<svg class="chat-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg> <span>${title}</span>`;
        item.onclick = () => {
          if (currentSessionId !== sessionId) {
            currentSessionId = sessionId;
            renderCurrentSession();
            renderChatList();
            saveState();
          }
          closeChatListSidebar();
        };
        chatListSidebarList.appendChild(item);
      });
    }
    function openChatListSidebar() {
      chatListSidebar.classList.add('open');
      chatListOverlay.style.display = 'block';
    }
    function closeChatListSidebar() {
      chatListSidebar.classList.remove('open');
      chatListOverlay.style.display = 'none';
    }
    chatListToggleBtn.addEventListener('click', openChatListSidebar);
    chatListSidebarClose.addEventListener('click', closeChatListSidebar);
    chatListOverlay.addEventListener('click', closeChatListSidebar);
    chatListNewBtn.addEventListener('click', () => {
      console.log('ÿ™ŸÖ ÿßŸÑÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿ≤ÿ± ÿØÿ±ÿØÿ¥ÿ© ÿ¨ÿØŸäÿØÿ© ŸÅŸä ÿßŸÑÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ¨ÿßŸÜÿ®Ÿä');
      startNewChat();
      closeChatListSidebar();
    });

    deleteChatsBtn.addEventListener('click', () => {
      if (confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ÿ£ŸÜŸÉ ÿ™ÿ±ŸäÿØ ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑÿØÿ±ÿØÿ¥ÿßÿ™ÿü ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ.')) {
        sessions = {};
        currentSessionId = null;
        saveState();
        startNewChat();
        renderChatList();
        closeChatListSidebar();
      }
    });

    // Ÿàÿ∏ÿßÿ¶ŸÅ ÿßŸÑÿ£ÿØŸàÿßÿ™ ÿßŸÑŸÖÿ™ÿÆÿµÿµÿ©
    function toggleToolsMenu() {
      const isVisible = toolsMenu.style.display !== 'none';
      toolsMenu.style.display = isVisible ? 'none' : 'block';
      toolsBtn.classList.toggle('active', !isVisible);
    }
    
    function selectTool(mode) {
      currentMode = mode;
      toolsMenu.style.display = 'none';
      toolsBtn.classList.remove('active');
      
      const modeTexts = {
        'self-development': 'ÿ™ÿ∑ŸàŸäÿ± ÿ∞ÿßÿ™Ÿä üöÄ',
        'deep-thinking': 'ÿ™ŸÅŸÉŸäÿ± ÿπŸÖŸäŸÇ üß†',
        'code-research': 'ÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑŸÉŸàÿØ üîç',
        'bug-hunter': 'ŸÖÿ∑ÿßÿ±ÿØ ÿßŸÑÿ£ÿÆÿ∑ÿßÿ° üêõ',
        'performance-optimizer': 'ŸÖÿ≠ÿ≥ŸÜ ÿßŸÑÿ£ÿØÿßÿ° ‚ö°',
        'creative-mode': 'Ÿàÿ∂ÿπ ÿ•ÿ®ÿØÿßÿπŸä üé®',
        'normal': 'Ÿàÿ∂ÿπ ÿπÿßÿØŸä'
      };
      
      const modePrompts = {
        'self-development': 'ŸÇŸÖ ÿ®ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ™ÿ∑ŸàŸäÿ± ÿßŸÑÿ∞ÿßÿ™Ÿä',
        'deep-thinking': 'ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ™ŸÅŸÉŸäÿ± ÿßŸÑÿπŸÖŸäŸÇ ŸÑÿ™ÿ≠ŸÑŸäŸÑ',
        'code-research': 'ÿßÿ®ÿ≠ÿ´ Ÿàÿ≠ŸÑŸÑ ÿßŸÑŸÉŸàÿØ',
        'bug-hunter': 'ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑÿ£ÿÆÿ∑ÿßÿ° Ÿàÿ£ÿµŸÑÿ≠Ÿáÿß',
        'performance-optimizer': 'ÿ≠ÿ≥ŸÜ ÿ£ÿØÿßÿ° ÿßŸÑŸÉŸàÿØ',
        'creative-mode': 'ÿ£ÿ®ÿØÿπ ŸÅŸä ÿßŸÑÿ≠ŸÑ',
        'normal': 'ÿßÿ≥ÿ£ŸÑ ÿπŸÜ ÿ£Ÿä ÿ¥Ÿäÿ°...'
      };
      
      // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿ§ÿ¥ÿ± ŸàÿßŸÑŸÜÿµ
      if (mode === 'normal') {
        activeToolIndicator.style.display = 'none';
        promptInput.placeholder = 'ÿßÿ≥ÿ£ŸÑ ÿπŸÜ ÿ£Ÿä ÿ¥Ÿäÿ°...';
      } else {
        activeToolIndicator.style.display = 'flex';
        toolIndicatorText.textContent = modeTexts[mode];
        promptInput.placeholder = modePrompts[mode];
        promptInput.focus();
      }
      
      // ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑÿπŸÜÿßÿµÿ± ŸÅŸä ÿßŸÑŸÇÿßÿ¶ŸÖÿ©
      document.querySelectorAll('.tool-item').forEach(item => {
        item.classList.toggle('active', item.dataset.mode === mode);
      });
    }
    
    function getColorForMode(mode) {
      const colors = {
        'self-development': '#f59e0b, #d97706',
        'deep-thinking': '#7c3aed, #6d28d9',
        'code-research': '#06b6d4, #0891b2',
        'bug-hunter': '#ef4444, #dc2626',
        'performance-optimizer': '#10b981, #059669',
        'creative-mode': '#ec4899, #db2777'
      };
      return colors[mode] || '#7c3aed, #6d28d9';
    }
    
    // ÿ™ÿ≠ÿ≥ŸäŸÜ ÿØÿßŸÑÿ© executeTaskPlan ÿ®ŸÜÿßÿ° ÿπŸÑŸâ ÿßŸÑŸàÿ∂ÿπ ÿßŸÑŸÖÿ≠ÿØÿØ
    async function executeAdvancedTaskPlan(tasks, prompt, mode) {
      const modePrompts = {
        'deep-thinking': 'ÿ£ŸÜÿ™ ÿÆÿ®Ÿäÿ± ŸÖÿ™ÿÆÿµÿµ ŸÅŸä ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿπŸÖŸäŸÇ. ŸÇŸÖ ÿ®ÿ™ÿ≠ŸÑŸäŸÑ ŸÉŸÑ ÿÆÿ∑Ÿàÿ© ÿ®ÿπŸÖŸÇ ÿ¥ÿØŸäÿØ ŸàÿßŸÇÿ™ÿ±ÿ≠ ÿ£ŸÅÿ∂ŸÑ ÿßŸÑÿ≠ŸÑŸàŸÑ.',
        'bug-hunter': 'ÿ£ŸÜÿ™ ÿÆÿ®Ÿäÿ± ŸÅŸä ÿßŸÉÿ™ÿ¥ÿßŸÅ ÿßŸÑÿ£ÿÆÿ∑ÿßÿ°. ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ÿ£Ÿä ŸÖÿ¥ÿßŸÉŸÑ ŸÖÿ≠ÿ™ŸÖŸÑÿ© ŸÅŸä ŸÉŸÑ ÿÆÿ∑Ÿàÿ© Ÿàÿ£ÿµŸÑÿ≠Ÿáÿß.',
        'performance-optimizer': 'ÿ£ŸÜÿ™ ÿÆÿ®Ÿäÿ± ŸÅŸä ÿ™ÿ≠ÿ≥ŸäŸÜ ÿßŸÑÿ£ÿØÿßÿ°. ÿ±ŸÉÿ≤ ÿπŸÑŸâ ÿ™ÿ≠ÿ≥ŸäŸÜ ÿ≥ÿ±ÿπÿ© ŸàŸÉŸÅÿßÿ°ÿ© ÿßŸÑŸÉŸàÿØ ŸÅŸä ŸÉŸÑ ÿÆÿ∑Ÿàÿ©.',
        'creative-mode': 'ÿ£ŸÜÿ™ ÿÆÿ®Ÿäÿ± ÿ•ÿ®ÿØÿßÿπŸä. ÿßŸÇÿ™ÿ±ÿ≠ ÿ≠ŸÑŸàŸÑÿßŸã ŸÖÿ®ÿ™ŸÉÿ±ÿ© Ÿàÿ¨ŸÖŸäŸÑÿ© ŸÅŸä ŸÉŸÑ ÿÆÿ∑Ÿàÿ©.',
        'code-research': 'ÿ£ŸÜÿ™ ÿ®ÿßÿ≠ÿ´ ŸÅŸä ÿßŸÑŸÉŸàÿØ. ÿßÿ¥ÿ±ÿ≠ ŸÉŸÑ ÿ¨ÿ≤ÿ° ÿ®ÿ™ŸÅÿµŸäŸÑ ŸàŸÇÿØŸÖ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ¥ÿßŸÖŸÑÿ©.',
        'self-development': 'ÿ£ŸÜÿ™ ŸÜÿ∏ÿßŸÖ ÿ™ÿ∑ŸàŸäÿ± ÿ∞ÿßÿ™Ÿä. ÿ≠ÿ≥ŸÜ ÿßŸÑŸÉŸàÿØ ÿ®ÿßÿ≥ÿ™ŸÖÿ±ÿßÿ± ŸàÿßŸÇÿ™ÿ±ÿ≠ ÿ™ÿ∑ŸàŸäÿ±ÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ©.'
      };
      
      const specialPrompt = modePrompts[mode] || '';
      
      // ÿ•ÿ∂ÿßŸÅÿ© ÿ±ÿ≥ÿßŸÑÿ© ÿ™ÿ¥Ÿäÿ± ÿ•ŸÑŸâ ÿßŸÑŸàÿ∂ÿπ ÿßŸÑŸÖÿÆÿ™ÿßÿ±
      _createMessageElement(`üéØ ÿ™ŸÖ ÿ™ŸÜÿ¥Ÿäÿ∑ ${mode === 'deep-thinking' ? 'ÿßŸÑÿ™ŸÅŸÉŸäÿ± ÿßŸÑÿπŸÖŸäŸÇ' : 
                           mode === 'bug-hunter' ? 'ŸÖÿ∑ÿßÿ±ÿØ ÿßŸÑÿ£ÿÆÿ∑ÿßÿ°' : 
                           mode === 'performance-optimizer' ? 'ŸÖÿ≠ÿ≥ŸÜ ÿßŸÑÿ£ÿØÿßÿ°' : 
                           mode === 'creative-mode' ? 'ÿßŸÑŸàÿ∂ÿπ ÿßŸÑÿ•ÿ®ÿØÿßÿπŸä' : 
                           mode === 'code-research' ? 'ÿßŸÑÿ®ÿßÿ≠ÿ´ ŸÅŸä ÿßŸÑŸÉŸàÿØ' : 
                           'ÿßŸÑÿ™ÿ∑ŸàŸäÿ± ÿßŸÑÿ∞ÿßÿ™Ÿä'}...`, 'ai');
      
      return executeTaskPlan(tasks, '', prompt, specialPrompt);
    }
    
    function init() {
      loadState();
      
      chatForm.addEventListener('submit', handleSendMessage);
      previewBtn.addEventListener('click', showPreview);
      applyBtn.addEventListener('click', applyChanges);
      closePreviewBtn.addEventListener('click', hidePreview);
      
      // ÿ£ÿ≠ÿØÿßÿ´ ÿßŸÑÿ£ÿØŸàÿßÿ™
      toolsBtn.addEventListener('click', toggleToolsMenu);
      
      // ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿπŸÜÿØ ÿßŸÑŸÜŸÇÿ± ÿÆÿßÿ±ÿ¨Ÿáÿß
      document.addEventListener('click', (e) => {
        if (!toolsBtn.contains(e.target) && !toolsMenu.contains(e.target)) {
          toolsMenu.style.display = 'none';
          toolsBtn.classList.remove('active');
        }
      });
      
      // ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑÿ£ÿØŸàÿßÿ™
      document.querySelectorAll('.tool-item').forEach(item => {
        item.addEventListener('click', () => {
          const mode = item.dataset.mode;
          selectTool(mode);
        });
      });
      
      // ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ£ÿØÿßÿ© ÿßŸÑŸÜÿ¥ÿ∑ÿ©
      clearToolBtn.addEventListener('click', () => {
        selectTool('normal');
      });

      undoBtn.addEventListener('click', undo);
      redoBtn.addEventListener('click', redo);

      // AI Discussion Modal events
      improveBtn.addEventListener('click', () => {
        aiDiscussionContent.innerHTML = '<div style="text-align:center; padding:2rem;">ÿ¨ÿßÿ±Ÿä ÿ®ÿØÿ° ÿßŸÑŸÜŸÇÿßÿ¥ ÿßŸÑÿ®ÿ±ŸÖÿ¨Ÿä ÿ®ŸäŸÜ ÿßŸÑÿ∞ŸÉÿßÿ°ŸäŸÜ ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸäŸäŸÜ...</div>';
        aiDiscussionModal.style.display = 'flex';
        applyImprovedBtn.style.display = 'none';
        stopDiscussionBtn.disabled = false;
        stopDiscussionBtn.textContent = 'ÿ•ŸäŸÇÿßŸÅ ÿßŸÑÿ¨ŸàŸÑÿßÿ™';
        startAIDiscussionLoop();
      });
      closeDiscussionBtn.addEventListener('click', () => {
        aiDiscussionModal.style.display = 'none';
      });
      stopDiscussionBtn.addEventListener('click', () => {
        stopAIDiscussion = true;
        stopDiscussionBtn.disabled = true;
        stopDiscussionBtn.textContent = 'ÿ™ŸÖ ÿßŸÑÿ•ŸäŸÇÿßŸÅ';
      });

      taskHeader.addEventListener('click', () => {
        taskProgressContainer.classList.toggle('collapsed');
      });
      
      promptInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            chatForm.requestSubmit();
        }
      });

      // Allow user to edit code manually
      codeDisplay.addEventListener('input', () => {
        const session = sessions[currentSessionId];
        if (!session) return;
        const newCode = codeDisplay.textContent;
        session.codeHistory[session.historyIndex] = newCode;
        saveState();
        hljs.highlightElement(codeDisplay); // ÿ•ÿπÿßÿØÿ© ÿ™ŸÑŸàŸäŸÜ ÿßŸÑŸÉŸàÿØ ÿ®ÿπÿØ ŸÉŸÑ ÿ™ÿπÿØŸäŸÑ ŸäÿØŸàŸä
      });
    }

    init();
  </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
