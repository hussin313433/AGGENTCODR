<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Code Editor</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/tomorrow-night-blue.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

  <style>
    :root {
      --bg-color: #0a0a0b;
      --panel-bg-color: #181821;
      --border-color: #2a2a36;
      --text-color: #e8e8f0;
      --primary-color: #7c3aed;
      --primary-hover-color: #6d28d9;
      --secondary-color: #06b6d4;
      --secondary-hover-color: #0891b2;
      --accent-color: #f59e0b;
      --accent-hover-color: #d97706;
      --input-bg-color: #1f1f2e;
      --header-bg-color: #131318;
      --button-bg-color: #2a2a36;
      --button-hover-bg-color: #3a3a48;
      --user-message-bg: linear-gradient(135deg, #7c3aed, #a855f7);
      --ai-message-bg: linear-gradient(135deg, #1f1f2e, #2a2a36);
      --task-bg-color: #1a1a24;
      --success-color: #10b981;
      --error-color: #ef4444;
      --warning-color: #f59e0b;
      --font-family: 'IBM Plex Sans Arabic', sans-serif;
      --font-mono: 'SF Mono', 'Fira Code', 'Menlo', monospace;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.6);
      --glass-bg: rgba(42, 42, 54, 0.8);
      --glass-border: rgba(255, 255, 255, 0.1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
      overflow: hidden;
    }

    body {
      background: linear-gradient(135deg, var(--bg-color) 0%, #0f0f1a 50%, var(--bg-color) 100%);
      color: var(--text-color);
      font-family: var(--font-family);
      display: flex;
      position: relative;
    }
    
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 20%, rgba(124, 58, 237, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(6, 182, 212, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 40% 60%, rgba(245, 158, 11, 0.05) 0%, transparent 50%);
      pointer-events: none;
      z-index: -1;
    }

    .app-container {
      display: flex;
      width: 100%;
      height: 100%;
    }

    .chat-panel, .editor-panel {
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .chat-panel {
      width: 40%;
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border-left: 1px solid var(--glass-border);
      padding: 0.75rem;
      gap: 0.75rem;
      position: relative;
    }
    
    .chat-panel::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--primary-color), transparent);
    }

    .editor-panel {
      width: 60%;
    }
    
    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border-color);
      gap: 0.5rem;
    }
    
    .panel-header h1 {
      font-size: 1.2rem;
      font-weight: 500;
      text-shadow: 0 0 8px rgba(0,0,0,0.5);
      flex: 1;
      text-align: center;
      margin: 0;
    }

    .header-icon-btn {
      background-color: var(--button-bg-color);
      border: 1px solid var(--border-color);
      color: var(--text-color);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      font-size: 1.5rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s ease;
    }
    .header-icon-btn:hover {
       background-color: var(--button-hover-bg-color);
    }
    
    .task-progress {
        background-color: var(--task-bg-color);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        flex-shrink: 0;
    }
    .task-header {
        padding: 0.75rem 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
    }
    .task-header > div {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-weight: 500;
    }
    .task-meta {
        display: flex;
        align-items: center;
        gap: 1rem;
        color: #888;
    }
    .chevron-icon {
        transition: transform 0.3s ease;
    }
    .task-progress.collapsed .chevron-icon {
        transform: rotate(-90deg);
    }
    .task-list {
        padding: 0 1rem 1rem 1rem;
        max-height: 500px;
        overflow: hidden;
        transition: max-height 0.3s ease, padding 0.3s ease;
    }
    .task-progress.collapsed .task-list {
        max-height: 0;
        padding-top: 0;
        padding-bottom: 0;
    }
    .task-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.5rem 0.5rem;
        color: #a0a0a0;
    }
    .task-icon {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
    }
    .task-icon .check-icon { color: var(--success-color); }
    .task-icon .error-icon { color: var(--error-color); }
    .task-icon .spinner {
       width: 16px; height: 16px;
       border: 2px solid rgba(255,255,255,0.3);
       border-top-color: var(--primary-color);
    }


    .messages-container {
      flex-grow: 1;
      overflow-y: auto;
      padding: 1rem;
    }
    
    .message {
      padding: 1rem 1.25rem;
      border-radius: 16px;
      margin-bottom: 1rem;
      max-width: 85%;
      line-height: 1.6;
      white-space: pre-wrap;
      position: relative;
      box-shadow: var(--shadow-sm);
      transition: all 0.3s ease;
    }

    .message:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .message.user {
      background: var(--user-message-bg);
      color: white;
      align-self: flex-start;
      margin-left: auto;
      border-bottom-left-radius: 6px;
    }

    .message.user::before {
      content: '';
      position: absolute;
      bottom: 0;
      right: -8px;
      width: 0;
      height: 0;
      border: 8px solid transparent;
      border-left-color: #a855f7;
      border-bottom: none;
    }

    .message.ai {
      background: var(--ai-message-bg);
      border: 1px solid var(--border-color);
      align-self: flex-end;
      margin-right: auto;
      border-bottom-right-radius: 6px;
    }

    .message.ai::before {
      content: '';
      position: absolute;
      bottom: 0;
      left: -8px;
      width: 0;
      height: 0;
      border: 8px solid transparent;
      border-right-color: var(--ai-message-bg);
      border-bottom: none;
    }
    
    .message.loading {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .spinner {
      width: 20px; height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: var(--primary-color);
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    #chat-form {
      border-top: 1px solid var(--border-color);
      background: var(--glass-bg);
      backdrop-filter: blur(12px);
      padding: 1rem;
      flex-shrink: 0;
      position: relative;
    }

    .input-bar {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      background: var(--input-bg-color);
      border: 2px solid var(--border-color);
      border-radius: 50px;
      padding: 0.5rem;
      transition: all 0.3s ease;
      box-shadow: var(--shadow-sm);
    }

    .input-bar:focus-within {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
    }

    .tools-button {
      background: var(--button-bg-color);
      color: var(--text-color);
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      flex-shrink: 0;
    }

    .tools-button:hover {
      background: var(--primary-color);
      color: white;
      transform: rotate(90deg);
    }

    .tools-button.active {
      background: var(--primary-color);
      color: white;
    }

    .input-wrapper {
      flex: 1;
      position: relative;
    }

    .active-tool-indicator {
      position: absolute;
      top: -28px;
      left: 0;
      right: 0;
      background: var(--primary-color);
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: var(--shadow-sm);
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .clear-tool-btn {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 1rem;
      padding: 0;
      margin-left: 0.5rem;
      opacity: 0.8;
      transition: opacity 0.2s ease;
    }

    .clear-tool-btn:hover {
      opacity: 1;
    }

    #prompt-input {
      width: 100%;
      background: transparent;
      color: var(--text-color);
      border: none;
      padding: 0.75rem 1rem;
      font-family: inherit;
      font-size: 1rem;
      outline: none;
    }

    #prompt-input::placeholder {
      color: #888;
    }

    #send-button {
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      flex-shrink: 0;
    }

    #send-button:hover {
      background: var(--primary-hover-color);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    #send-button:disabled {
      background: var(--button-bg-color);
      cursor: not-allowed;
      transform: none;
    }

    /* Compact Tools Menu */
    .tools-menu {
      position: absolute;
      bottom: 60px;
      left: 0.5rem;
      background: var(--panel-bg-color);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      box-shadow: var(--shadow-xl);
      backdrop-filter: blur(16px);
      z-index: 1000;
      min-width: 200px;
      overflow: hidden;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .tool-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      border-bottom: 1px solid var(--border-color);
    }

    .tool-item:last-child {
      border-bottom: none;
    }

    .tool-item:hover {
      background: var(--button-bg-color);
    }

    .tool-item.active {
      background: var(--primary-color);
      color: white;
    }

    .tool-emoji {
      font-size: 1.2rem;
      width: 24px;
      text-align: center;
      flex-shrink: 0;
    }

    .tool-text {
      font-size: 0.9rem;
      font-weight: 500;
    }

    .tool-divider {
      height: 1px;
      background: var(--border-color);
      margin: 0.25rem 0;
    }

    .editor-header {
      display: flex; justify-content: space-between;
      align-items: center; padding: 0.75rem 1rem;
      background-color: #1e1e1e; flex-shrink: 0;
    }

    .editor-header h2 { font-size: 1rem; font-weight: 500; }
    .editor-toolbar { display: flex; gap: 0.5rem; align-items: center; }

    .editor-toolbar button {
      background-color: var(--button-bg-color);
      border: 1px solid var(--border-color);
      color: var(--text-color); padding: 0.5rem 1rem;
      border-radius: 5px; cursor: pointer;
      transition: background-color 0.2s ease;
      font-family: inherit; display: flex;
      align-items: center; gap: 0.5rem;
    }

    .editor-toolbar button:hover { background-color: var(--button-hover-bg-color); }
    .editor-toolbar button:disabled { background-color: #333; color: #777; cursor: not-allowed; border-color: #444; }
    .editor-toolbar button#apply-btn { background-color: var(--primary-color); color: white; }
    .editor-toolbar button#apply-btn:hover { background-color: var(--primary-hover-color); }

    .editor-content {
      flex-grow: 1;
      overflow: auto;
      background-color: #1e1e1e;
      display: flex;
      direction: ltr;
    }
    
    .line-numbers-gutter {
        flex-shrink: 0;
        padding: 1rem;
        font-family: var(--font-mono);
        font-size: 14px;
        line-height: 1.5;
        color: #888;
        text-align: right;
        user-select: none;
        background-color: var(--panel-bg-color);
        border-right: 1px solid var(--border-color);
    }

    #code-display {
      padding: 1rem;
      white-space: pre;
      font-family: var(--font-mono);
      font-size: 14px;
      line-height: 1.5;
      outline: none;
      flex-grow: 1;
    }
    
    .modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex; align-items: center; justify-content: center;
      z-index: 1000;
    }

    .modal-content {
      background-color: var(--bg-color);
      width: 90%; height: 90%;
      border-radius: 8px; display: flex; flex-direction: column;
      box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    }

    .modal-header {
      padding: 0.5rem 1rem; display: flex;
      justify-content: flex-end; background-color: var(--header-bg-color);
      border-bottom: 1px solid var(--border-color);
      border-top-left-radius: 8px; border-top-right-radius: 8px;
    }

    #close-preview-btn {
      background: none; border: none;
      color: var(--text-color); font-size: 1.5rem; cursor: pointer;
    }

    #preview-frame {
      width: 100%; height: 100%; border: none;
      flex-grow: 1; border-bottom-left-radius: 8px; border-bottom-right-radius: 8px;
    }
    
    /* Custom Highlight.js theme overrides to match image */
    #code-display.hljs {
      background: var(--bg-color);
      color: var(--text-color);
    }
    .hljs-comment {
      color: #7f848e;
    }
    .hljs-selector-tag,
    .hljs-selector-class,
    .hljs-selector-id {
      color: #98c379; /* Green for selectors */
    }
    .hljs-attribute {
      color: #56c4d8; /* Cyan for properties */
    }
    .hljs-number,
    .hljs-string,
    .hljs-literal,
    .hljs-attr { /* attr is for HTML attributes */
      color: #e5c07b; /* Orange for values and attributes */
    }
    .hljs-built_in {
      color: #56c4d8; /* Cyan for built-ins like var() */
    }
    .hljs-name, /* For HTML/XML tags */
    .hljs-tag {
      color: #e06c75; /* Soft red for tags */
    }
    .hljs-keyword {
      color: #c678dd; /* Purple for keywords */
    }
    .highlight-modified {
      background: rgba(52, 211, 153, 0.18); /* شفافة أخضر */
      transition: background 0.5s;
    }
    .ai-step-code {
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      color: #e8e8f0;
      padding: 1.25rem;
      border-radius: 0 0 12px 12px;
      border: 1px solid var(--border-color);
      border-top: none;
      font-family: var(--font-mono);
      font-size: 14px;
      max-height: 300px;
      overflow: auto;
      margin: 0;
      direction: ltr;
      white-space: pre;
      position: relative;
      box-shadow: var(--shadow-lg);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
      line-height: 1.6;
    }
    
    .ai-step-code:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-xl);
      border-color: var(--primary-color);
    }
    
    .ai-step-code::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color), var(--accent-color));
      border-radius: 12px 12px 0 0;
    }
    
    .step-result-container {
      background: var(--ai-message-bg);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 1rem;
      margin: 1rem 0;
      position: relative;
      box-shadow: var(--shadow-md);
    }
    
    .step-result-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid var(--border-color);
    }
    
    .step-result-icon {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--success-color), #10b981);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1rem;
      flex-shrink: 0;
    }
    
    .step-result-title {
      font-weight: 600;
      color: var(--success-color);
      font-size: 1rem;
    }
    
    .step-result-description {
      color: #888;
      font-size: 0.9rem;
      margin-top: 0.25rem;
    }
    
    .code-preview-actions {
      display: flex;
      gap: 0.5rem;
      margin: 1rem 0 0.5rem 0;
      justify-content: flex-start;
    }
    
    .code-action-btn {
      background: var(--button-bg-color);
      border: 1px solid var(--border-color);
      color: var(--text-color);
      padding: 0.5rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .code-action-btn:hover {
      background: var(--button-hover-bg-color);
      transform: translateY(-1px);
    }
    
    .code-action-btn.primary {
      background: var(--primary-color);
      color: white;
    }
    
    .code-action-btn.primary:hover {
      background: var(--primary-hover-color);
    }
    
    .code-container {
      position: relative;
    }
    
    .code-stats {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--glass-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px 8px 0 0;
      padding: 0.5rem 1rem;
      font-size: 0.8rem;
      color: #888;
      font-family: var(--font-mono);
    }
    
    .lines-count, .chars-count {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    
    .lines-count::before {
      content: '📄';
      font-size: 0.9rem;
    }
    
    .chars-count::before {
      content: '📝';
      font-size: 0.9rem;
    }
    
    /* Diff View Styles */
    .diff-container {
      background: var(--panel-bg-color);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      overflow: hidden;
      margin: 1rem 0;
      box-shadow: var(--shadow-lg);
    }
    
    .diff-header {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 0.75rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-family: var(--font-mono);
      font-size: 0.9rem;
    }
    
    .diff-stats {
      display: flex;
      gap: 1rem;
      align-items: center;
    }
    
    .diff-stat {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      font-weight: 600;
    }
    
    .additions {
      color: #22c55e;
    }
    
    .deletions {
      color: #ef4444;
    }
    
    .diff-toggle {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: background 0.2s ease;
    }
    
    .diff-toggle:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    .diff-content {
      max-height: 400px;
      overflow: auto;
      font-family: var(--font-mono);
      font-size: 14px;
      line-height: 1.4;
      direction: ltr;
    }
    
    .diff-line {
      display: flex;
      min-height: 20px;
      padding: 0;
      margin: 0;
      border: none;
      width: 100%;
    }
    
    .line-number {
      background: var(--panel-bg-color);
      color: #666;
      padding: 0.125rem 0.5rem;
      min-width: 50px;
      text-align: right;
      border-right: 1px solid var(--border-color);
      user-select: none;
      flex-shrink: 0;
      font-size: 12px;
    }
    
    .line-content {
      padding: 0.125rem 0.75rem;
      flex: 1;
      white-space: pre;
      min-height: 20px;
      overflow-x: auto;
    }
    
    .diff-line.added {
      background: rgba(34, 197, 94, 0.15);
      border-left: 3px solid #22c55e;
    }
    
    .diff-line.added .line-number {
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
    }
    
    .diff-line.removed {
      background: rgba(239, 68, 68, 0.15);
      border-left: 3px solid #ef4444;
    }
    
    .diff-line.removed .line-number {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }
    
    .diff-line.context {
      background: var(--bg-color);
    }
    
    .diff-line.context .line-number {
      color: #666;
    }
    
    .diff-line-indicator {
      width: 20px;
      padding: 0.125rem 0;
      text-align: center;
      font-weight: bold;
      flex-shrink: 0;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .diff-line.added .diff-line-indicator {
      background: rgba(34, 197, 94, 0.3);
      color: #22c55e;
    }
    
    .diff-line.added .diff-line-indicator::before {
      content: '+';
      font-weight: bold;
    }
    
    .diff-line.removed .diff-line-indicator {
      background: rgba(239, 68, 68, 0.3);
      color: #ef4444;
    }
    
    .diff-line.removed .diff-line-indicator::before {
      content: '−';
      font-weight: bold;
    }
    
    .diff-line.context .diff-line-indicator {
      background: var(--panel-bg-color);
      color: #666;
    }
    
    .diff-line.context .diff-line-indicator::before {
      content: ' ';
    }
    
    /* Responsive diff view */
    @media (max-width: 768px) {
      .diff-content {
        font-size: 12px;
      }
      
      .line-number {
        min-width: 35px;
        font-size: 10px;
      }
      
      .diff-line-indicator {
        width: 15px;
        font-size: 10px;
      }
    }
    
    /* Horizontal scroll for long lines */
    .diff-content::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    .diff-content::-webkit-scrollbar-track {
      background: var(--panel-bg-color);
    }
    
    .diff-content::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 4px;
    }
    
    .diff-content::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
    
    /* General modern enhancements */
    html {
      scroll-behavior: smooth;
    }

    /* Custom Scrollbar Styles */
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }

    ::-webkit-scrollbar-track {
      background: var(--panel-bg-color);
      border-radius: 5px;
    }

    ::-webkit-scrollbar-thumb {
      background: #555;
      border-radius: 5px;
      border: 2px solid var(--panel-bg-color);
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #777;
    }
    
    /* Scrollbar خاص بمربع الكود */
    .ai-step-code::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    .ai-step-code::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }

    .ai-step-code::-webkit-scrollbar-thumb {
      background: var(--primary-color);
      border-radius: 4px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .ai-step-code::-webkit-scrollbar-thumb:hover {
      background: var(--primary-hover-color);
    }

    /* Better focus outline for accessibility and aesthetics */
    :focus-visible {
      outline: 2px solid var(--primary-color);
      outline-offset: 2px;
      border-radius: 3px; /* So it applies nicely to various shapes */
    }

    /* Selection highlight color */
    ::selection {
      background-color: var(--primary-color);
      color: white;
    }

    /* Enhance inputs and textareas */
    #prompt-input,
    #code-display[contenteditable="true"] {
      border: 1px solid var(--border-color);
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    #prompt-input:focus,
    #code-display[contenteditable="true"]:focus {
      border-color: var(--primary-color);
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3), 0 0 0 1px var(--primary-color);
    }

    /* Enhance buttons */
    button {
      transition: background-color 0.2s ease, transform 0.1s ease;
    }

    button:active {
      transform: translateY(1px);
    }

    /* Panel and container styling for depth */
    .chat-panel,
    .task-progress,
    .modal-content {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .modal-content {
      border: 1px solid var(--border-color);
    }
    .chat-list {
      margin: 0.5rem 0 0.5rem 0;
      background: var(--panel-bg-color);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      max-height: 180px;
      overflow-y: auto;
      padding: 0.25rem 0.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    .chat-list-item {
      padding: 0.5rem 0.75rem;
      border-radius: 6px;
      cursor: pointer;
      color: var(--text-color);
      background: none;
      border: none;
      text-align: right;
      font-family: inherit;
      font-size: 1rem;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .chat-list-item.active {
      background: var(--primary-color);
      color: #fff;
      font-weight: bold;
    }
    .chat-list-item:hover:not(.active) {
      background: #333;
    }
    .chat-list-item .chat-icon {
      width: 18px;
      height: 18px;
      color: var(--primary-color);
      flex-shrink: 0;
    }
    .chat-list-overlay {
      position: fixed;
      top: 0; right: 0; bottom: 0; left: 0;
      background: rgba(0,0,0,0.35);
      z-index: 2000;
      display: none;
    }
    .chat-list-sidebar {
      position: fixed;
      top: 0; right: 0;
      width: 340px;
      max-width: 100vw;
      height: 100vh;
      background: var(--panel-bg-color);
      border-left: 1px solid var(--border-color);
      box-shadow: -2px 0 16px rgba(0,0,0,0.18);
      z-index: 2100;
      display: flex;
      flex-direction: column;
      transform: translateX(100%);
      transition: transform 0.3s cubic-bezier(.4,1.4,.6,1);
    }
    .chat-list-sidebar.open {
      transform: translateX(0);
    }
    .chat-list-sidebar-header {
      padding: 1rem 1.5rem 0.5rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border-color);
      background: var(--panel-bg-color);
    }
    .chat-list-sidebar-header h2 {
      font-size: 1.1rem;
      font-weight: 600;
      margin: 0;
      color: var(--primary-color);
    }
    .chat-list-sidebar-close {
      background: none;
      border: none;
      color: var(--text-color);
      font-size: 1.7rem;
      cursor: pointer;
      padding: 0 0.5rem;
    }
    .chat-list-sidebar-list {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem 1rem 1rem 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    .chat-list-item {
      padding: 0.5rem 0.75rem;
      border-radius: 6px;
      cursor: pointer;
      color: var(--text-color);
      background: none;
      border: none;
      text-align: right;
      font-family: inherit;
      font-size: 1rem;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .chat-list-item.active {
      background: var(--primary-color);
      color: #fff;
      font-weight: bold;
    }
    .chat-list-item:hover:not(.active) {
      background: #333;
    }
    .chat-list-item .chat-icon {
      width: 18px;
      height: 18px;
      color: var(--primary-color);
      flex-shrink: 0;
    }
    .chat-list-new-btn {
      margin: 1rem 1rem 0.5rem 1rem;
      background: var(--primary-color);
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 0.5rem 1.5rem;
      font-size: 1rem;
      font-family: inherit;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .chat-list-new-btn:hover {
      background: var(--primary-hover-color);
    }
    @media (max-width: 500px) {
      .chat-list-sidebar { width: 100vw; }
    }
  </style>
<link rel="stylesheet" href="/index.css">
</head>
<body>
  <div class="app-container">
    <div class="chat-panel">
      <header class="panel-header">
        <div style="flex:1;"></div>
        <h1 style="text-align:center; margin:0;">مساعد الكود الذكي</h1>
        <div style="flex:1; display:flex; justify-content:flex-end;">
          <button id="chat-list-toggle-btn" class="header-icon-btn" title="عرض الدردشات">
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
          </button>
        </div>

      </header>
      <div id="chat-list-overlay" class="chat-list-overlay"></div>
      <aside id="chat-list-sidebar" class="chat-list-sidebar">
        <div class="chat-list-sidebar-header">
          <h2>الدردشات</h2>
          <button id="chat-list-sidebar-close" class="chat-list-sidebar-close" title="إغلاق">&times;</button>
        </div>

        <button id="chat-list-new-btn" class="chat-list-new-btn" style="margin:1rem 1rem 0.5rem 1rem; background:var(--primary-color); color:#fff; border:none; border-radius:6px; padding:0.5rem 1.5rem; font-size:1rem; font-family:inherit; font-weight:500; cursor:pointer; transition:background 0.2s; display:flex; align-items:center; gap:0.5rem;">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
          دردشة جديدة
        </button>
        <div id="chat-list-sidebar-list" class="chat-list-sidebar-list"></div>
        <button id="delete-chats-btn" style="background:#f87171; color:#fff; border:none; border-radius:6px; padding:0.5rem 1.5rem; font-size:1rem; font-family:inherit; font-weight:500; cursor:pointer; margin:1rem;">حذف جميع الدردشات</button>
      </aside>

      <div class="task-progress" id="task-progress-container" style="display: none;">
        <header class="task-header" id="task-header">
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="check-icon"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                <span id="task-title">خطة العمل</span>
            </div>
            <div class="task-meta">
                <span id="task-counter"></span>
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="chevron-icon"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </div>
        </header>
        <div class="task-list" id="task-list"></div>
      </div>

      <div class="messages-container" id="messages-container"></div>
            <form id="chat-form">
        <div class="input-bar">
          <button type="button" id="tools-btn" class="tools-button" title="الأدوات">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="3"></circle>
              <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
          </button>
          
          <div class="input-wrapper">
            <div id="active-tool-indicator" class="active-tool-indicator" style="display: none;">
              <span id="tool-indicator-text">الوضع العادي</span>
              <button type="button" id="clear-tool" class="clear-tool-btn">&times;</button>
            </div>
            <input type="text" id="prompt-input" placeholder="اسأل عن أي شيء..." />
          </div>
          
          <button type="submit" id="send-button">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="12" y1="19" x2="12" y2="5"></line>
              <polyline points="5 12 12 5 19 12"></polyline>
            </svg>
          </button>
        </div>
        
        <!-- Compact Tools Menu -->
        <div id="tools-menu" class="tools-menu" style="display: none;">
          <div class="tool-item" data-mode="self-development">
            <span class="tool-emoji">🚀</span>
            <span class="tool-text">تطوير ذاتي</span>
          </div>
          <div class="tool-item" data-mode="deep-thinking">
            <span class="tool-emoji">🧠</span>
            <span class="tool-text">تفكير عميق</span>
          </div>
          <div class="tool-item" data-mode="code-research">
            <span class="tool-emoji">🔍</span>
            <span class="tool-text">بحث في الكود</span>
          </div>
          <div class="tool-item" data-mode="bug-hunter">
            <span class="tool-emoji">🐛</span>
            <span class="tool-text">مطارد الأخطاء</span>
          </div>
          <div class="tool-item" data-mode="performance-optimizer">
            <span class="tool-emoji">⚡</span>
            <span class="tool-text">محسن الأداء</span>
          </div>
          <div class="tool-item" data-mode="creative-mode">
            <span class="tool-emoji">🎨</span>
            <span class="tool-text">وضع إبداعي</span>
          </div>
          <div class="tool-divider"></div>
          <div class="tool-item" data-mode="normal">
            <span class="tool-emoji">🔄</span>
            <span class="tool-text">وضع عادي</span>
          </div>
        </div>
      </form>
    </div>

    <div class="editor-panel">
      <header class="editor-header">
        <div class="editor-toolbar">
           <button id="undo-btn" title="رجوع">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 9H8a5 5 0 0 0-5 5v0a5 5 0 0 0 5 5h10"></path><polyline points="12 13 8 9 12 5"></polyline></svg>

            </button>
            <button id="redo-btn" title="تقدم">

                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9h13a5 5 0 0 1 5 5v0a5 5 0 0 1-5 5H5"></path><polyline points="12 5 16 9 12 13"></polyline></svg>
            </button>
             <div style="width:1px; height: 24px; background-color: var(--border-color); margin: 0 0.5rem;"></div>
          <button id="preview-btn" title="معاينة">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z"></path><circle cx="12" cy="12" r="3"></circle></svg>
          </button>
          <button id="improve-btn" title="تطوير">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3v2m6.364 1.636l-1.414 1.414M21 12h-2M17.364 17.364l-1.414-1.414M12 21v-2M6.636 17.364l1.414-1.414M3 12h2M6.636 6.636l1.414 1.414M12 8a4 4 0 1 1 0 8 4 4 0 0 1 0-8z"></path></svg>
          </button>
          <button id="self-improve-btn" title="تطوير ذاتي">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
          </button>
          <button id="apply-btn" title="تطبيق وإعادة تحميل">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
          </button>
        </div>
        <h2>محرر الكود</h2>
      </header>
      <div class="editor-content">
        <div id="line-numbers" class="line-numbers-gutter"></div>
        <pre id="code-display" class="language-html" contenteditable="true" tabindex="0"></pre>
      </div>
    </div>
  </div>

  <div id="preview-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <button id="close-preview-btn">&times;</button>
      </div>
      <iframe id="preview-frame" title="Live Preview"></iframe>
    </div>
  </div>

  <!-- Modal for AI Discussion -->
  <div id="ai-discussion-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 800px; max-height: 90vh;">
      <div class="modal-header">
        <button id="close-discussion-btn">&times;</button>
      </div>
      <div id="ai-discussion-content" style="flex:1; overflow-y:auto; padding:1rem; direction:ltr; background:var(--bg-color); color:var(--text-color); font-family:var(--font-mono); font-size:15px; border-radius:8px; min-height:200px;"></div>
      <div id="ai-discussion-actions" style="padding:1rem; text-align:left;">
        <button id="stop-discussion-btn" style="background:var(--error-color); color:white; border:none; border-radius:6px; padding:0.5rem 1.5rem; font-size:1rem; cursor:pointer; margin-left:0.5rem;">إيقاف الجولات</button>
        <button id="apply-improved-btn" style="display:none; background:var(--primary-color); color:white; border:none; border-radius:6px; padding:0.5rem 1.5rem; font-size:1rem; cursor:pointer;">اعتماد الكود المحسن</button>
      </div>
    </div>
  </div>

  <script type="importmap">
    {
      "imports": {
        "@google/genai": "https://esm.sh/@google/genai@^0.12.0"
      }
    }
  </script>
  <script type="module">
    import { GoogleGenAI, Type } from "@google/genai";

    // --- API KEYS ROTATION LOGIC ---
    const API_KEYS = [
      "AIzaSyBd6z7ru09s2hbI7c-9PrF34gjR9r4o5iE",
      "AIzaSyCYlSM0arXvt1GMnsUMIPrTF4T3U-jsxKI",
      "AIzaSyBA5fBhhxIRuJxG9kNPu1JQ8wLMce9p_bg",
      "AIzaSyCJhj0oJaRQeKudyDyvtSf-fz-xbpL-Mm8",
      "AIzaSyBQOFjawlE69tA4Nuuq_hpyX2KPMsXzXDw",
      "AIzaSyBJvsgVcIoJHPkoO8Ru1-maazHlS_efXUI"
    ];
    let apiKeyIndex = 0;
    function getNextApiKey() {
      const key = API_KEYS[apiKeyIndex];
      apiKeyIndex = (apiKeyIndex + 1) % API_KEYS.length;
      return key;
    }
    // دالة تغلف استدعاء GoogleGenAI وتعيد المحاولة تلقائياً عند ظهور خطأ quota
    async function callGenAI(fn) {
      let lastError;
      for (let i = 0; i < API_KEYS.length; i++) {
        const ai = new GoogleGenAI({ apiKey: getNextApiKey() });
        try {
          return await fn(ai);
        } catch (err) {
          lastError = err;
          if (err && err.message && /quota|exceeded|API key/i.test(err.message)) {
            continue; // جرب المفتاح التالي
          } else {
            throw err;
          }
        }
      }
      throw lastError || new Error("All API keys quota exceeded or failed.");
    }

    const API_KEY = "AIzaSyCYlSM0arXvt1GMnsUMIPrTF4T3U-jsxKI";
    if (!API_KEY) {
        document.body.innerHTML = `<div style="color:red; padding: 2rem; text-align: right; font-size: 1.2rem;">خطأ: متغير البيئة API_KEY غير معين. لا يمكن بدء تشغيل التطبيق.</div>`;
        throw new Error("API key not found");
    }
    const ai = new GoogleGenAI({ apiKey: API_KEY });

    // DOM Elements
    const codeDisplay = document.getElementById('code-display');
    const lineNumbersGutter = document.getElementById('line-numbers');
    const messagesContainer = document.getElementById('messages-container');
    const chatForm = document.getElementById('chat-form');
    const promptInput = document.getElementById('prompt-input');
    const sendButton = document.getElementById('send-button');
    const toolsBtn = document.getElementById('tools-btn');
    const toolsMenu = document.getElementById('tools-menu');
    const activeToolIndicator = document.getElementById('active-tool-indicator');
    const toolIndicatorText = document.getElementById('tool-indicator-text');
    const clearToolBtn = document.getElementById('clear-tool');
    const previewBtn = document.getElementById('preview-btn');
    const improveBtn = document.getElementById('improve-btn');
    const selfImproveBtn = document.getElementById('self-improve-btn');
    const applyBtn = document.getElementById('apply-btn');
    const previewModal = document.getElementById('preview-modal');
    const closePreviewBtn = document.getElementById('close-preview-btn');
    const previewFrame = document.getElementById('preview-frame');

    const taskProgressContainer = document.getElementById('task-progress-container');
    const taskHeader = document.getElementById('task-header');
    const taskList = document.getElementById('task-list');
    const taskCounter = document.getElementById('task-counter');
    const undoBtn = document.getElementById('undo-btn');
    const redoBtn = document.getElementById('redo-btn');
    // AI Discussion Modal Elements
    const aiDiscussionModal = document.getElementById('ai-discussion-modal');
    const closeDiscussionBtn = document.getElementById('close-discussion-btn');
    const aiDiscussionContent = document.getElementById('ai-discussion-content');
    const applyImprovedBtn = document.getElementById('apply-improved-btn');
    const stopDiscussionBtn = document.getElementById('stop-discussion-btn');
    const chatListSidebar = document.getElementById('chat-list-sidebar');
    const chatListSidebarList = document.getElementById('chat-list-sidebar-list');
    const chatListSidebarClose = document.getElementById('chat-list-sidebar-close');

    const chatListToggleBtn = document.getElementById('chat-list-toggle-btn');
    const chatListOverlay = document.getElementById('chat-list-overlay'); // تم إضافة هذا السطر
    const chatListNewBtn = document.getElementById('chat-list-new-btn');
    const deleteChatsBtn = document.getElementById('delete-chats-btn');

    // App State
    let sessions = {};
    let currentSessionId = null;
    const initialCode = ''; // Start with a blank slate
    let currentMode = 'normal'; // نمط العمل الحالي
    let isProcessing = false; // لمنع المعالجة المتداخلة
    let errorRetryCount = 0; // عداد إعادة المحاولة عند الأخطاء
    const maxRetries = 3; // أقصى عدد محاولات
    
    // نظام الوكيل الذكي المتقدم
    class SmartAgent {
      constructor() {
        this.memory = [];
        this.context = '';
        this.currentTask = null;
        this.errorHistory = [];
        this.learningData = [];
      }
      
      // تحليل المشكلة وفهم السياق
      async analyzeContext(userInput, currentCode) {
        const analysisPrompt = `أنت وكيل ذكي متقدم. حلل طلب المستخدم والكود الحالي واستخرج المعلومات التالية:
        
طلب المستخدم: ${userInput}
الكود الحالي: ${currentCode || 'فارغ'}
السياق السابق: ${this.context}

يجب أن تحدد:
1. نوع المهمة (إنشاء، تعديل، إصلاح، تحسين)
2. مستوى التعقيد (بسيط، متوسط، معقد)
3. التقنيات المطلوبة
4. المخاطر المحتملة
5. استراتيجية التنفيذ`;

        try {
          const analysis = await callGenAI(ai => ai.models.generateContent({
            model: 'gemini-2.5-flash',
            contents: analysisPrompt,
            config: {
              responseMimeType: "application/json",
              responseSchema: {
                type: Type.OBJECT,
                properties: {
                  task_type: { type: Type.STRING },
                  complexity: { type: Type.STRING },
                  technologies: { type: Type.ARRAY, items: { type: Type.STRING } },
                  risks: { type: Type.ARRAY, items: { type: Type.STRING } },
                  strategy: { type: Type.STRING }
                }
              }
            }
          }));
          return JSON.parse(analysis.text);
        } catch (error) {
          return this.handleError(error, 'تحليل السياق');
        }
      }
      
      // معالجة الأخطاء والتعافي التلقائي
      handleError(error, operation) {
        this.errorHistory.push({ error: error.message, operation, timestamp: Date.now() });
        errorRetryCount++;
        
        if (errorRetryCount <= maxRetries) {
          console.log(`محاولة إعادة تنفيذ ${operation} - المحاولة ${errorRetryCount}`);
          return { error: true, retry: true, message: error.message };
        } else {
          console.log(`فشل نهائياً في ${operation} بعد ${maxRetries} محاولات`);
          errorRetryCount = 0;
          return { error: true, retry: false, message: error.message };
        }
      }
      
      // تعلم من التفاعلات السابقة
      learnFromInteraction(input, output, success) {
        this.learningData.push({
          input,
          output,
          success,
          timestamp: Date.now(),
          mode: currentMode
        });
        
        // الاحتفاظ بآخر 50 تفاعل فقط
        if (this.learningData.length > 50) {
          this.learningData = this.learningData.slice(-50);
        }
      }
      
      // تحسين الأداء بناء على التعلم
      getOptimizedStrategy(taskType) {
        const successfulInteractions = this.learningData.filter(
          data => data.success && data.input.includes(taskType)
        );
        
        if (successfulInteractions.length > 0) {
          const lastSuccessful = successfulInteractions[successfulInteractions.length - 1];
          return lastSuccessful.output;
        }
        
        return null;
      }
    }
    
    const smartAgent = new SmartAgent();

    function saveState() {
        localStorage.setItem('ai-code-editor-sessions', JSON.stringify(sessions));
        localStorage.setItem('ai-code-editor-last-session', currentSessionId);
    }

    function loadState() {
        const savedSessions = localStorage.getItem('ai-code-editor-sessions');
        const lastSessionId = localStorage.getItem('ai-code-editor-last-session');
        
        if (savedSessions) {
            sessions = JSON.parse(savedSessions);
            if (lastSessionId && sessions[lastSessionId]) {
                currentSessionId = lastSessionId;
            } else {
                const sessionIds = Object.keys(sessions);
                currentSessionId = sessionIds.length > 0 ? sessionIds[sessionIds.length - 1] : null;
            }
        }

        if (!currentSessionId) {
            startNewChat();
        } else {
            renderCurrentSession();
            renderChatList();
        }
    }
    
    function startNewChat() {
        console.log('إنشاء دردشة جديدة...');
        const newId = Date.now().toString();
        sessions[newId] = {
            id: newId,
            messages: [{
                sender: 'ai',
                text: 'أهلاً بك! أنا مساعدك البرمجي. صف لي الكود الذي تريد كتابته، وسأبدأ فوراً.'
            }],
            codeHistory: [initialCode],
            historyIndex: 0
        };
        currentSessionId = newId;
        renderCurrentSession();
        renderChatList();
        saveState();
        console.log('تم إنشاء دردشة جديدة بنجاح');
    }
    
    function updateCodeAndView(code, highlightLines = []) {
        codeDisplay.textContent = code;
        hljs.highlightElement(codeDisplay);
        
        const lineCount = code.split('\n').length;
        lineNumbersGutter.innerHTML = Array.from({length: lineCount}, (_, i) => i + 1).join('<br>');

        // Highlight modified lines
        if (highlightLines.length > 0) {
          // Wait for DOM update
          setTimeout(() => {
            const codeHtml = codeDisplay.innerHTML.split('\n');
            for (const lineNum of highlightLines) {
              if (codeHtml[lineNum - 1] !== undefined) {
                codeHtml[lineNum - 1] = `<span class="highlight-modified">${codeHtml[lineNum - 1]}</span>`;
              }
            }
            codeDisplay.innerHTML = codeHtml.join('\n');
            // Remove highlight after 1.5s
            setTimeout(() => {
              codeDisplay.innerHTML = codeDisplay.innerHTML.replace(/<span class="highlight-modified">(.*?)<\/span>/g, '$1');
            }, 1500);
          }, 0);
        }
    }

    function renderCurrentSession() {
        if (!currentSessionId || !sessions[currentSessionId]) return;
        const session = sessions[currentSessionId];

        messagesContainer.innerHTML = '';
        session.messages.forEach(message => {
            _createMessageElement(message.text, message.sender);
        });
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        const currentCode = session.codeHistory[session.historyIndex];
        updateCodeAndView(currentCode);
        updateUndoRedoButtons();
        
        taskProgressContainer.style.display = 'none';
        renderChatList();
    }

    function _createMessageElement(text, sender, isLoading = false) {
      const messageEl = document.createElement('div');
      messageEl.classList.add('message', sender);
      
      if (isLoading) {
        messageEl.classList.add('loading');
        messageEl.innerHTML = `<div class="spinner"></div><span>${text}</span>`;
      } else if (sender === 'ai' && text.startsWith('الكود بعد تنفيذ الخطوة:')) {
        // عرض الكود في تصميم أنيق ومحسن
        const code = text.replace(/^الكود بعد تنفيذ الخطوة:\s*/,'');
        const stepNumber = (sessions[currentSessionId]?.messages.filter(m => m.text.startsWith('الكود بعد تنفيذ الخطوة:')).length || 0) + 1;
        
        messageEl.innerHTML = `
          <div class="step-result-container">
            <div class="step-result-header">
              <div class="step-result-icon">✅</div>
              <div>
                <div class="step-result-title">تم تنفيذ الخطوة ${stepNumber} بنجاح</div>
                <div class="step-result-description">تم تطبيق التحديثات على الكود</div>
              </div>
            </div>
            
            <div class="code-preview-actions">
              <button class="code-action-btn primary" onclick="copyCodeToClipboard(this)" data-code="${encodeURIComponent(code)}">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                  <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
                نسخ الكود
              </button>
              <button class="code-action-btn" onclick="toggleCodeVisibility(this)">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z"></path>
                  <circle cx="12" cy="12" r="3"></circle>
                </svg>
                <span>إخفاء الكود</span>
              </button>
                             <button class="code-action-btn" onclick="formatCodeDisplay(this)">
                 <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                   <polyline points="16 18 22 12 16 6"></polyline>
                   <polyline points="8 6 2 12 8 18"></polyline>
                 </svg>
                 تنسيق الكود
               </button>
               <button class="code-action-btn" onclick="showDiffForStep(this)" data-step="${stepNumber}">
                 <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                   <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                   <polyline points="14 2 14 8 20 8"></polyline>
                   <line x1="16" y1="13" x2="8" y2="13"></line>
                   <line x1="16" y1="17" x2="8" y2="17"></line>
                   <polyline points="10 9 9 9 8 9"></polyline>
                 </svg>
                 عرض التغييرات
               </button>
            </div>
            
                         <div class="code-container">
               <div class="code-stats">
                 <span class="lines-count">${code.split('\n').length} سطر</span>
                 <span class="chars-count">${code.length} حرف</span>
               </div>
               <pre class="ai-step-code" id="step-code-${Date.now()}"><code>${escapeHtml(code)}</code></pre>
             </div>
          </div>
        `;
      } else if (sender === 'ai' && sessions[currentSessionId] && sessions[currentSessionId].messages[sessions[currentSessionId].messages.length-1]?.text === text) {
        // Typewriter effect ONLY for the latest AI message
        let i = 0;
        messageEl.textContent = '';
        function typeWriter() {
          if (i < text.length) {
            messageEl.textContent += text.charAt(i);
            i++;
            setTimeout(typeWriter, 12 + Math.random() * 30);
          }
        }
        typeWriter();
      } else {
        messageEl.textContent = text;
      }
      
      messagesContainer.appendChild(messageEl);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
      return messageEl;
    }
    
    // دالة مساعدة لتشفير HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // دالة إنشاء عرض الاختلافات (Diff View)
    function createDiffView(oldCode, newCode, stepNumber) {
      const oldLines = oldCode.split('\n');
      const newLines = newCode.split('\n');
      
      // حساب الاختلافات باستخدام خوارزمية بسيطة
      const diff = calculateDiff(oldLines, newLines);
      
      let addedCount = 0;
      let removedCount = 0;
      
      // حساب الإحصائيات
      diff.forEach(line => {
        if (line.type === 'added') addedCount++;
        if (line.type === 'removed') removedCount++;
      });
      
      const diffId = `diff-${stepNumber}-${Date.now()}`;
      
      return `
        <div class="diff-container">
          <div class="diff-header">
            <div class="diff-stats">
              <span>التغييرات في الخطوة ${stepNumber}</span>
              <div class="diff-stat additions">+${addedCount}</div>
              <div class="diff-stat deletions">-${removedCount}</div>
            </div>
            <button class="diff-toggle" onclick="toggleDiffView('${diffId}')">
              إخفاء التفاصيل
            </button>
          </div>
          <div class="diff-content" id="${diffId}">
            ${diff.map((line, index) => createDiffLine(line, index)).join('')}
          </div>
        </div>
      `;
    }
    
    // دالة حساب الاختلافات البسيطة
    function calculateDiff(oldLines, newLines) {
      const diff = [];
      let oldIndex = 0;
      let newIndex = 0;
      
      while (oldIndex < oldLines.length || newIndex < newLines.length) {
        const oldLine = oldLines[oldIndex];
        const newLine = newLines[newIndex];
        
        if (oldIndex >= oldLines.length) {
          // أسطر جديدة متبقية
          diff.push({
            type: 'added',
            content: newLine,
            lineNumber: newIndex + 1,
            indicator: '+'
          });
          newIndex++;
        } else if (newIndex >= newLines.length) {
          // أسطر محذوفة متبقية
          diff.push({
            type: 'removed',
            content: oldLine,
            lineNumber: oldIndex + 1,
            indicator: '-'
          });
          oldIndex++;
        } else if (oldLine === newLine) {
          // أسطر متطابقة (سياق)
          diff.push({
            type: 'context',
            content: oldLine,
            lineNumber: newIndex + 1,
            indicator: ' '
          });
          oldIndex++;
          newIndex++;
        } else {
          // البحث عن تطابق في الأسطر القادمة
          let foundMatch = false;
          
          // البحث في الأسطر الجديدة
          for (let i = newIndex + 1; i < Math.min(newIndex + 5, newLines.length); i++) {
            if (oldLine === newLines[i]) {
              // وجدنا تطابق، الأسطر قبله جديدة
              for (let j = newIndex; j < i; j++) {
                diff.push({
                  type: 'added',
                  content: newLines[j],
                  lineNumber: j + 1,
                  indicator: '+'
                });
              }
              newIndex = i;
              foundMatch = true;
              break;
            }
          }
          
          if (!foundMatch) {
            // البحث في الأسطر القديمة
            for (let i = oldIndex + 1; i < Math.min(oldIndex + 5, oldLines.length); i++) {
              if (newLine === oldLines[i]) {
                // وجدنا تطابق، الأسطر قبله محذوفة
                for (let j = oldIndex; j < i; j++) {
                  diff.push({
                    type: 'removed',
                    content: oldLines[j],
                    lineNumber: j + 1,
                    indicator: '-'
                  });
                }
                oldIndex = i;
                foundMatch = true;
                break;
              }
            }
          }
          
          if (!foundMatch) {
            // لا يوجد تطابق، اعتبر السطر القديم محذوف والجديد مضاف
            diff.push({
              type: 'removed',
              content: oldLine,
              lineNumber: oldIndex + 1,
              indicator: '-'
            });
            diff.push({
              type: 'added',
              content: newLine,
              lineNumber: newIndex + 1,
              indicator: '+'
            });
            oldIndex++;
            newIndex++;
          }
        }
      }
      
      return diff;
    }
    
    // دالة إنشاء سطر في عرض الاختلافات
    function createDiffLine(line, index) {
      return `
        <div class="diff-line ${line.type}">
          <div class="diff-line-indicator"></div>
          <div class="line-number">${line.lineNumber}</div>
          <div class="line-content">${escapeHtml(line.content)}</div>
        </div>
      `;
    }
    
    // دالة تبديل عرض التفاصيل
    function toggleDiffView(diffId) {
      const diffContent = document.getElementById(diffId);
      const button = diffContent.previousElementSibling.querySelector('.diff-toggle');
      
      if (diffContent.style.display === 'none') {
        diffContent.style.display = 'block';
        button.textContent = 'إخفاء التفاصيل';
      } else {
        diffContent.style.display = 'none';
        button.textContent = 'إظهار التفاصيل';
      }
    }
    
    // دوال تفاعلية لأزرار الكود
    function copyCodeToClipboard(button) {
      const code = decodeURIComponent(button.dataset.code);
      navigator.clipboard.writeText(code).then(() => {
        const originalText = button.innerHTML;
        button.innerHTML = `
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
          تم النسخ!
        `;
        button.style.background = 'var(--success-color)';
        
        setTimeout(() => {
          button.innerHTML = originalText;
          button.style.background = '';
        }, 2000);
      }).catch(err => {
        console.error('فشل في نسخ الكود:', err);
        button.innerHTML = `
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
          فشل النسخ
        `;
      });
    }
    
    function toggleCodeVisibility(button) {
      const container = button.closest('.step-result-container');
      const codeElement = container.querySelector('.ai-step-code');
      const span = button.querySelector('span');
      
      if (codeElement.style.display === 'none') {
        codeElement.style.display = 'block';
        span.textContent = 'إخفاء الكود';
        button.querySelector('svg').innerHTML = `
          <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z"></path>
          <circle cx="12" cy="12" r="3"></circle>
        `;
      } else {
        codeElement.style.display = 'none';
        span.textContent = 'إظهار الكود';
        button.querySelector('svg').innerHTML = `
          <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
          <line x1="1" y1="1" x2="23" y2="23"></line>
        `;
      }
    }
    
    function formatCodeDisplay(button) {
      const container = button.closest('.step-result-container');
      const codeElement = container.querySelector('.ai-step-code code');
      
      if (codeElement) {
        // إعادة تنسيق الكود بـ highlight.js
        hljs.highlightElement(codeElement);
        
        // تأثير بصري للإشارة إلى أن التنسيق تم
        button.style.background = 'var(--success-color)';
        button.innerHTML = `
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
          تم التنسيق!
        `;
        
        setTimeout(() => {
          button.style.background = '';
          button.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="16 18 22 12 16 6"></polyline>
              <polyline points="8 6 2 12 8 18"></polyline>
            </svg>
            تنسيق الكود
          `;
        }, 2000);
      }
    }
    
    function showDiffForStep(button) {
      const stepNumber = button.dataset.step;
      const session = sessions[currentSessionId];
      
      if (!session || !session.codeHistory) return;
      
      // العثور على الكود قبل وبعد هذه الخطوة
      const currentIndex = session.historyIndex;
      if (currentIndex > 0) {
        const oldCode = session.codeHistory[Math.max(0, currentIndex - parseInt(stepNumber))];
        const newCode = session.codeHistory[currentIndex];
        
        // إنشاء نافذة منبثقة لعرض الاختلافات
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.style.zIndex = '2000';
        modal.innerHTML = `
          <div class="modal-content" style="max-width: 90%; max-height: 90%;">
            <div class="modal-header" style="justify-content: space-between;">
              <h3 style="margin: 0; color: var(--text-color);">مقارنة التغييرات - الخطوة ${stepNumber}</h3>
              <button id="close-diff-modal" style="background: none; border: none; color: var(--text-color); font-size: 1.5rem; cursor: pointer;">&times;</button>
            </div>
            <div style="flex: 1; overflow: hidden;">
              ${createDiffView(oldCode, newCode, stepNumber)}
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        // إغلاق النافذة
        modal.querySelector('#close-diff-modal').onclick = () => {
          document.body.removeChild(modal);
        };
        
        modal.onclick = (e) => {
          if (e.target === modal) {
            document.body.removeChild(modal);
          }
        };
      }
    }
    
    function addMessageToState(text, sender) {
        sessions[currentSessionId].messages.push({ text, sender });
        saveState();
    }
    
    function addCodeToHistory(newCode) {
        const session = sessions[currentSessionId];
        if (session.historyIndex < session.codeHistory.length - 1) {
            session.codeHistory = session.codeHistory.slice(0, session.historyIndex + 1);
        }
        session.codeHistory.push(newCode);
        session.historyIndex = session.codeHistory.length - 1;
        updateUndoRedoButtons();
        saveState();
    }

    function updateUndoRedoButtons() {
        const session = sessions[currentSessionId];
        undoBtn.disabled = session.historyIndex <= 0;
        redoBtn.disabled = session.historyIndex >= session.codeHistory.length - 1;
    }

    function undo() {
        const session = sessions[currentSessionId];
        if (session.historyIndex > 0) {
            session.historyIndex--;
            const code = session.codeHistory[session.historyIndex];
            updateCodeAndView(code);
            updateUndoRedoButtons();
            saveState();
        }
    }

    function redo() {
        const session = sessions[currentSessionId];
        if (session.historyIndex < session.codeHistory.length - 1) {
            session.historyIndex++;
            const code = session.codeHistory[session.historyIndex];
            updateCodeAndView(code);
            updateUndoRedoButtons();
            saveState();
        }
    }


    async function handleSendMessage(e) {
      e.preventDefault();
      
      if (isProcessing) {
        _createMessageElement('جاري المعالجة... يرجى الانتظار', 'ai');
        return;
      }
      
      isProcessing = true;
      
      // تحديث الكود الحالي من المحرر قبل أي معالجة
      const session = sessions[currentSessionId];
      if (session) {
        session.codeHistory[session.historyIndex] = codeDisplay.textContent;
        saveState();
      }
      
      const prompt = promptInput.value.trim();
      if (!prompt) {
        isProcessing = false;
        return;
      }

      const currentCode = codeDisplay.textContent;

      // إرسال رسالة المستخدم فوراً
      _createMessageElement(prompt, 'user');
      addMessageToState(prompt, 'user');
      
      promptInput.value = '';
      promptInput.disabled = true;
      sendButton.disabled = true;
      
      // تحليل السياق بالوكيل الذكي
      const analysis = await smartAgent.analyzeContext(prompt, currentCode);
      if (analysis.error && !analysis.retry) {
        _createMessageElement(`فشل في تحليل المهمة: ${analysis.message}`, 'ai');
        isProcessing = false;
        promptInput.disabled = false;
        sendButton.disabled = false;
        return;
      }
      
      // عرض معلومات التحليل للمستخدم
      if (!analysis.error) {
        _createMessageElement(`🔍 تحليل المهمة:
نوع المهمة: ${analysis.task_type}
مستوى التعقيد: ${analysis.complexity}
التقنيات المطلوبة: ${analysis.technologies?.join(', ')}
استراتيجية التنفيذ: ${analysis.strategy}`, 'ai');
      }
        
        // توليد عنوان للدردشة بعد أول رسالة من المستخدم
        if (session.messages.length === 2) { // أول رسالة من المستخدم
          try {
            const titlePrompt = `اقترح عنوانًا مختصرًا (3-6 كلمات) يصف طلب المستخدم التالي بشكل واضح، بدون علامات ترقيم إضافية أو رموز، فقط نص واضح:
\n\n${prompt}`;
            callGenAI(ai => ai.models.generateContent({
              model: 'gemini-2.5-flash',
              contents: titlePrompt
            })).then(titleRes => {
              let title = titleRes.text.trim().replace(/[\n\r]+/g, ' ');
              if (title.length > 32) title = title.slice(0, 32) + '…';
              session.title = title;
              saveState();
              renderChatList();
            }).catch(e => { 
              console.log('فشل في توليد العنوان:', e);
            });
          } catch (e) { 
            console.log('فشل في توليد العنوان:', e);
          }
        }
      const loadingMessage = _createMessageElement('أحلل طلبك...', 'ai', true);

      try {
        const session = sessions[currentSessionId];
        const formattedHistory = session.messages.map(m => `${m.sender === 'user' ? 'مستخدم' : 'مساعد'}: ${m.text}`).join('\n\n');

        const planningPrompt = `You are an intelligent AI assistant. Your responses must be in Arabic.\nBased on the full conversation history provided below, analyze ONLY the latest user request.\n\nConversation History:\n---\n${formattedHistory}\n---\n\nCurrent Code:\n---\n${currentCode || '(empty)'}\n---\n\nBased on this latest request, decide if it is a 'code_modification' or a 'general_question'.\n- If it's a 'code_modification', create a step-by-step plan. The tasks in the plan MUST be in Arabic.\n- If it's a 'general_question', provide a direct, helpful answer in Arabic, taking the full conversation history into account for context.\n\nملاحظة هامة: يجب أن يكون الكود الناتج عبارة عن ملف HTML واحد فقط، ويحتوي بداخله على جميع أكواد CSS وJavaScript اللازمة داخل وسوم <style> و<script>.`;

        const planningResponse = await callGenAI(ai => ai.models.generateContent({
            model: 'gemini-2.5-flash',
            contents: planningPrompt,
            config: {
                responseMimeType: "application/json",
                responseSchema: {
                    type: Type.OBJECT,
                    properties: {
                        request_type: { type: Type.STRING, enum: ["code_modification", "general_question"] },
                        tasks: {
                            type: Type.ARRAY,
                            items: { type: Type.STRING },
                            description: "قائمة مهام تعديل الكود باللغة العربية."
                        },
                        answer: { type: Type.STRING, description: "إجابة للسؤال العام باللغة العربية." }
                    }
                }
            }
        }));
        
        loadingMessage.remove();
        const plan = JSON.parse(planningResponse.text);

        if (plan.request_type === 'general_question') {
            _createMessageElement(plan.answer, 'ai');
            addMessageToState(plan.answer, 'ai');
        } else if (plan.request_type === 'code_modification' && plan.tasks && plan.tasks.length > 0) {
            if (currentMode !== 'normal') {
              await executeAdvancedTaskPlan(plan.tasks, prompt, currentMode);
            } else {
              await executeTaskPlan(plan.tasks, formattedHistory, prompt);
            }
            
            // تسجيل نجاح التفاعل للتعلم
            smartAgent.learnFromInteraction(prompt, 'نجح تنفيذ المهام', true);
        } else {
            const fallbackMsg = "لم أتمكن من تحديد الإجراء المطلوب. هل يمكنك إعادة صياغة طلبك؟";
             _createMessageElement(fallbackMsg, 'ai');
             addMessageToState(fallbackMsg, 'ai');
        }

      } catch (error) {
        console.error(error);
        loadingMessage.remove();
        
        // معالجة الخطأ بالوكيل الذكي
        const errorHandling = smartAgent.handleError(error, 'معالجة الرسالة');
        if (errorHandling.retry) {
          _createMessageElement(`⚠️ حدث خطأ، جاري إعادة المحاولة... (المحاولة ${errorRetryCount})`, 'ai');
          // إعادة تنفيذ العملية
          setTimeout(() => handleSendMessage(e), 2000);
          return;
        }
        
        const errorMsg = `❌ حدث خطأ: ${error.message}
        
🔧 اقتراحات الإصلاح:
- تحقق من اتصال الإنترنت
- جرب إعادة صياغة الطلب
- استخدم أحد الأدوات المتخصصة من القائمة`;
        _createMessageElement(errorMsg, 'ai');
        addMessageToState(errorMsg, 'ai');
        
        // تسجيل فشل التفاعل للتعلم
        smartAgent.learnFromInteraction(prompt, error.message, false);
      } finally {
        isProcessing = false;
        promptInput.disabled = false;
        sendButton.disabled = false;
        promptInput.focus();
      }
    }
    
    async function executeTaskPlan(tasks, formattedHistory, originalPrompt, specialPrompt = '') {
        // إضافة خطوة CSS تلقائية إذا لم توجد خطوة تصميم أو CSS
        const hasCssStep = tasks.some(task => /css|تصميم|تنسيق|style|ستايل/i.test(task));
        if (!hasCssStep) {
            tasks.unshift('أضف تنسيقات CSS حديثة وجميلة للموقع.');
        }
        renderTaskList(tasks);
        let currentCode = sessions[currentSessionId].codeHistory[sessions[currentSessionId].historyIndex];
        let completedTasks = 0;
        let lastModifiedLines = [];
        
        for (let i = 0; i < tasks.length; i++) {
            const taskDesc = tasks[i];
            updateTaskStatus(i, 'in-progress');
            const oldCode = currentCode; // حفظ الكود القديم قبل التعديل
            const numberedCode = currentCode.split('\n').map((line, index) => `${index + 1}: ${line}`).join('\n');
            try {
                const executionPrompt = `You are a surgical code editing AI. ${specialPrompt} Your task is to modify the provided code to accomplish a specific task.\nYou MUST respond with ONLY the JSON object for the modification, without any explanation, description, or extra text.\nThe format is: { \"start_line\": number, \"end_line\": number, \"new_code\": \"string_of_new_code\" }\n- \"start_line\" and \"end_line\" are 1-based indices corresponding to the line numbers in the input.\n- To insert code at a specific line, set \"end_line\" to \"start_line - 1\". The code will be inserted before \"start_line\". For example, to insert at the beginning of the file, use start_line: 1, end_line: 0.\n- To delete lines, set \"new_code\" to an empty string \"\".\n- \"new_code\" should be a single string, with newlines represented by '\\n'.\n\nConversation History (for context):\n---\n${formattedHistory}\n---\n\nUser's original high-level request: \"${originalPrompt}\"\n\nThe specific, single task to execute now is: \"${taskDesc}\"\n\nCurrent Code (with 1-based line numbers):\n---\n${numberedCode || "(empty)"}\n---\n\nNow, provide ONLY the JSON object for the modification.`;

                const response = await callGenAI(ai => ai.models.generateContent({
                    model: "gemini-2.5-flash",
                    contents: executionPrompt,
                    config: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: Type.OBJECT,
                            properties: {
                                start_line: { type: Type.NUMBER, description: "The 1-based starting line number for the code modification." },
                                end_line: { type: Type.NUMBER, description: "The 1-based ending line number for the code modification." },
                                new_code: { type: Type.STRING, description: "The new code to insert/replace, with newlines as \\n." }
                            },
                            required: ["start_line", "end_line", "new_code"]
                        }
                    }
                }));
                const modification = JSON.parse(response.text);
                const { start_line, end_line, new_code } = modification;
                let codeLines = currentCode.split('\n');
                if (codeLines.length === 1 && codeLines[0] === '') {
                    codeLines = [];
                }
                const startIdx = start_line - 1;
                const endIdx = end_line - 1;
                const deleteCount = Math.max(0, endIdx - startIdx + 1);
                if (startIdx < -1 || startIdx > codeLines.length) {
                   throw new Error(`AI provided an invalid start line: ${start_line}. File has ${codeLines.length} lines.`);
                }
                const newCodeLines = (new_code === null || new_code === undefined) ? [] : new_code.split('\n');
                // Highlight the lines that will be modified (after the change)
                lastModifiedLines = [];
                if (newCodeLines.length > 0) {
                  for (let l = 0; l < newCodeLines.length; l++) {
                    lastModifiedLines.push(startIdx + 1 + l);
                  }
                }
                codeLines.splice(startIdx, deleteCount, ...newCodeLines);
                currentCode = codeLines.join('\n');
                // تحديث الكود في المحرر مباشرة بعد كل خطوة
                updateCodeAndView(currentCode, lastModifiedLines);
                addCodeToHistory(currentCode);
                
                // إنشاء عرض الاختلافات وعرضه في رسالة AI
                const stepNumber = i + 1;
                const diffHtml = createDiffView(oldCode, currentCode, stepNumber);
                
                const messageEl = document.createElement('div');
                messageEl.classList.add('message', 'ai');
                messageEl.innerHTML = diffHtml;
                messagesContainer.appendChild(messageEl);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                // حفظ رسالة مبسطة في الذاكرة
                addMessageToState(`تم تنفيذ الخطوة ${stepNumber}: ${taskDesc}`, 'ai');
                updateTaskStatus(i, 'completed');
                completedTasks++;
                taskCounter.textContent = `${completedTasks} / ${tasks.length}`;
            } catch(err) {
                console.error(`Error on task ${i}:`, err);
                const errorDetails = err.message || JSON.stringify(err);
                updateTaskStatus(i, 'failed', errorDetails);
                const failMsg = `فشلت في إكمال المهمة: "${taskDesc}"\nالسبب: ${errorDetails}`;
                _createMessageElement(failMsg, 'ai');
                addMessageToState(failMsg, 'ai');
                return; 
            }
        }
        // إزالة التحديث النهائي في نهاية الدالة
        const successMsg = 'لقد أكملت جميع المهام بنجاح.';
        _createMessageElement(successMsg, 'ai');
        addMessageToState(successMsg, 'ai');
    }

    function renderTaskList(tasks) {
        taskList.innerHTML = '';
        tasks.forEach((taskDesc, index) => {
            const taskItem = document.createElement('div');
            taskItem.className = 'task-item';
            taskItem.dataset.index = index;
            taskItem.innerHTML = `
                <div class="task-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="pending-icon"><circle cx="12" cy="12" r="10"></circle></svg>
                </div>
                <span>${taskDesc}</span>`;
            taskList.appendChild(taskItem);
        });
        taskCounter.textContent = `0 / ${tasks.length}`;
        taskProgressContainer.classList.remove('collapsed');
        taskProgressContainer.style.display = 'block';
    }

    function updateTaskStatus(index, status, errorMsg = '') {
        const taskItem = taskList.querySelector(`.task-item[data-index='${index}']`);
        if (!taskItem) return;
        const iconContainer = taskItem.querySelector('.task-icon');
        
        let iconHtml = '';
        switch (status) {
            case 'in-progress':
                iconHtml = `<div class="spinner"></div>`; break;
            case 'completed':
                iconHtml = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="check-icon"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
                taskItem.style.color = 'var(--success-color)'; break;
            case 'failed':
                iconHtml = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="error-icon"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>`;
                taskItem.style.color = 'var(--error-color)';
                taskItem.title = errorMsg; break;
        }
        iconContainer.innerHTML = iconHtml;
    }


    function showPreview() {
      const currentCode = sessions[currentSessionId].codeHistory[sessions[currentSessionId].historyIndex];
      previewFrame.srcdoc = currentCode;
      previewModal.style.display = 'flex';
    }

    function hidePreview() {
      previewModal.style.display = 'none';
      previewFrame.srcdoc = ''; 
    }

    function applyChanges() {
      if (confirm("هل أنت متأكد؟ سيؤدي هذا إلى إعادة تحميل الصفحة بالكود الجديد.")) {
        const newCode = sessions[currentSessionId].codeHistory[sessions[currentSessionId].historyIndex];
        const blob = new Blob([newCode], {type: 'text/html'});
        const url = URL.createObjectURL(blob);
        window.location.href = url;
      }
    }

    // ========== AI Discussion Logic ==========
    let stopAIDiscussion = false;
    async function startAIDiscussionLoop() {
      stopAIDiscussion = false;
      aiDiscussionContent.innerHTML = '';
      let ai1Memory = [];
      let ai2Memory = [];
      let currentCode = sessions[currentSessionId].codeHistory[sessions[currentSessionId].historyIndex];
      let improvedCode = currentCode;
      let round = 1;

      // إعداد نماذج الذكاء الاصطناعي
      const ai1 = new GoogleGenAI({ apiKey: "AIzaSyCYlSM0arXvt1GMnsUMIPrTF4T3U-jsxKI" });
      const ai2 = new GoogleGenAI({ apiKey: "AIzaSyCJhj0oJaRQeKudyDyvtSf-fz-xbpL-Mm8" });

      while (!stopAIDiscussion) {
        // AI1: تحليل السلبيات
        const ai1Prompt = `أنت خبير تجربة مستخدم (UX) ومهمتك تحليل كود HTML التالي فقط من ناحية تجربة المستخدم، وذكر جميع السلبيات والمشاكل التي قد تؤثر على المستخدم بشكل منطقي ومنهجي، مع اقتراح خطوات عمل واضحة للتحسين. لا تكتب أي كود، فقط التحليل والخطوات.\n\n${ai1Memory.length > 0 ? 'سياق سابق:\n' + ai1Memory.join('\n---\n') + '\n' : ''}الكود الحالي:\n---\n${improvedCode}\n---`;
        aiDiscussionContent.innerHTML += `<div style="margin-bottom:1rem;"><b>AI1 (تحليل السلبيات):</b><br><span style="color:#e06c75;">جاري التحليل...</span></div>`;
        aiDiscussionContent.scrollTop = aiDiscussionContent.scrollHeight;
        let ai1Analysis = '';
        try {
          const ai1Res = await callGenAI(ai => ai.models.generateContent({
            model: 'gemini-2.5-flash',
            contents: ai1Prompt
          }));
          ai1Analysis = ai1Res.text.trim();
        } catch (err) {
          ai1Analysis = 'حدث خطأ في تحليل AI1: ' + err.message;
          stopAIDiscussion = true;
        }
        ai1Memory.push(ai1Analysis);
        aiDiscussionContent.innerHTML = aiDiscussionContent.innerHTML.replace('جاري التحليل...', ai1Analysis.replace(/\n/g, '<br>'));
        aiDiscussionContent.scrollTop = aiDiscussionContent.scrollHeight;
        if (stopAIDiscussion) break;

        // AI2: تنفيذ التحسينات
        // استخراج الخطوات من تحليل AI1
        let steps = [];
        const stepRegex = /(?:^|\n)\s*(?:\d+\.|-)[ \t]*(.+?)(?=\n|$)/g;
        let match;
        while ((match = stepRegex.exec(ai1Analysis)) !== null) {
          steps.push(match[1].trim());
        }
        if (steps.length === 0) {
          // إذا لم يتمكن من استخراج خطوات، نفذ التحليل كله دفعة واحدة
            steps = [ai1Analysis];
        }
        for (let i = 0; i < steps.length; i++) {
          if (stopAIDiscussion) break;
          const step = steps[i];
          const ai2StepPrompt = `أنت خبير تطوير واجهات ويب. لديك كود HTML فقط (بدون CSS أو JS خارجي). مهمتك تنفيذ الخطوة التالية فقط على الكود الحالي، ثم تعيد الكود الجديد فقط (بدون شرح أو تعليق أو أي نص آخر).\n\nالخطوة المطلوب تنفيذها:\n${step}\n\nالكود الحالي:\n---\n${improvedCode}\n---`;
          aiDiscussionContent.innerHTML += `<div style=\"margin-bottom:1rem;\"><b>AI2 (تنفيذ خطوة: ${step.replace(/[&<>]/g, function(tag) {
            const charsToReplace = { '&': '&amp;', '<': '&lt;', '>': '&gt;' };
            return charsToReplace[tag] || tag;
          })}):</b><br><span style=\"color:#56c4d8;\">جاري التنفيذ...</span></div>`;
          aiDiscussionContent.scrollTop = aiDiscussionContent.scrollHeight;
          let ai2StepCode = '';
          try {
            const ai2StepRes = await callGenAI(ai => ai.models.generateContent({
              model: 'gemini-2.5-flash',
              contents: ai2StepPrompt
            }));
            ai2StepCode = ai2StepRes.text.trim();
          } catch (err) {
            ai2StepCode = 'حدث خطأ في تنفيذ AI2: ' + err.message;
            stopAIDiscussion = true;
          }
          ai2Memory.push(ai2StepCode);
          aiDiscussionContent.innerHTML = aiDiscussionContent.innerHTML.replace(
            'جاري التنفيذ...',
            `<div style=\"margin-bottom:0.5rem; color:#aaa; font-size:13px;\">(تم تنفيذ الخطوة: ${step.replace(/[&<>]/g, function(tag) {
              const charsToReplace = { '&': '&amp;', '<': '&lt;', '>': '&gt;' };
              return charsToReplace[tag] || tag;
            })}. الكود الكامل تم تحديثه في المحرر الرئيسي ويمكنك تعديله أو معاينته مباشرة)</div><pre style=\"background:#222; color:#fff; padding:0.5rem; border-radius:6px; overflow:auto; max-height:200px;\">${ai2StepCode.replace(/[&<>]/g, function(tag) {
              const charsToReplace = { '&': '&amp;', '<': '&lt;', '>': '&gt;' };
              return charsToReplace[tag] || tag;
            })}</pre>`
          );
          aiDiscussionContent.scrollTop = aiDiscussionContent.scrollHeight;
          if (stopAIDiscussion) break;
          // تحديث الكود في المحرر بعد كل خطوة
          improvedCode = ai2StepCode;
          updateCodeAndView(improvedCode);
          applyImprovedBtn.style.display = 'inline-block';
          // انتظار قصير لإتاحة الإيقاف
          await new Promise(res => setTimeout(res, 400));
        }

        // عند الضغط على "اعتماد الكود المحسن"
        applyImprovedBtn.onclick = () => {
          addCodeToHistory(improvedCode);
          updateCodeAndView(improvedCode);
          aiDiscussionModal.style.display = 'none';
        };

        // انتظار قصير بين الجولات (لإتاحة الإيقاف)
        await new Promise(res => setTimeout(res, 500));
      }
    }

    // ========== Self-Improvement Logic ==========
    let stopSelfImprove = false;
    selfImproveBtn.addEventListener('click', async () => {
      stopSelfImprove = false;
      selfImproveBtn.disabled = true;
      selfImproveBtn.textContent = 'جاري التطوير الذاتي...';
      let currentCode = sessions[currentSessionId].codeHistory[sessions[currentSessionId].historyIndex];
      let round = 1;
      while (!stopSelfImprove) {
        // احذف رسائل التطوير الذاتي السابقة قبل كل جولة جديدة
        clearSelfImproveMessages();
        // 1. اطلب من الذكاء الاصطناعي توليد خطة تطوير جديدة بناءً على الكود الحالي
        const planningPrompt = `أنت مساعد برمجي ذاتي التطوير. مهمتك الوحيدة تحسين الجماليات والتنسيق والشكل وتجربة المستخدم (UI/UX) للكود الحالي فقط، مثل الألوان، الخطوط، التباعد، الرسوميات، التفاعل البصري، وتحسين العرض على جميع الأجهزة. لا تقترح أو تنفذ أي تغييرات على الوظائف أو المنطق أو تضيف ميزات جديدة. ركز فقط على تحسين CSS وHTML presentation. في كل جولة، حلل الكود الحالي واقترح خطة تطوير جديدة لتحسين الشكل والتجربة البصرية فقط. إذا لم يعد هناك ما يمكن تحسينه في الجماليات، أجب فقط: 'انتهى التطوير الذاتي.'\n\nالكود الحالي:\n---\n${currentCode}\n---`;
        let plan;
        try {
          const planningResponse = await callGenAI(ai => ai.models.generateContent({
            model: 'gemini-2.5-flash',
            contents: planningPrompt,
            config: {
              responseMimeType: "application/json",
              responseSchema: {
                type: Type.OBJECT,
                properties: {
                  tasks: { type: Type.ARRAY, items: { type: Type.STRING }, description: "خطوات تطوير ذاتي جديدة (تحسينات جمالية فقط)." },
                  finished: { type: Type.BOOLEAN, description: "هل انتهى التطوير الذاتي؟" }
                },
                required: ["tasks", "finished"]
              }
            }
          }));
          plan = JSON.parse(planningResponse.text);
        } catch (err) {
          _createMessageElement('فشل في توليد خطة تطوير ذاتي: ' + err.message, 'ai');
          break;
        }
        if (plan.finished || !plan.tasks || plan.tasks.length === 0) {
          _createMessageElement('انتهى التطوير الذاتي.', 'ai');
          taskProgressContainer.style.display = 'none';
          break;
        }
        // عرض خطوات الجولة الحالية في قائمة المهام
        renderTaskList(plan.tasks);
        let completedTasks = 0;
        for (let i = 0; i < plan.tasks.length; i++) {
          if (stopSelfImprove) break;
          const taskDesc = plan.tasks[i];
          updateTaskStatus(i, 'in-progress');
          const numberedCode = currentCode.split('\n').map((line, index) => `${index + 1}: ${line}`).join('\n');
          try {
            const executionPrompt = `أنت مساعد برمجي متخصص في تحسين الجماليات والتنسيق والشكل (UI/UX, CSS, presentation) فقط. مهمتك تعديل الكود الحالي لتحقيق الخطوة التالية فقط، دون أي تغيير في الوظائف أو المنطق أو إضافة ميزات جديدة.\n\nيجب أن يكون ردك كائن JSON فقط بهذا الشكل: { \"start_line\": رقم, \"end_line\": رقم, \"new_code\": \"الكود الجديد\" }\n- \"start_line\" و\"end_line\" أرقام الأسطر (1-based) المطلوب تعديلها أو استبدالها.\n- إذا أردت إدراج كود، اجعل end_line = start_line - 1.\n- إذا أردت حذف أسطر، اجعل new_code فارغاً.\n- new_code يجب أن يكون نصاً واحداً مع \n للفواصل.\n\nالخطوة: ${taskDesc}\n\nالكود الحالي (مع أرقام الأسطر):\n---\n${numberedCode}\n---\n\nأعد فقط كائن JSON المطلوب بدون أي شرح أو نص إضافي.`;
            const response = await callGenAI(ai => ai.models.generateContent({
              model: 'gemini-2.5-flash',
              contents: executionPrompt,
              config: {
                responseMimeType: "application/json",
                responseSchema: {
                  type: Type.OBJECT,
                  properties: {
                    start_line: { type: Type.NUMBER, description: "رقم السطر الأول (1-based) للتعديل." },
                    end_line: { type: Type.NUMBER, description: "رقم السطر الأخير (1-based) للتعديل." },
                    new_code: { type: Type.STRING, description: "الكود الجديد المطلوب إدراجه أو استبداله، مع \n للفواصل." }
                  },
                  required: ["start_line", "end_line", "new_code"]
                }
              }
            }));
            const modification = JSON.parse(response.text);
            const { start_line, end_line, new_code } = modification;
            let codeLines = currentCode.split('\n');
            if (codeLines.length === 1 && codeLines[0] === '') {
                codeLines = [];
            }
            const startIdx = start_line - 1;
            const endIdx = end_line - 1;
            const deleteCount = Math.max(0, endIdx - startIdx + 1);
            if (startIdx < -1 || startIdx > codeLines.length) {
               throw new Error(`AI provided an invalid start line: ${start_line}. File has ${codeLines.length} lines.`);
            }
            const newCodeLines = (new_code === null || new_code === undefined) ? [] : new_code.split('\n');
            // Highlight the lines that will be modified (after the change)
            let lastModifiedLines = [];
            if (newCodeLines.length > 0) {
              for (let l = 0; l < newCodeLines.length; l++) {
                lastModifiedLines.push(startIdx + 1 + l);
              }
            }
            codeLines.splice(startIdx, deleteCount, ...newCodeLines);
            currentCode = codeLines.join('\n');
            updateCodeAndView(currentCode, lastModifiedLines);
            addCodeToHistory(currentCode);
            updateTaskStatus(i, 'completed');
            completedTasks++;
            taskCounter.textContent = `${completedTasks} / ${plan.tasks.length}`;
          } catch (err) {
            updateTaskStatus(i, 'failed', err.message);
            _createMessageElement('فشل تنفيذ خطوة تطوير ذاتي: ' + err.message, 'ai');
            stopSelfImprove = true;
            break;
          }
        }
        round++;
        await new Promise(res => setTimeout(res, 500));
      }
      selfImproveBtn.disabled = false;
      selfImproveBtn.textContent = 'تطوير ذاتي';
    });
    // زر لإيقاف التطوير الذاتي (يمكنك تحسينه لاحقاً)
    selfImproveBtn.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      stopSelfImprove = true;
      selfImproveBtn.disabled = false;
      selfImproveBtn.textContent = 'تطوير ذاتي';
      _createMessageElement('تم إيقاف التطوير الذاتي.', 'ai');
      taskProgressContainer.style.display = 'none';
    });



    // دالة لحذف رسائل التطوير الذاتي السابقة من المحادثة
    function clearSelfImproveMessages() {
      const session = sessions[currentSessionId];
      if (!session) return;
      // احذف كل رسالة AI تحتوي على 'جولة تطوير ذاتي' أو 'الكود بعد تطوير الخطوة' أو 'انتهى التطوير الذاتي.'
      session.messages = session.messages.filter(m => {
        if (m.sender !== 'ai') return true;
        if (/جولة تطوير ذاتي|الكود بعد تطوير الخطوة|انتهى التطوير الذاتي|فشل تنفيذ خطوة تطوير ذاتي|فشل في توليد خطة تطوير ذاتي|تم إيقاف التطوير الذاتي/.test(m.text)) return false;
        return true;
      });
      saveState();
      renderCurrentSession();
    }

    function renderChatList() {
      // Render sidebar chat list
      chatListSidebarList.innerHTML = '';
      const sessionIds = Object.keys(sessions);
      if (sessionIds.length === 0) return;
      sessionIds.forEach(sessionId => {
        const session = sessions[sessionId];
        let title = session.title || 'دردشة جديدة';
        if (!session.title) {
          for (const msg of session.messages) {
            if (msg.sender === 'user' && msg.text.trim()) {
              title = msg.text.trim().slice(0, 24) + (msg.text.trim().length > 24 ? '…' : '');
              break;
            }
          }
        }
        const item = document.createElement('button');
        item.className = 'chat-list-item' + (sessionId === currentSessionId ? ' active' : '');
        item.innerHTML = `<svg class="chat-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg> <span>${title}</span>`;
        item.onclick = () => {
          if (currentSessionId !== sessionId) {
            currentSessionId = sessionId;
            renderCurrentSession();
            renderChatList();
            saveState();
          }
          closeChatListSidebar();
        };
        chatListSidebarList.appendChild(item);
      });
    }
    function openChatListSidebar() {
      chatListSidebar.classList.add('open');
      chatListOverlay.style.display = 'block';
    }
    function closeChatListSidebar() {
      chatListSidebar.classList.remove('open');
      chatListOverlay.style.display = 'none';
    }
    chatListToggleBtn.addEventListener('click', openChatListSidebar);
    chatListSidebarClose.addEventListener('click', closeChatListSidebar);
    chatListOverlay.addEventListener('click', closeChatListSidebar);
    chatListNewBtn.addEventListener('click', () => {
      console.log('تم الضغط على زر دردشة جديدة في الشريط الجانبي');
      startNewChat();
      closeChatListSidebar();
    });

    deleteChatsBtn.addEventListener('click', () => {
      if (confirm('هل أنت متأكد أنك تريد حذف جميع الدردشات؟ لا يمكن التراجع.')) {
        sessions = {};
        currentSessionId = null;
        saveState();
        startNewChat();
        renderChatList();
        closeChatListSidebar();
      }
    });

    // وظائف الأدوات المتخصصة
    function toggleToolsMenu() {
      const isVisible = toolsMenu.style.display !== 'none';
      toolsMenu.style.display = isVisible ? 'none' : 'block';
      toolsBtn.classList.toggle('active', !isVisible);
    }
    
    function selectTool(mode) {
      currentMode = mode;
      toolsMenu.style.display = 'none';
      toolsBtn.classList.remove('active');
      
      const modeTexts = {
        'self-development': 'تطوير ذاتي 🚀',
        'deep-thinking': 'تفكير عميق 🧠',
        'code-research': 'بحث في الكود 🔍',
        'bug-hunter': 'مطارد الأخطاء 🐛',
        'performance-optimizer': 'محسن الأداء ⚡',
        'creative-mode': 'وضع إبداعي 🎨',
        'normal': 'وضع عادي'
      };
      
      const modePrompts = {
        'self-development': 'قم بتطبيق التطوير الذاتي',
        'deep-thinking': 'استخدم التفكير العميق لتحليل',
        'code-research': 'ابحث وحلل الكود',
        'bug-hunter': 'ابحث عن الأخطاء وأصلحها',
        'performance-optimizer': 'حسن أداء الكود',
        'creative-mode': 'أبدع في الحل',
        'normal': 'اسأل عن أي شيء...'
      };
      
      // تحديث المؤشر والنص
      if (mode === 'normal') {
        activeToolIndicator.style.display = 'none';
        promptInput.placeholder = 'اسأل عن أي شيء...';
      } else {
        activeToolIndicator.style.display = 'flex';
        toolIndicatorText.textContent = modeTexts[mode];
        promptInput.placeholder = modePrompts[mode];
        promptInput.focus();
      }
      
      // تحديث حالة العناصر في القائمة
      document.querySelectorAll('.tool-item').forEach(item => {
        item.classList.toggle('active', item.dataset.mode === mode);
      });
    }
    
    function getColorForMode(mode) {
      const colors = {
        'self-development': '#f59e0b, #d97706',
        'deep-thinking': '#7c3aed, #6d28d9',
        'code-research': '#06b6d4, #0891b2',
        'bug-hunter': '#ef4444, #dc2626',
        'performance-optimizer': '#10b981, #059669',
        'creative-mode': '#ec4899, #db2777'
      };
      return colors[mode] || '#7c3aed, #6d28d9';
    }
    
    // تحسين دالة executeTaskPlan بناء على الوضع المحدد
    async function executeAdvancedTaskPlan(tasks, prompt, mode) {
      const modePrompts = {
        'deep-thinking': 'أنت خبير متخصص في التحليل العميق. قم بتحليل كل خطوة بعمق شديد واقترح أفضل الحلول.',
        'bug-hunter': 'أنت خبير في اكتشاف الأخطاء. ابحث عن أي مشاكل محتملة في كل خطوة وأصلحها.',
        'performance-optimizer': 'أنت خبير في تحسين الأداء. ركز على تحسين سرعة وكفاءة الكود في كل خطوة.',
        'creative-mode': 'أنت خبير إبداعي. اقترح حلولاً مبتكرة وجميلة في كل خطوة.',
        'code-research': 'أنت باحث في الكود. اشرح كل جزء بتفصيل وقدم معلومات شاملة.',
        'self-development': 'أنت نظام تطوير ذاتي. حسن الكود باستمرار واقترح تطويرات إضافية.'
      };
      
      const specialPrompt = modePrompts[mode] || '';
      
      // إضافة رسالة تشير إلى الوضع المختار
      _createMessageElement(`🎯 تم تنشيط ${mode === 'deep-thinking' ? 'التفكير العميق' : 
                           mode === 'bug-hunter' ? 'مطارد الأخطاء' : 
                           mode === 'performance-optimizer' ? 'محسن الأداء' : 
                           mode === 'creative-mode' ? 'الوضع الإبداعي' : 
                           mode === 'code-research' ? 'الباحث في الكود' : 
                           'التطوير الذاتي'}...`, 'ai');
      
      return executeTaskPlan(tasks, '', prompt, specialPrompt);
    }
    
    function init() {
      loadState();
      
      chatForm.addEventListener('submit', handleSendMessage);
      previewBtn.addEventListener('click', showPreview);
      applyBtn.addEventListener('click', applyChanges);
      closePreviewBtn.addEventListener('click', hidePreview);
      
      // أحداث الأدوات
      toolsBtn.addEventListener('click', toggleToolsMenu);
      
      // إخفاء القائمة عند النقر خارجها
      document.addEventListener('click', (e) => {
        if (!toolsBtn.contains(e.target) && !toolsMenu.contains(e.target)) {
          toolsMenu.style.display = 'none';
          toolsBtn.classList.remove('active');
        }
      });
      
      // تحديد الأدوات
      document.querySelectorAll('.tool-item').forEach(item => {
        item.addEventListener('click', () => {
          const mode = item.dataset.mode;
          selectTool(mode);
        });
      });
      
      // إزالة الأداة النشطة
      clearToolBtn.addEventListener('click', () => {
        selectTool('normal');
      });

      undoBtn.addEventListener('click', undo);
      redoBtn.addEventListener('click', redo);

      // AI Discussion Modal events
      improveBtn.addEventListener('click', () => {
        aiDiscussionContent.innerHTML = '<div style="text-align:center; padding:2rem;">جاري بدء النقاش البرمجي بين الذكاءين الاصطناعيين...</div>';
        aiDiscussionModal.style.display = 'flex';
        applyImprovedBtn.style.display = 'none';
        stopDiscussionBtn.disabled = false;
        stopDiscussionBtn.textContent = 'إيقاف الجولات';
        startAIDiscussionLoop();
      });
      closeDiscussionBtn.addEventListener('click', () => {
        aiDiscussionModal.style.display = 'none';
      });
      stopDiscussionBtn.addEventListener('click', () => {
        stopAIDiscussion = true;
        stopDiscussionBtn.disabled = true;
        stopDiscussionBtn.textContent = 'تم الإيقاف';
      });

      taskHeader.addEventListener('click', () => {
        taskProgressContainer.classList.toggle('collapsed');
      });
      
      promptInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            chatForm.requestSubmit();
        }
      });

      // Allow user to edit code manually
      codeDisplay.addEventListener('input', () => {
        const session = sessions[currentSessionId];
        if (!session) return;
        const newCode = codeDisplay.textContent;
        session.codeHistory[session.historyIndex] = newCode;
        saveState();
        hljs.highlightElement(codeDisplay); // إعادة تلوين الكود بعد كل تعديل يدوي
      });
    }

    init();
  </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
