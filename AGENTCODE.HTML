<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Code Editor</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/tomorrow-night-blue.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

  <style>
    :root {
      --bg-color: #0a0a0b;
      --panel-bg-color: #181821;
      --border-color: #2a2a36;
      --text-color: #e8e8f0;
      --primary-color: #7c3aed;
      --primary-hover-color: #6d28d9;
      --secondary-color: #06b6d4;
      --secondary-hover-color: #0891b2;
      --accent-color: #f59e0b;
      --accent-hover-color: #d97706;
      --input-bg-color: #1f1f2e;
      --header-bg-color: #131318;
      --button-bg-color: #2a2a36;
      --button-hover-bg-color: #3a3a48;
      --user-message-bg: linear-gradient(135deg, #7c3aed, #a855f7);
      --ai-message-bg: linear-gradient(135deg, #1f1f2e, #2a2a36);
      --task-bg-color: #1a1a24;
      --success-color: #10b981;
      --error-color: #ef4444;
      --warning-color: #f59e0b;
      --font-family: 'IBM Plex Sans Arabic', sans-serif;
      --font-mono: 'SF Mono', 'Fira Code', 'Menlo', monospace;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.6);
      --glass-bg: rgba(42, 42, 54, 0.8);
      --glass-border: rgba(255, 255, 255, 0.1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
      overflow: hidden;
    }

    body {
      background: linear-gradient(135deg, var(--bg-color) 0%, #0f0f1a 50%, var(--bg-color) 100%);
      color: var(--text-color);
      font-family: var(--font-family);
      display: flex;
      position: relative;
    }
    
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 20%, rgba(124, 58, 237, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(6, 182, 212, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 40% 60%, rgba(245, 158, 11, 0.05) 0%, transparent 50%);
      pointer-events: none;
      z-index: -1;
    }

    .app-container {
      display: flex;
      width: 100%;
      height: 100%;
    }

    .chat-panel, .editor-panel {
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .chat-panel {
      width: 40%;
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border-left: 1px solid var(--glass-border);
      padding: 0.75rem;
      gap: 0.75rem;
      position: relative;
    }
    
    .chat-panel::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--primary-color), transparent);
    }

    .editor-panel {
      width: 60%;
    }
    
    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border-color);
      gap: 0.5rem;
    }
    
    .panel-header h1 {
      font-size: 1.2rem;
      font-weight: 500;
      text-shadow: 0 0 8px rgba(0,0,0,0.5);
      flex: 1;
      text-align: center;
      margin: 0;
    }

    .header-icon-btn {
      background-color: var(--button-bg-color);
      border: 1px solid var(--border-color);
      color: var(--text-color);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      font-size: 1.5rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s ease;
    }
    .header-icon-btn:hover {
       background-color: var(--button-hover-bg-color);
    }
    
    .task-progress {
        background-color: var(--task-bg-color);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        flex-shrink: 0;
    }
    .task-header {
        padding: 0.75rem 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
    }
    .task-header > div {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-weight: 500;
    }
    .task-meta {
        display: flex;
        align-items: center;
        gap: 1rem;
        color: #888;
    }
    .chevron-icon {
        transition: transform 0.3s ease;
    }
    .task-progress.collapsed .chevron-icon {
        transform: rotate(-90deg);
    }
    .task-list {
        padding: 0 1rem 1rem 1rem;
        max-height: 500px;
        overflow: hidden;
        transition: max-height 0.3s ease, padding 0.3s ease;
    }
    .task-progress.collapsed .task-list {
        max-height: 0;
        padding-top: 0;
        padding-bottom: 0;
    }
    .task-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.5rem 0.5rem;
        color: #a0a0a0;
    }
    .task-icon {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
    }
    .task-icon .check-icon { color: var(--success-color); }
    .task-icon .error-icon { color: var(--error-color); }
    .task-icon .spinner {
       width: 16px; height: 16px;
       border: 2px solid rgba(255,255,255,0.3);
       border-top-color: var(--primary-color);
    }


    .messages-container {
      flex-grow: 1;
      overflow-y: auto;
      padding: 1rem;
    }
    
    .message {
      padding: 1rem 1.25rem;
      border-radius: 16px;
      margin-bottom: 1rem;
      max-width: 85%;
      line-height: 1.6;
      white-space: pre-wrap;
      position: relative;
      box-shadow: var(--shadow-sm);
      transition: all 0.3s ease;
    }

    .message:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .message.user {
      background: var(--user-message-bg);
      color: white;
      align-self: flex-start;
      margin-left: auto;
      border-bottom-left-radius: 6px;
    }

    .message.user::before {
      content: '';
      position: absolute;
      bottom: 0;
      right: -8px;
      width: 0;
      height: 0;
      border: 8px solid transparent;
      border-left-color: #a855f7;
      border-bottom: none;
    }

    .message.ai {
      background: var(--ai-message-bg);
      border: 1px solid var(--border-color);
      align-self: flex-end;
      margin-right: auto;
      border-bottom-right-radius: 6px;
    }

    .message.ai::before {
      content: '';
      position: absolute;
      bottom: 0;
      left: -8px;
      width: 0;
      height: 0;
      border: 8px solid transparent;
      border-right-color: var(--ai-message-bg);
      border-bottom: none;
    }
    
    .message.loading {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .spinner {
      width: 20px; height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: var(--primary-color);
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    #chat-form {
      border-top: 1px solid var(--border-color);
      background: var(--glass-bg);
      backdrop-filter: blur(12px);
      padding: 1rem;
      flex-shrink: 0;
      position: relative;
    }

    .input-container {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: var(--input-bg-color);
      border: 2px solid var(--border-color);
      border-radius: 12px;
      padding: 0.5rem;
      transition: all 0.3s ease;
      box-shadow: var(--shadow-sm);
    }

    .input-container:focus-within {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
    }

    .tools-button {
      background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
      color: white;
      border: none;
      border-radius: 8px;
      width: 40px;
      height: 40px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      box-shadow: var(--shadow-sm);
    }

    .tools-button:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    #prompt-input {
      flex-grow: 1;
      background: transparent;
      color: var(--text-color);
      border: none;
      padding: 0.75rem;
      font-family: inherit;
      resize: none;
      outline: none;
    }

    #send-button {
      background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
      color: white;
      border: none;
      border-radius: 8px;
      width: 50px;
      height: 40px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      box-shadow: var(--shadow-sm);
    }

    #send-button:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    #send-button:disabled {
      background: var(--button-bg-color);
      cursor: not-allowed;
      transform: none;
    }

    /* Tools Dropdown */
    .tools-dropdown {
      position: absolute;
      bottom: 100%;
      left: 1rem;
      right: 1rem;
      background: var(--panel-bg-color);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      box-shadow: var(--shadow-xl);
      backdrop-filter: blur(16px);
      z-index: 1000;
      margin-bottom: 0.5rem;
      overflow: hidden;
    }

    .tools-dropdown-header {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 1rem;
      font-weight: 600;
      text-align: center;
      font-size: 0.9rem;
    }

    .tool-option {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      background: none;
      border: none;
      color: var(--text-color);
      width: 100%;
      text-align: right;
      cursor: pointer;
      transition: all 0.3s ease;
      border-bottom: 1px solid var(--border-color);
    }

    .tool-option:last-child {
      border-bottom: none;
    }

    .tool-option:hover {
      background: var(--button-bg-color);
      transform: translateX(-4px);
    }

    .tool-icon {
      font-size: 1.5rem;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--glass-bg);
      border-radius: 8px;
      flex-shrink: 0;
    }

    .tool-info {
      flex: 1;
      text-align: right;
    }

    .tool-name {
      font-weight: 600;
      margin-bottom: 0.25rem;
      color: var(--text-color);
    }

    .tool-desc {
      font-size: 0.85rem;
      color: #888;
      line-height: 1.3;
    }

    .editor-header {
      display: flex; justify-content: space-between;
      align-items: center; padding: 0.75rem 1rem;
      background-color: #1e1e1e; flex-shrink: 0;
    }

    .editor-header h2 { font-size: 1rem; font-weight: 500; }
    .editor-toolbar { display: flex; gap: 0.5rem; align-items: center; }

    .editor-toolbar button {
      background-color: var(--button-bg-color);
      border: 1px solid var(--border-color);
      color: var(--text-color); padding: 0.5rem 1rem;
      border-radius: 5px; cursor: pointer;
      transition: background-color 0.2s ease;
      font-family: inherit; display: flex;
      align-items: center; gap: 0.5rem;
    }

    .editor-toolbar button:hover { background-color: var(--button-hover-bg-color); }
    .editor-toolbar button:disabled { background-color: #333; color: #777; cursor: not-allowed; border-color: #444; }
    .editor-toolbar button#apply-btn { background-color: var(--primary-color); color: white; }
    .editor-toolbar button#apply-btn:hover { background-color: var(--primary-hover-color); }

    .editor-content {
      flex-grow: 1;
      overflow: auto;
      background-color: #1e1e1e;
      display: flex;
      direction: ltr;
    }
    
    .line-numbers-gutter {
        flex-shrink: 0;
        padding: 1rem;
        font-family: var(--font-mono);
        font-size: 14px;
        line-height: 1.5;
        color: #888;
        text-align: right;
        user-select: none;
        background-color: var(--panel-bg-color);
        border-right: 1px solid var(--border-color);
    }

    #code-display {
      padding: 1rem;
      white-space: pre;
      font-family: var(--font-mono);
      font-size: 14px;
      line-height: 1.5;
      outline: none;
      flex-grow: 1;
    }
    
    .modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex; align-items: center; justify-content: center;
      z-index: 1000;
    }

    .modal-content {
      background-color: var(--bg-color);
      width: 90%; height: 90%;
      border-radius: 8px; display: flex; flex-direction: column;
      box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    }

    .modal-header {
      padding: 0.5rem 1rem; display: flex;
      justify-content: flex-end; background-color: var(--header-bg-color);
      border-bottom: 1px solid var(--border-color);
      border-top-left-radius: 8px; border-top-right-radius: 8px;
    }

    #close-preview-btn {
      background: none; border: none;
      color: var(--text-color); font-size: 1.5rem; cursor: pointer;
    }

    #preview-frame {
      width: 100%; height: 100%; border: none;
      flex-grow: 1; border-bottom-left-radius: 8px; border-bottom-right-radius: 8px;
    }
    
    /* Custom Highlight.js theme overrides to match image */
    #code-display.hljs {
      background: var(--bg-color);
      color: var(--text-color);
    }
    .hljs-comment {
      color: #7f848e;
    }
    .hljs-selector-tag,
    .hljs-selector-class,
    .hljs-selector-id {
      color: #98c379; /* Green for selectors */
    }
    .hljs-attribute {
      color: #56c4d8; /* Cyan for properties */
    }
    .hljs-number,
    .hljs-string,
    .hljs-literal,
    .hljs-attr { /* attr is for HTML attributes */
      color: #e5c07b; /* Orange for values and attributes */
    }
    .hljs-built_in {
      color: #56c4d8; /* Cyan for built-ins like var() */
    }
    .hljs-name, /* For HTML/XML tags */
    .hljs-tag {
      color: #e06c75; /* Soft red for tags */
    }
    .hljs-keyword {
      color: #c678dd; /* Purple for keywords */
    }
    .highlight-modified {
      background: rgba(52, 211, 153, 0.18); /* Ø´ÙØ§ÙØ© Ø£Ø®Ø¶Ø± */
      transition: background 0.5s;
    }
    .ai-step-code {
      background: #222;
      color: #fff;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      font-family: var(--font-mono);
      font-size: 13px;
      max-height: 220px;
      overflow: auto;
      margin-bottom: 0.5rem;
      direction: ltr;
      white-space: pre;
    }
    
    /* General modern enhancements */
    html {
      scroll-behavior: smooth;
    }

    /* Custom Scrollbar Styles */
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }

    ::-webkit-scrollbar-track {
      background: var(--panel-bg-color);
      border-radius: 5px;
    }

    ::-webkit-scrollbar-thumb {
      background: #555;
      border-radius: 5px;
      border: 2px solid var(--panel-bg-color);
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #777;
    }

    /* Better focus outline for accessibility and aesthetics */
    :focus-visible {
      outline: 2px solid var(--primary-color);
      outline-offset: 2px;
      border-radius: 3px; /* So it applies nicely to various shapes */
    }

    /* Selection highlight color */
    ::selection {
      background-color: var(--primary-color);
      color: white;
    }

    /* Enhance inputs and textareas */
    #prompt-input,
    #code-display[contenteditable="true"] {
      border: 1px solid var(--border-color);
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    #prompt-input:focus,
    #code-display[contenteditable="true"]:focus {
      border-color: var(--primary-color);
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3), 0 0 0 1px var(--primary-color);
    }

    /* Enhance buttons */
    button {
      transition: background-color 0.2s ease, transform 0.1s ease;
    }

    button:active {
      transform: translateY(1px);
    }

    /* Panel and container styling for depth */
    .chat-panel,
    .task-progress,
    .modal-content {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .modal-content {
      border: 1px solid var(--border-color);
    }
    .chat-list {
      margin: 0.5rem 0 0.5rem 0;
      background: var(--panel-bg-color);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      max-height: 180px;
      overflow-y: auto;
      padding: 0.25rem 0.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    .chat-list-item {
      padding: 0.5rem 0.75rem;
      border-radius: 6px;
      cursor: pointer;
      color: var(--text-color);
      background: none;
      border: none;
      text-align: right;
      font-family: inherit;
      font-size: 1rem;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .chat-list-item.active {
      background: var(--primary-color);
      color: #fff;
      font-weight: bold;
    }
    .chat-list-item:hover:not(.active) {
      background: #333;
    }
    .chat-list-item .chat-icon {
      width: 18px;
      height: 18px;
      color: var(--primary-color);
      flex-shrink: 0;
    }
    .chat-list-overlay {
      position: fixed;
      top: 0; right: 0; bottom: 0; left: 0;
      background: rgba(0,0,0,0.35);
      z-index: 2000;
      display: none;
    }
    .chat-list-sidebar {
      position: fixed;
      top: 0; right: 0;
      width: 340px;
      max-width: 100vw;
      height: 100vh;
      background: var(--panel-bg-color);
      border-left: 1px solid var(--border-color);
      box-shadow: -2px 0 16px rgba(0,0,0,0.18);
      z-index: 2100;
      display: flex;
      flex-direction: column;
      transform: translateX(100%);
      transition: transform 0.3s cubic-bezier(.4,1.4,.6,1);
    }
    .chat-list-sidebar.open {
      transform: translateX(0);
    }
    .chat-list-sidebar-header {
      padding: 1rem 1.5rem 0.5rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border-color);
      background: var(--panel-bg-color);
    }
    .chat-list-sidebar-header h2 {
      font-size: 1.1rem;
      font-weight: 600;
      margin: 0;
      color: var(--primary-color);
    }
    .chat-list-sidebar-close {
      background: none;
      border: none;
      color: var(--text-color);
      font-size: 1.7rem;
      cursor: pointer;
      padding: 0 0.5rem;
    }
    .chat-list-sidebar-list {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem 1rem 1rem 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    .chat-list-item {
      padding: 0.5rem 0.75rem;
      border-radius: 6px;
      cursor: pointer;
      color: var(--text-color);
      background: none;
      border: none;
      text-align: right;
      font-family: inherit;
      font-size: 1rem;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .chat-list-item.active {
      background: var(--primary-color);
      color: #fff;
      font-weight: bold;
    }
    .chat-list-item:hover:not(.active) {
      background: #333;
    }
    .chat-list-item .chat-icon {
      width: 18px;
      height: 18px;
      color: var(--primary-color);
      flex-shrink: 0;
    }
    .chat-list-new-btn {
      margin: 1rem 1rem 0.5rem 1rem;
      background: var(--primary-color);
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 0.5rem 1.5rem;
      font-size: 1rem;
      font-family: inherit;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .chat-list-new-btn:hover {
      background: var(--primary-hover-color);
    }
    @media (max-width: 500px) {
      .chat-list-sidebar { width: 100vw; }
    }
  </style>
<link rel="stylesheet" href="/index.css">
</head>
<body>
  <div class="app-container">
    <div class="chat-panel">
      <header class="panel-header">
        <div style="flex:1;"></div>
        <h1 style="text-align:center; margin:0;">Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø°ÙƒÙŠ</h1>
        <div style="flex:1; display:flex; justify-content:flex-end;">
          <button id="chat-list-toggle-btn" class="header-icon-btn" title="Ø¹Ø±Ø¶ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª">
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
          </button>
        </div>

      </header>
      <div id="chat-list-overlay" class="chat-list-overlay"></div>
      <aside id="chat-list-sidebar" class="chat-list-sidebar">
        <div class="chat-list-sidebar-header">
          <h2>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª</h2>
          <button id="chat-list-sidebar-close" class="chat-list-sidebar-close" title="Ø¥ØºÙ„Ø§Ù‚">&times;</button>
        </div>

        <button id="chat-list-new-btn" class="chat-list-new-btn" style="margin:1rem 1rem 0.5rem 1rem; background:var(--primary-color); color:#fff; border:none; border-radius:6px; padding:0.5rem 1.5rem; font-size:1rem; font-family:inherit; font-weight:500; cursor:pointer; transition:background 0.2s; display:flex; align-items:center; gap:0.5rem;">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
          Ø¯Ø±Ø¯Ø´Ø© Ø¬Ø¯ÙŠØ¯Ø©
        </button>
        <div id="chat-list-sidebar-list" class="chat-list-sidebar-list"></div>
        <button id="delete-chats-btn" style="background:#f87171; color:#fff; border:none; border-radius:6px; padding:0.5rem 1.5rem; font-size:1rem; font-family:inherit; font-weight:500; cursor:pointer; margin:1rem;">Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª</button>
      </aside>

      <div class="task-progress" id="task-progress-container" style="display: none;">
        <header class="task-header" id="task-header">
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="check-icon"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                <span id="task-title">Ø®Ø·Ø© Ø§Ù„Ø¹Ù…Ù„</span>
            </div>
            <div class="task-meta">
                <span id="task-counter"></span>
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="chevron-icon"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </div>
        </header>
        <div class="task-list" id="task-list"></div>
      </div>

      <div class="messages-container" id="messages-container"></div>
      <form id="chat-form">
        <div class="input-container">
          <button type="button" id="tools-btn" class="tools-button" title="Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ·ÙˆÙŠØ±">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
            </svg>
          </button>
          <textarea id="prompt-input" placeholder="Ø§ÙƒØªØ¨ Ø·Ù„Ø¨Ùƒ Ù‡Ù†Ø§..." rows="1"></textarea>
          <button type="submit" id="send-button">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-send"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
          </button>
        </div>
        
        <!-- Tools Dropdown -->
        <div id="tools-dropdown" class="tools-dropdown" style="display: none;">
          <div class="tools-dropdown-header">
            <span>Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ·ÙˆÙŠØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</span>
          </div>
          <button class="tool-option" data-mode="self-development">
            <div class="tool-icon">ğŸš€</div>
            <div class="tool-info">
              <div class="tool-name">ØªØ·ÙˆÙŠØ± Ø°Ø§ØªÙŠ</div>
              <div class="tool-desc">ØªØ­Ø³ÙŠÙ† ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ø³ØªÙ…Ø± Ù„Ù„ÙƒÙˆØ¯</div>
            </div>
          </button>
          <button class="tool-option" data-mode="deep-thinking">
            <div class="tool-icon">ğŸ§ </div>
            <div class="tool-info">
              <div class="tool-name">ØªÙÙƒÙŠØ± Ø¹Ù…ÙŠÙ‚</div>
              <div class="tool-desc">ØªØ­Ù„ÙŠÙ„ Ø´Ø§Ù…Ù„ ÙˆÙ…ÙØµÙ„ Ù„Ù„Ù…Ø´ÙƒÙ„Ø©</div>
            </div>
          </button>
          <button class="tool-option" data-mode="code-research">
            <div class="tool-icon">ğŸ”</div>
            <div class="tool-info">
              <div class="tool-name">Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ÙƒÙˆØ¯</div>
              <div class="tool-desc">ØªØ­Ù„ÙŠÙ„ ÙˆÙÙ‡Ù… Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯</div>
            </div>
          </button>
          <button class="tool-option" data-mode="bug-hunter">
            <div class="tool-icon">ğŸ›</div>
            <div class="tool-info">
              <div class="tool-name">Ù…Ø·Ø§Ø±Ø¯ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡</div>
              <div class="tool-desc">Ø§Ù„Ø¨Ø­Ø« ÙˆØ¥ØµÙ„Ø§Ø­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</div>
            </div>
          </button>
          <button class="tool-option" data-mode="performance-optimizer">
            <div class="tool-icon">âš¡</div>
            <div class="tool-info">
              <div class="tool-name">Ù…Ø­Ø³Ù† Ø§Ù„Ø£Ø¯Ø§Ø¡</div>
              <div class="tool-desc">ØªØ­Ø³ÙŠÙ† Ø³Ø±Ø¹Ø© ÙˆØ£Ø¯Ø§Ø¡ Ø§Ù„ÙƒÙˆØ¯</div>
            </div>
          </button>
                     <button class="tool-option" data-mode="creative-mode">
             <div class="tool-icon">ğŸ¨</div>
             <div class="tool-info">
               <div class="tool-name">Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø¨Ø¯Ø§Ø¹ÙŠ</div>
               <div class="tool-desc">Ø­Ù„ÙˆÙ„ Ø¥Ø¨Ø¯Ø§Ø¹ÙŠØ© ÙˆÙ…Ø¨ØªÙƒØ±Ø©</div>
             </div>
           </button>
           <div style="border-top: 1px solid var(--border-color); margin: 0.5rem 0;"></div>
           <button class="tool-option" data-mode="normal">
             <div class="tool-icon">ğŸ”„</div>
             <div class="tool-info">
               <div class="tool-name">Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø§Ø¯ÙŠ</div>
               <div class="tool-desc">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ</div>
             </div>
           </button>
         </div>
      </form>
    </div>

    <div class="editor-panel">
      <header class="editor-header">
        <div class="editor-toolbar">
           <button id="undo-btn" title="Ø±Ø¬ÙˆØ¹">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 9H8a5 5 0 0 0-5 5v0a5 5 0 0 0 5 5h10"></path><polyline points="12 13 8 9 12 5"></polyline></svg>

            </button>
            <button id="redo-btn" title="ØªÙ‚Ø¯Ù…">

                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9h13a5 5 0 0 1 5 5v0a5 5 0 0 1-5 5H5"></path><polyline points="12 5 16 9 12 13"></polyline></svg>
            </button>
             <div style="width:1px; height: 24px; background-color: var(--border-color); margin: 0 0.5rem;"></div>
          <button id="preview-btn" title="Ù…Ø¹Ø§ÙŠÙ†Ø©">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z"></path><circle cx="12" cy="12" r="3"></circle></svg>
          </button>
          <button id="improve-btn" title="ØªØ·ÙˆÙŠØ±">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3v2m6.364 1.636l-1.414 1.414M21 12h-2M17.364 17.364l-1.414-1.414M12 21v-2M6.636 17.364l1.414-1.414M3 12h2M6.636 6.636l1.414 1.414M12 8a4 4 0 1 1 0 8 4 4 0 0 1 0-8z"></path></svg>
          </button>
          <button id="self-improve-btn" title="ØªØ·ÙˆÙŠØ± Ø°Ø§ØªÙŠ">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
          </button>
          <button id="apply-btn" title="ØªØ·Ø¨ÙŠÙ‚ ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
          </button>
        </div>
        <h2>Ù…Ø­Ø±Ø± Ø§Ù„ÙƒÙˆØ¯</h2>
      </header>
      <div class="editor-content">
        <div id="line-numbers" class="line-numbers-gutter"></div>
        <pre id="code-display" class="language-html" contenteditable="true" tabindex="0"></pre>
      </div>
    </div>
  </div>

  <div id="preview-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <button id="close-preview-btn">&times;</button>
      </div>
      <iframe id="preview-frame" title="Live Preview"></iframe>
    </div>
  </div>

  <!-- Modal for AI Discussion -->
  <div id="ai-discussion-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 800px; max-height: 90vh;">
      <div class="modal-header">
        <button id="close-discussion-btn">&times;</button>
      </div>
      <div id="ai-discussion-content" style="flex:1; overflow-y:auto; padding:1rem; direction:ltr; background:var(--bg-color); color:var(--text-color); font-family:var(--font-mono); font-size:15px; border-radius:8px; min-height:200px;"></div>
      <div id="ai-discussion-actions" style="padding:1rem; text-align:left;">
        <button id="stop-discussion-btn" style="background:var(--error-color); color:white; border:none; border-radius:6px; padding:0.5rem 1.5rem; font-size:1rem; cursor:pointer; margin-left:0.5rem;">Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¬ÙˆÙ„Ø§Øª</button>
        <button id="apply-improved-btn" style="display:none; background:var(--primary-color); color:white; border:none; border-radius:6px; padding:0.5rem 1.5rem; font-size:1rem; cursor:pointer;">Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ø­Ø³Ù†</button>
      </div>
    </div>
  </div>

  <script type="importmap">
    {
      "imports": {
        "@google/genai": "https://esm.sh/@google/genai@^0.12.0"
      }
    }
  </script>
  <script type="module">
    import { GoogleGenAI, Type } from "@google/genai";

    // --- API KEYS ROTATION LOGIC ---
    const API_KEYS = [
      "AIzaSyBd6z7ru09s2hbI7c-9PrF34gjR9r4o5iE",
      "AIzaSyCYlSM0arXvt1GMnsUMIPrTF4T3U-jsxKI",
      "AIzaSyBA5fBhhxIRuJxG9kNPu1JQ8wLMce9p_bg",
      "AIzaSyCJhj0oJaRQeKudyDyvtSf-fz-xbpL-Mm8",
      "AIzaSyBQOFjawlE69tA4Nuuq_hpyX2KPMsXzXDw",
      "AIzaSyBJvsgVcIoJHPkoO8Ru1-maazHlS_efXUI"
    ];
    let apiKeyIndex = 0;
    function getNextApiKey() {
      const key = API_KEYS[apiKeyIndex];
      apiKeyIndex = (apiKeyIndex + 1) % API_KEYS.length;
      return key;
    }
    // Ø¯Ø§Ù„Ø© ØªØºÙ„Ù Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ GoogleGenAI ÙˆØªØ¹ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø¸Ù‡ÙˆØ± Ø®Ø·Ø£ quota
    async function callGenAI(fn) {
      let lastError;
      for (let i = 0; i < API_KEYS.length; i++) {
        const ai = new GoogleGenAI({ apiKey: getNextApiKey() });
        try {
          return await fn(ai);
        } catch (err) {
          lastError = err;
          if (err && err.message && /quota|exceeded|API key/i.test(err.message)) {
            continue; // Ø¬Ø±Ø¨ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„ØªØ§Ù„ÙŠ
          } else {
            throw err;
          }
        }
      }
      throw lastError || new Error("All API keys quota exceeded or failed.");
    }

    const API_KEY = "AIzaSyCYlSM0arXvt1GMnsUMIPrTF4T3U-jsxKI";
    if (!API_KEY) {
        document.body.innerHTML = `<div style="color:red; padding: 2rem; text-align: right; font-size: 1.2rem;">Ø®Ø·Ø£: Ù…ØªØºÙŠØ± Ø§Ù„Ø¨ÙŠØ¦Ø© API_KEY ØºÙŠØ± Ù…Ø¹ÙŠÙ†. Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.</div>`;
        throw new Error("API key not found");
    }
    const ai = new GoogleGenAI({ apiKey: API_KEY });

    // DOM Elements
    const codeDisplay = document.getElementById('code-display');
    const lineNumbersGutter = document.getElementById('line-numbers');
    const messagesContainer = document.getElementById('messages-container');
    const chatForm = document.getElementById('chat-form');
    const promptInput = document.getElementById('prompt-input');
    const sendButton = document.getElementById('send-button');
    const toolsBtn = document.getElementById('tools-btn');
    const toolsDropdown = document.getElementById('tools-dropdown');
    const previewBtn = document.getElementById('preview-btn');
    const improveBtn = document.getElementById('improve-btn');
    const selfImproveBtn = document.getElementById('self-improve-btn');
    const applyBtn = document.getElementById('apply-btn');
    const previewModal = document.getElementById('preview-modal');
    const closePreviewBtn = document.getElementById('close-preview-btn');
    const previewFrame = document.getElementById('preview-frame');

    const taskProgressContainer = document.getElementById('task-progress-container');
    const taskHeader = document.getElementById('task-header');
    const taskList = document.getElementById('task-list');
    const taskCounter = document.getElementById('task-counter');
    const undoBtn = document.getElementById('undo-btn');
    const redoBtn = document.getElementById('redo-btn');
    // AI Discussion Modal Elements
    const aiDiscussionModal = document.getElementById('ai-discussion-modal');
    const closeDiscussionBtn = document.getElementById('close-discussion-btn');
    const aiDiscussionContent = document.getElementById('ai-discussion-content');
    const applyImprovedBtn = document.getElementById('apply-improved-btn');
    const stopDiscussionBtn = document.getElementById('stop-discussion-btn');
    const chatListSidebar = document.getElementById('chat-list-sidebar');
    const chatListSidebarList = document.getElementById('chat-list-sidebar-list');
    const chatListSidebarClose = document.getElementById('chat-list-sidebar-close');

    const chatListToggleBtn = document.getElementById('chat-list-toggle-btn');
    const chatListOverlay = document.getElementById('chat-list-overlay'); // ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø±
    const chatListNewBtn = document.getElementById('chat-list-new-btn');
    const deleteChatsBtn = document.getElementById('delete-chats-btn');

    // App State
    let sessions = {};
    let currentSessionId = null;
    const initialCode = ''; // Start with a blank slate
    let currentMode = 'normal'; // Ù†Ù…Ø· Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ
    let isProcessing = false; // Ù„Ù…Ù†Ø¹ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…ØªØ¯Ø§Ø®Ù„Ø©
    let errorRetryCount = 0; // Ø¹Ø¯Ø§Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
    const maxRetries = 3; // Ø£Ù‚ØµÙ‰ Ø¹Ø¯Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø§Øª
    
    // Ù†Ø¸Ø§Ù… Ø§Ù„ÙˆÙƒÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…
    class SmartAgent {
      constructor() {
        this.memory = [];
        this.context = '';
        this.currentTask = null;
        this.errorHistory = [];
        this.learningData = [];
      }
      
      // ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© ÙˆÙÙ‡Ù… Ø§Ù„Ø³ÙŠØ§Ù‚
      async analyzeContext(userInput, currentCode) {
        const analysisPrompt = `Ø£Ù†Øª ÙˆÙƒÙŠÙ„ Ø°ÙƒÙŠ Ù…ØªÙ‚Ø¯Ù…. Ø­Ù„Ù„ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆØ§Ø³ØªØ®Ø±Ø¬ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©:
        
Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${userInput}
Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ: ${currentCode || 'ÙØ§Ø±Øº'}
Ø§Ù„Ø³ÙŠØ§Ù‚ Ø§Ù„Ø³Ø§Ø¨Ù‚: ${this.context}

ÙŠØ¬Ø¨ Ø£Ù† ØªØ­Ø¯Ø¯:
1. Ù†ÙˆØ¹ Ø§Ù„Ù…Ù‡Ù…Ø© (Ø¥Ù†Ø´Ø§Ø¡ØŒ ØªØ¹Ø¯ÙŠÙ„ØŒ Ø¥ØµÙ„Ø§Ø­ØŒ ØªØ­Ø³ÙŠÙ†)
2. Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ¹Ù‚ÙŠØ¯ (Ø¨Ø³ÙŠØ·ØŒ Ù…ØªÙˆØ³Ø·ØŒ Ù…Ø¹Ù‚Ø¯)
3. Ø§Ù„ØªÙ‚Ù†ÙŠØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
4. Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø©
5. Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø§Ù„ØªÙ†ÙÙŠØ°`;

        try {
          const analysis = await callGenAI(ai => ai.models.generateContent({
            model: 'gemini-2.5-flash',
            contents: analysisPrompt,
            config: {
              responseMimeType: "application/json",
              responseSchema: {
                type: Type.OBJECT,
                properties: {
                  task_type: { type: Type.STRING },
                  complexity: { type: Type.STRING },
                  technologies: { type: Type.ARRAY, items: { type: Type.STRING } },
                  risks: { type: Type.ARRAY, items: { type: Type.STRING } },
                  strategy: { type: Type.STRING }
                }
              }
            }
          }));
          return JSON.parse(analysis.text);
        } catch (error) {
          return this.handleError(error, 'ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³ÙŠØ§Ù‚');
        }
      }
      
      // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ÙˆØ§Ù„ØªØ¹Ø§ÙÙŠ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
      handleError(error, operation) {
        this.errorHistory.push({ error: error.message, operation, timestamp: Date.now() });
        errorRetryCount++;
        
        if (errorRetryCount <= maxRetries) {
          console.log(`Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© ØªÙ†ÙÙŠØ° ${operation} - Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ${errorRetryCount}`);
          return { error: true, retry: true, message: error.message };
        } else {
          console.log(`ÙØ´Ù„ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ ${operation} Ø¨Ø¹Ø¯ ${maxRetries} Ù…Ø­Ø§ÙˆÙ„Ø§Øª`);
          errorRetryCount = 0;
          return { error: true, retry: false, message: error.message };
        }
      }
      
      // ØªØ¹Ù„Ù… Ù…Ù† Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
      learnFromInteraction(input, output, success) {
        this.learningData.push({
          input,
          output,
          success,
          timestamp: Date.now(),
          mode: currentMode
        });
        
        // Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø¢Ø®Ø± 50 ØªÙØ§Ø¹Ù„ ÙÙ‚Ø·
        if (this.learningData.length > 50) {
          this.learningData = this.learningData.slice(-50);
        }
      }
      
      // ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„ØªØ¹Ù„Ù…
      getOptimizedStrategy(taskType) {
        const successfulInteractions = this.learningData.filter(
          data => data.success && data.input.includes(taskType)
        );
        
        if (successfulInteractions.length > 0) {
          const lastSuccessful = successfulInteractions[successfulInteractions.length - 1];
          return lastSuccessful.output;
        }
        
        return null;
      }
    }
    
    const smartAgent = new SmartAgent();

    function saveState() {
        localStorage.setItem('ai-code-editor-sessions', JSON.stringify(sessions));
        localStorage.setItem('ai-code-editor-last-session', currentSessionId);
    }

    function loadState() {
        const savedSessions = localStorage.getItem('ai-code-editor-sessions');
        const lastSessionId = localStorage.getItem('ai-code-editor-last-session');
        
        if (savedSessions) {
            sessions = JSON.parse(savedSessions);
            if (lastSessionId && sessions[lastSessionId]) {
                currentSessionId = lastSessionId;
            } else {
                const sessionIds = Object.keys(sessions);
                currentSessionId = sessionIds.length > 0 ? sessionIds[sessionIds.length - 1] : null;
            }
        }

        if (!currentSessionId) {
            startNewChat();
        } else {
            renderCurrentSession();
            renderChatList();
        }
    }
    
    function startNewChat() {
        console.log('Ø¥Ù†Ø´Ø§Ø¡ Ø¯Ø±Ø¯Ø´Ø© Ø¬Ø¯ÙŠØ¯Ø©...');
        const newId = Date.now().toString();
        sessions[newId] = {
            id: newId,
            messages: [{
                sender: 'ai',
                text: 'Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ! Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠ. ØµÙ Ù„ÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ ÙƒØªØ§Ø¨ØªÙ‡ØŒ ÙˆØ³Ø£Ø¨Ø¯Ø£ ÙÙˆØ±Ø§Ù‹.'
            }],
            codeHistory: [initialCode],
            historyIndex: 0
        };
        currentSessionId = newId;
        renderCurrentSession();
        renderChatList();
        saveState();
        console.log('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¯Ø±Ø¯Ø´Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ù†Ø¬Ø§Ø­');
    }
    
    function updateCodeAndView(code, highlightLines = []) {
        codeDisplay.textContent = code;
        hljs.highlightElement(codeDisplay);
        
        const lineCount = code.split('\n').length;
        lineNumbersGutter.innerHTML = Array.from({length: lineCount}, (_, i) => i + 1).join('<br>');

        // Highlight modified lines
        if (highlightLines.length > 0) {
          // Wait for DOM update
          setTimeout(() => {
            const codeHtml = codeDisplay.innerHTML.split('\n');
            for (const lineNum of highlightLines) {
              if (codeHtml[lineNum - 1] !== undefined) {
                codeHtml[lineNum - 1] = `<span class="highlight-modified">${codeHtml[lineNum - 1]}</span>`;
              }
            }
            codeDisplay.innerHTML = codeHtml.join('\n');
            // Remove highlight after 1.5s
            setTimeout(() => {
              codeDisplay.innerHTML = codeDisplay.innerHTML.replace(/<span class="highlight-modified">(.*?)<\/span>/g, '$1');
            }, 1500);
          }, 0);
        }
    }

    function renderCurrentSession() {
        if (!currentSessionId || !sessions[currentSessionId]) return;
        const session = sessions[currentSessionId];

        messagesContainer.innerHTML = '';
        session.messages.forEach(message => {
            _createMessageElement(message.text, message.sender);
        });
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        const currentCode = session.codeHistory[session.historyIndex];
        updateCodeAndView(currentCode);
        updateUndoRedoButtons();
        
        taskProgressContainer.style.display = 'none';
        renderChatList();
    }

    function _createMessageElement(text, sender, isLoading = false) {
      const messageEl = document.createElement('div');
      messageEl.classList.add('message', sender);
      
      if (isLoading) {
        messageEl.classList.add('loading');
        messageEl.innerHTML = `<div class="spinner"></div><span>${text}</span>`;
      } else if (sender === 'ai' && text.startsWith('Ø§Ù„ÙƒÙˆØ¯ Ø¨Ø¹Ø¯ ØªÙ†ÙÙŠØ° Ø§Ù„Ø®Ø·ÙˆØ©:')) {
        // Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ Ù…Ø±Ø¨Ø¹ Ù…ØªÙ‚Ù„Øµ ÙˆØ¬Ù…ÙŠÙ„
        const code = text.replace(/^Ø§Ù„ÙƒÙˆØ¯ Ø¨Ø¹Ø¯ ØªÙ†ÙÙŠØ° Ø§Ù„Ø®Ø·ÙˆØ©:\s*/,'');
        messageEl.innerHTML = `<div style="margin-bottom:0.5rem; color:#aaa; font-size:13px;">Ø§Ù„ÙƒÙˆØ¯ Ø¨Ø¹Ø¯ ØªÙ†ÙÙŠØ° Ø§Ù„Ø®Ø·ÙˆØ©:</div><pre class="ai-step-code"><code>${code.replace(/[&<>]/g, function(tag) {
          const charsToReplace = { '&': '&amp;', '<': '&lt;', '>': '&gt;' };
          return charsToReplace[tag] || tag;
        })}</code></pre>`;
      } else if (sender === 'ai' && sessions[currentSessionId] && sessions[currentSessionId].messages[sessions[currentSessionId].messages.length-1]?.text === text) {
        // Typewriter effect ONLY for the latest AI message
        let i = 0;
        messageEl.textContent = '';
        function typeWriter() {
          if (i < text.length) {
            messageEl.textContent += text.charAt(i);
            i++;
            setTimeout(typeWriter, 12 + Math.random() * 30);
          }
        }
        typeWriter();
      } else {
        messageEl.textContent = text;
      }
      
      messagesContainer.appendChild(messageEl);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
      return messageEl;
    }
    
    function addMessageToState(text, sender) {
        sessions[currentSessionId].messages.push({ text, sender });
        saveState();
    }
    
    function addCodeToHistory(newCode) {
        const session = sessions[currentSessionId];
        if (session.historyIndex < session.codeHistory.length - 1) {
            session.codeHistory = session.codeHistory.slice(0, session.historyIndex + 1);
        }
        session.codeHistory.push(newCode);
        session.historyIndex = session.codeHistory.length - 1;
        updateUndoRedoButtons();
        saveState();
    }

    function updateUndoRedoButtons() {
        const session = sessions[currentSessionId];
        undoBtn.disabled = session.historyIndex <= 0;
        redoBtn.disabled = session.historyIndex >= session.codeHistory.length - 1;
    }

    function undo() {
        const session = sessions[currentSessionId];
        if (session.historyIndex > 0) {
            session.historyIndex--;
            const code = session.codeHistory[session.historyIndex];
            updateCodeAndView(code);
            updateUndoRedoButtons();
            saveState();
        }
    }

    function redo() {
        const session = sessions[currentSessionId];
        if (session.historyIndex < session.codeHistory.length - 1) {
            session.historyIndex++;
            const code = session.codeHistory[session.historyIndex];
            updateCodeAndView(code);
            updateUndoRedoButtons();
            saveState();
        }
    }


    async function handleSendMessage(e) {
      e.preventDefault();
      
      if (isProcessing) {
        _createMessageElement('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©... ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±', 'ai');
        return;
      }
      
      isProcessing = true;
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ù† Ø§Ù„Ù…Ø­Ø±Ø± Ù‚Ø¨Ù„ Ø£ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø©
      const session = sessions[currentSessionId];
      if (session) {
        session.codeHistory[session.historyIndex] = codeDisplay.textContent;
        saveState();
      }
      
      const prompt = promptInput.value.trim();
      if (!prompt) {
        isProcessing = false;
        return;
      }

      const currentCode = codeDisplay.textContent;
      
      // ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³ÙŠØ§Ù‚ Ø¨Ø§Ù„ÙˆÙƒÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ
      const analysis = await smartAgent.analyzeContext(prompt, currentCode);
      if (analysis.error && !analysis.retry) {
        _createMessageElement(`ÙØ´Ù„ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø©: ${analysis.message}`, 'ai');
        isProcessing = false;
        return;
      }
      
      // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
      if (!analysis.error) {
        _createMessageElement(`ğŸ” ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø©:
Ù†ÙˆØ¹ Ø§Ù„Ù…Ù‡Ù…Ø©: ${analysis.task_type}
Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ¹Ù‚ÙŠØ¯: ${analysis.complexity}
Ø§Ù„ØªÙ‚Ù†ÙŠØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: ${analysis.technologies?.join(', ')}
Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø§Ù„ØªÙ†ÙÙŠØ°: ${analysis.strategy}`, 'ai');
      }

      _createMessageElement(prompt, 'user');
      addMessageToState(prompt, 'user');
      
      // ØªÙˆÙ„ÙŠØ¯ Ø¹Ù†ÙˆØ§Ù† Ù„Ù„Ø¯Ø±Ø¯Ø´Ø© Ø¨Ø¹Ø¯ Ø£ÙˆÙ„ Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      if (session.messages.length === 2) { // Ø£ÙˆÙ„ Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        try {
          const titlePrompt = `Ø§Ù‚ØªØ±Ø­ Ø¹Ù†ÙˆØ§Ù†Ù‹Ø§ Ù…Ø®ØªØµØ±Ù‹Ø§ (3-6 ÙƒÙ„Ù…Ø§Øª) ÙŠØµÙ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªØ§Ù„ÙŠ Ø¨Ø´ÙƒÙ„ ÙˆØ§Ø¶Ø­ØŒ Ø¨Ø¯ÙˆÙ† Ø¹Ù„Ø§Ù…Ø§Øª ØªØ±Ù‚ÙŠÙ… Ø¥Ø¶Ø§ÙÙŠØ© Ø£Ùˆ Ø±Ù…ÙˆØ²ØŒ ÙÙ‚Ø· Ù†Øµ ÙˆØ§Ø¶Ø­:
\n\n${prompt}`;
          callGenAI(ai => ai.models.generateContent({
            model: 'gemini-2.5-flash',
            contents: titlePrompt
          })).then(titleRes => {
            let title = titleRes.text.trim().replace(/[\n\r]+/g, ' ');
            if (title.length > 32) title = title.slice(0, 32) + 'â€¦';
            session.title = title;
            saveState();
            renderChatList();
          }).catch(e => { 
            console.log('ÙØ´Ù„ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:', e);
          });
        } catch (e) { 
          console.log('ÙØ´Ù„ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:', e);
        }
      }
      
      promptInput.value = '';
      promptInput.disabled = true;
      sendButton.disabled = true;
      const loadingMessage = _createMessageElement('Ø£Ø­Ù„Ù„ Ø·Ù„Ø¨Ùƒ...', 'ai', true);

      try {
        const session = sessions[currentSessionId];
        const formattedHistory = session.messages.map(m => `${m.sender === 'user' ? 'Ù…Ø³ØªØ®Ø¯Ù…' : 'Ù…Ø³Ø§Ø¹Ø¯'}: ${m.text}`).join('\n\n');

        const planningPrompt = `You are an intelligent AI assistant. Your responses must be in Arabic.\nBased on the full conversation history provided below, analyze ONLY the latest user request.\n\nConversation History:\n---\n${formattedHistory}\n---\n\nCurrent Code:\n---\n${currentCode || '(empty)'}\n---\n\nBased on this latest request, decide if it is a 'code_modification' or a 'general_question'.\n- If it's a 'code_modification', create a step-by-step plan. The tasks in the plan MUST be in Arabic.\n- If it's a 'general_question', provide a direct, helpful answer in Arabic, taking the full conversation history into account for context.\n\nÙ…Ù„Ø§Ø­Ø¸Ø© Ù‡Ø§Ù…Ø©: ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù†Ø§ØªØ¬ Ø¹Ø¨Ø§Ø±Ø© Ø¹Ù† Ù…Ù„Ù HTML ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·ØŒ ÙˆÙŠØ­ØªÙˆÙŠ Ø¨Ø¯Ø§Ø®Ù„Ù‡ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø£ÙƒÙˆØ§Ø¯ CSS ÙˆJavaScript Ø§Ù„Ù„Ø§Ø²Ù…Ø© Ø¯Ø§Ø®Ù„ ÙˆØ³ÙˆÙ… <style> Ùˆ<script>.`;

        const planningResponse = await callGenAI(ai => ai.models.generateContent({
            model: 'gemini-2.5-flash',
            contents: planningPrompt,
            config: {
                responseMimeType: "application/json",
                responseSchema: {
                    type: Type.OBJECT,
                    properties: {
                        request_type: { type: Type.STRING, enum: ["code_modification", "general_question"] },
                        tasks: {
                            type: Type.ARRAY,
                            items: { type: Type.STRING },
                            description: "Ù‚Ø§Ø¦Ù…Ø© Ù…Ù‡Ø§Ù… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©."
                        },
                        answer: { type: Type.STRING, description: "Ø¥Ø¬Ø§Ø¨Ø© Ù„Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø¹Ø§Ù… Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©." }
                    }
                }
            }
        }));
        
        loadingMessage.remove();
        const plan = JSON.parse(planningResponse.text);

        if (plan.request_type === 'general_question') {
            _createMessageElement(plan.answer, 'ai');
            addMessageToState(plan.answer, 'ai');
        } else if (plan.request_type === 'code_modification' && plan.tasks && plan.tasks.length > 0) {
            if (currentMode !== 'normal') {
              await executeAdvancedTaskPlan(plan.tasks, prompt, currentMode);
            } else {
              await executeTaskPlan(plan.tasks, formattedHistory, prompt);
            }
            
            // ØªØ³Ø¬ÙŠÙ„ Ù†Ø¬Ø§Ø­ Ø§Ù„ØªÙØ§Ø¹Ù„ Ù„Ù„ØªØ¹Ù„Ù…
            smartAgent.learnFromInteraction(prompt, 'Ù†Ø¬Ø­ ØªÙ†ÙÙŠØ° Ø§Ù„Ù…Ù‡Ø§Ù…', true);
        } else {
            const fallbackMsg = "Ù„Ù… Ø£ØªÙ…ÙƒÙ† Ù…Ù† ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨. Ù‡Ù„ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¹Ø§Ø¯Ø© ØµÙŠØ§ØºØ© Ø·Ù„Ø¨ÙƒØŸ";
             _createMessageElement(fallbackMsg, 'ai');
             addMessageToState(fallbackMsg, 'ai');
        }

      } catch (error) {
        console.error(error);
        loadingMessage.remove();
        
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø®Ø·Ø£ Ø¨Ø§Ù„ÙˆÙƒÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ
        const errorHandling = smartAgent.handleError(error, 'Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø©');
        if (errorHandling.retry) {
          _createMessageElement(`âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©... (Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ${errorRetryCount})`, 'ai');
          // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
          setTimeout(() => handleSendMessage(e), 2000);
          return;
        }
        
        const errorMsg = `âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: ${error.message}
        
ğŸ”§ Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø§Ù„Ø¥ØµÙ„Ø§Ø­:
- ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
- Ø¬Ø±Ø¨ Ø¥Ø¹Ø§Ø¯Ø© ØµÙŠØ§ØºØ© Ø§Ù„Ø·Ù„Ø¨
- Ø§Ø³ØªØ®Ø¯Ù… Ø£Ø­Ø¯ Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…ØªØ®ØµØµØ© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©`;
        _createMessageElement(errorMsg, 'ai');
        addMessageToState(errorMsg, 'ai');
        
        // ØªØ³Ø¬ÙŠÙ„ ÙØ´Ù„ Ø§Ù„ØªÙØ§Ø¹Ù„ Ù„Ù„ØªØ¹Ù„Ù…
        smartAgent.learnFromInteraction(prompt, error.message, false);
      } finally {
        isProcessing = false;
        promptInput.disabled = false;
        sendButton.disabled = false;
        promptInput.focus();
      }
    }
    
    async function executeTaskPlan(tasks, formattedHistory, originalPrompt, specialPrompt = '') {
        // Ø¥Ø¶Ø§ÙØ© Ø®Ø·ÙˆØ© CSS ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ø®Ø·ÙˆØ© ØªØµÙ…ÙŠÙ… Ø£Ùˆ CSS
        const hasCssStep = tasks.some(task => /css|ØªØµÙ…ÙŠÙ…|ØªÙ†Ø³ÙŠÙ‚|style|Ø³ØªØ§ÙŠÙ„/i.test(task));
        if (!hasCssStep) {
            tasks.unshift('Ø£Ø¶Ù ØªÙ†Ø³ÙŠÙ‚Ø§Øª CSS Ø­Ø¯ÙŠØ«Ø© ÙˆØ¬Ù…ÙŠÙ„Ø© Ù„Ù„Ù…ÙˆÙ‚Ø¹.');
        }
        renderTaskList(tasks);
        let currentCode = sessions[currentSessionId].codeHistory[sessions[currentSessionId].historyIndex];
        let completedTasks = 0;
        let lastModifiedLines = [];
        
        for (let i = 0; i < tasks.length; i++) {
            const taskDesc = tasks[i];
            updateTaskStatus(i, 'in-progress');
            const numberedCode = currentCode.split('\n').map((line, index) => `${index + 1}: ${line}`).join('\n');
            try {
                const executionPrompt = `You are a surgical code editing AI. ${specialPrompt} Your task is to modify the provided code to accomplish a specific task.\nYou MUST respond with ONLY the JSON object for the modification, without any explanation, description, or extra text.\nThe format is: { \"start_line\": number, \"end_line\": number, \"new_code\": \"string_of_new_code\" }\n- \"start_line\" and \"end_line\" are 1-based indices corresponding to the line numbers in the input.\n- To insert code at a specific line, set \"end_line\" to \"start_line - 1\". The code will be inserted before \"start_line\". For example, to insert at the beginning of the file, use start_line: 1, end_line: 0.\n- To delete lines, set \"new_code\" to an empty string \"\".\n- \"new_code\" should be a single string, with newlines represented by '\\n'.\n\nConversation History (for context):\n---\n${formattedHistory}\n---\n\nUser's original high-level request: \"${originalPrompt}\"\n\nThe specific, single task to execute now is: \"${taskDesc}\"\n\nCurrent Code (with 1-based line numbers):\n---\n${numberedCode || "(empty)"}\n---\n\nNow, provide ONLY the JSON object for the modification.`;

                const response = await callGenAI(ai => ai.models.generateContent({
                    model: "gemini-2.5-flash",
                    contents: executionPrompt,
                    config: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: Type.OBJECT,
                            properties: {
                                start_line: { type: Type.NUMBER, description: "The 1-based starting line number for the code modification." },
                                end_line: { type: Type.NUMBER, description: "The 1-based ending line number for the code modification." },
                                new_code: { type: Type.STRING, description: "The new code to insert/replace, with newlines as \\n." }
                            },
                            required: ["start_line", "end_line", "new_code"]
                        }
                    }
                }));
                const modification = JSON.parse(response.text);
                const { start_line, end_line, new_code } = modification;
                let codeLines = currentCode.split('\n');
                if (codeLines.length === 1 && codeLines[0] === '') {
                    codeLines = [];
                }
                const startIdx = start_line - 1;
                const endIdx = end_line - 1;
                const deleteCount = Math.max(0, endIdx - startIdx + 1);
                if (startIdx < -1 || startIdx > codeLines.length) {
                   throw new Error(`AI provided an invalid start line: ${start_line}. File has ${codeLines.length} lines.`);
                }
                const newCodeLines = (new_code === null || new_code === undefined) ? [] : new_code.split('\n');
                // Highlight the lines that will be modified (after the change)
                lastModifiedLines = [];
                if (newCodeLines.length > 0) {
                  for (let l = 0; l < newCodeLines.length; l++) {
                    lastModifiedLines.push(startIdx + 1 + l);
                  }
                }
                codeLines.splice(startIdx, deleteCount, ...newCodeLines);
                currentCode = codeLines.join('\n');
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ Ø§Ù„Ù…Ø­Ø±Ø± Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø¹Ø¯ ÙƒÙ„ Ø®Ø·ÙˆØ©
                updateCodeAndView(currentCode, lastModifiedLines);
                addCodeToHistory(currentCode);
                // Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù†Ø§ØªØ¬ Ø¨Ø¹Ø¯ ÙƒÙ„ Ø®Ø·ÙˆØ© ÙÙŠ Ø±Ø³Ø§Ù„Ø© AI
                _createMessageElement(`Ø§Ù„ÙƒÙˆØ¯ Ø¨Ø¹Ø¯ ØªÙ†ÙÙŠØ° Ø§Ù„Ø®Ø·ÙˆØ©: \n${currentCode}`, 'ai');
                addMessageToState(`Ø§Ù„ÙƒÙˆØ¯ Ø¨Ø¹Ø¯ ØªÙ†ÙÙŠØ° Ø§Ù„Ø®Ø·ÙˆØ©: \n${currentCode}`, 'ai');
                updateTaskStatus(i, 'completed');
                completedTasks++;
                taskCounter.textContent = `${completedTasks} / ${tasks.length}`;
            } catch(err) {
                console.error(`Error on task ${i}:`, err);
                const errorDetails = err.message || JSON.stringify(err);
                updateTaskStatus(i, 'failed', errorDetails);
                const failMsg = `ÙØ´Ù„Øª ÙÙŠ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ù‡Ù…Ø©: "${taskDesc}"\nØ§Ù„Ø³Ø¨Ø¨: ${errorDetails}`;
                _createMessageElement(failMsg, 'ai');
                addMessageToState(failMsg, 'ai');
                return; 
            }
        }
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¯Ø§Ù„Ø©
        const successMsg = 'Ù„Ù‚Ø¯ Ø£ÙƒÙ…Ù„Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù‡Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­.';
        _createMessageElement(successMsg, 'ai');
        addMessageToState(successMsg, 'ai');
    }

    function renderTaskList(tasks) {
        taskList.innerHTML = '';
        tasks.forEach((taskDesc, index) => {
            const taskItem = document.createElement('div');
            taskItem.className = 'task-item';
            taskItem.dataset.index = index;
            taskItem.innerHTML = `
                <div class="task-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="pending-icon"><circle cx="12" cy="12" r="10"></circle></svg>
                </div>
                <span>${taskDesc}</span>`;
            taskList.appendChild(taskItem);
        });
        taskCounter.textContent = `0 / ${tasks.length}`;
        taskProgressContainer.classList.remove('collapsed');
        taskProgressContainer.style.display = 'block';
    }

    function updateTaskStatus(index, status, errorMsg = '') {
        const taskItem = taskList.querySelector(`.task-item[data-index='${index}']`);
        if (!taskItem) return;
        const iconContainer = taskItem.querySelector('.task-icon');
        
        let iconHtml = '';
        switch (status) {
            case 'in-progress':
                iconHtml = `<div class="spinner"></div>`; break;
            case 'completed':
                iconHtml = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="check-icon"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
                taskItem.style.color = 'var(--success-color)'; break;
            case 'failed':
                iconHtml = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="error-icon"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>`;
                taskItem.style.color = 'var(--error-color)';
                taskItem.title = errorMsg; break;
        }
        iconContainer.innerHTML = iconHtml;
    }


    function showPreview() {
      const currentCode = sessions[currentSessionId].codeHistory[sessions[currentSessionId].historyIndex];
      previewFrame.srcdoc = currentCode;
      previewModal.style.display = 'flex';
    }

    function hidePreview() {
      previewModal.style.display = 'none';
      previewFrame.srcdoc = ''; 
    }

    function applyChanges() {
      if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ Ø³ÙŠØ¤Ø¯ÙŠ Ù‡Ø°Ø§ Ø¥Ù„Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯.")) {
        const newCode = sessions[currentSessionId].codeHistory[sessions[currentSessionId].historyIndex];
        const blob = new Blob([newCode], {type: 'text/html'});
        const url = URL.createObjectURL(blob);
        window.location.href = url;
      }
    }

    // ========== AI Discussion Logic ==========
    let stopAIDiscussion = false;
    async function startAIDiscussionLoop() {
      stopAIDiscussion = false;
      aiDiscussionContent.innerHTML = '';
      let ai1Memory = [];
      let ai2Memory = [];
      let currentCode = sessions[currentSessionId].codeHistory[sessions[currentSessionId].historyIndex];
      let improvedCode = currentCode;
      let round = 1;

      // Ø¥Ø¹Ø¯Ø§Ø¯ Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
      const ai1 = new GoogleGenAI({ apiKey: "AIzaSyCYlSM0arXvt1GMnsUMIPrTF4T3U-jsxKI" });
      const ai2 = new GoogleGenAI({ apiKey: "AIzaSyCJhj0oJaRQeKudyDyvtSf-fz-xbpL-Mm8" });

      while (!stopAIDiscussion) {
        // AI1: ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³Ù„Ø¨ÙŠØ§Øª
        const ai1Prompt = `Ø£Ù†Øª Ø®Ø¨ÙŠØ± ØªØ¬Ø±Ø¨Ø© Ù…Ø³ØªØ®Ø¯Ù… (UX) ÙˆÙ…Ù‡Ù…ØªÙƒ ØªØ­Ù„ÙŠÙ„ ÙƒÙˆØ¯ HTML Ø§Ù„ØªØ§Ù„ÙŠ ÙÙ‚Ø· Ù…Ù† Ù†Ø§Ø­ÙŠØ© ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŒ ÙˆØ°ÙƒØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ù„Ø¨ÙŠØ§Øª ÙˆØ§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ØªÙŠ Ù‚Ø¯ ØªØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø´ÙƒÙ„ Ù…Ù†Ø·Ù‚ÙŠ ÙˆÙ…Ù†Ù‡Ø¬ÙŠØŒ Ù…Ø¹ Ø§Ù‚ØªØ±Ø§Ø­ Ø®Ø·ÙˆØ§Øª Ø¹Ù…Ù„ ÙˆØ§Ø¶Ø­Ø© Ù„Ù„ØªØ­Ø³ÙŠÙ†. Ù„Ø§ ØªÙƒØªØ¨ Ø£ÙŠ ÙƒÙˆØ¯ØŒ ÙÙ‚Ø· Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙˆØ§Ù„Ø®Ø·ÙˆØ§Øª.\n\n${ai1Memory.length > 0 ? 'Ø³ÙŠØ§Ù‚ Ø³Ø§Ø¨Ù‚:\n' + ai1Memory.join('\n---\n') + '\n' : ''}Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ:\n---\n${improvedCode}\n---`;
        aiDiscussionContent.innerHTML += `<div style="margin-bottom:1rem;"><b>AI1 (ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³Ù„Ø¨ÙŠØ§Øª):</b><br><span style="color:#e06c75;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...</span></div>`;
        aiDiscussionContent.scrollTop = aiDiscussionContent.scrollHeight;
        let ai1Analysis = '';
        try {
          const ai1Res = await callGenAI(ai => ai.models.generateContent({
            model: 'gemini-2.5-flash',
            contents: ai1Prompt
          }));
          ai1Analysis = ai1Res.text.trim();
        } catch (err) {
          ai1Analysis = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ AI1: ' + err.message;
          stopAIDiscussion = true;
        }
        ai1Memory.push(ai1Analysis);
        aiDiscussionContent.innerHTML = aiDiscussionContent.innerHTML.replace('Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...', ai1Analysis.replace(/\n/g, '<br>'));
        aiDiscussionContent.scrollTop = aiDiscussionContent.scrollHeight;
        if (stopAIDiscussion) break;

        // AI2: ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª
        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø®Ø·ÙˆØ§Øª Ù…Ù† ØªØ­Ù„ÙŠÙ„ AI1
        let steps = [];
        const stepRegex = /(?:^|\n)\s*(?:\d+\.|-)[ \t]*(.+?)(?=\n|$)/g;
        let match;
        while ((match = stepRegex.exec(ai1Analysis)) !== null) {
          steps.push(match[1].trim());
        }
        if (steps.length === 0) {
          // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ…ÙƒÙ† Ù…Ù† Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø®Ø·ÙˆØ§ØªØŒ Ù†ÙØ° Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙƒÙ„Ù‡ Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©
            steps = [ai1Analysis];
        }
        for (let i = 0; i < steps.length; i++) {
          if (stopAIDiscussion) break;
          const step = steps[i];
          const ai2StepPrompt = `Ø£Ù†Øª Ø®Ø¨ÙŠØ± ØªØ·ÙˆÙŠØ± ÙˆØ§Ø¬Ù‡Ø§Øª ÙˆÙŠØ¨. Ù„Ø¯ÙŠÙƒ ÙƒÙˆØ¯ HTML ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† CSS Ø£Ùˆ JS Ø®Ø§Ø±Ø¬ÙŠ). Ù…Ù‡Ù…ØªÙƒ ØªÙ†ÙÙŠØ° Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªØ§Ù„ÙŠØ© ÙÙ‚Ø· Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠØŒ Ø«Ù… ØªØ¹ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† Ø´Ø±Ø­ Ø£Ùˆ ØªØ¹Ù„ÙŠÙ‚ Ø£Ùˆ Ø£ÙŠ Ù†Øµ Ø¢Ø®Ø±).\n\nØ§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ØªÙ†ÙÙŠØ°Ù‡Ø§:\n${step}\n\nØ§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ:\n---\n${improvedCode}\n---`;
          aiDiscussionContent.innerHTML += `<div style=\"margin-bottom:1rem;\"><b>AI2 (ØªÙ†ÙÙŠØ° Ø®Ø·ÙˆØ©: ${step.replace(/[&<>]/g, function(tag) {
            const charsToReplace = { '&': '&amp;', '<': '&lt;', '>': '&gt;' };
            return charsToReplace[tag] || tag;
          })}):</b><br><span style=\"color:#56c4d8;\">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°...</span></div>`;
          aiDiscussionContent.scrollTop = aiDiscussionContent.scrollHeight;
          let ai2StepCode = '';
          try {
            const ai2StepRes = await callGenAI(ai => ai.models.generateContent({
              model: 'gemini-2.5-flash',
              contents: ai2StepPrompt
            }));
            ai2StepCode = ai2StepRes.text.trim();
          } catch (err) {
            ai2StepCode = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªÙ†ÙÙŠØ° AI2: ' + err.message;
            stopAIDiscussion = true;
          }
          ai2Memory.push(ai2StepCode);
          aiDiscussionContent.innerHTML = aiDiscussionContent.innerHTML.replace(
            'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°...',
            `<div style=\"margin-bottom:0.5rem; color:#aaa; font-size:13px;\">(ØªÙ… ØªÙ†ÙÙŠØ° Ø§Ù„Ø®Ø·ÙˆØ©: ${step.replace(/[&<>]/g, function(tag) {
              const charsToReplace = { '&': '&amp;', '<': '&lt;', '>': '&gt;' };
              return charsToReplace[tag] || tag;
            })}. Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙƒØ§Ù…Ù„ ØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡ ÙÙŠ Ø§Ù„Ù…Ø­Ø±Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙˆÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„Ù‡ Ø£Ùˆ Ù…Ø¹Ø§ÙŠÙ†ØªÙ‡ Ù…Ø¨Ø§Ø´Ø±Ø©)</div><pre style=\"background:#222; color:#fff; padding:0.5rem; border-radius:6px; overflow:auto; max-height:200px;\">${ai2StepCode.replace(/[&<>]/g, function(tag) {
              const charsToReplace = { '&': '&amp;', '<': '&lt;', '>': '&gt;' };
              return charsToReplace[tag] || tag;
            })}</pre>`
          );
          aiDiscussionContent.scrollTop = aiDiscussionContent.scrollHeight;
          if (stopAIDiscussion) break;
          // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ Ø§Ù„Ù…Ø­Ø±Ø± Ø¨Ø¹Ø¯ ÙƒÙ„ Ø®Ø·ÙˆØ©
          improvedCode = ai2StepCode;
          updateCodeAndView(improvedCode);
          applyImprovedBtn.style.display = 'inline-block';
          // Ø§Ù†ØªØ¸Ø§Ø± Ù‚ØµÙŠØ± Ù„Ø¥ØªØ§Ø­Ø© Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù
          await new Promise(res => setTimeout(res, 400));
        }

        // Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ø­Ø³Ù†"
        applyImprovedBtn.onclick = () => {
          addCodeToHistory(improvedCode);
          updateCodeAndView(improvedCode);
          aiDiscussionModal.style.display = 'none';
        };

        // Ø§Ù†ØªØ¸Ø§Ø± Ù‚ØµÙŠØ± Ø¨ÙŠÙ† Ø§Ù„Ø¬ÙˆÙ„Ø§Øª (Ù„Ø¥ØªØ§Ø­Ø© Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù)
        await new Promise(res => setTimeout(res, 500));
      }
    }

    // ========== Self-Improvement Logic ==========
    let stopSelfImprove = false;
    selfImproveBtn.addEventListener('click', async () => {
      stopSelfImprove = false;
      selfImproveBtn.disabled = true;
      selfImproveBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ·ÙˆÙŠØ± Ø§Ù„Ø°Ø§ØªÙŠ...';
      let currentCode = sessions[currentSessionId].codeHistory[sessions[currentSessionId].historyIndex];
      let round = 1;
      while (!stopSelfImprove) {
        // Ø§Ø­Ø°Ù Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªØ·ÙˆÙŠØ± Ø§Ù„Ø°Ø§ØªÙŠ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù‚Ø¨Ù„ ÙƒÙ„ Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©
        clearSelfImproveMessages();
        // 1. Ø§Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ØªÙˆÙ„ÙŠØ¯ Ø®Ø·Ø© ØªØ·ÙˆÙŠØ± Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ
        const planningPrompt = `Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ø¨Ø±Ù…Ø¬ÙŠ Ø°Ø§ØªÙŠ Ø§Ù„ØªØ·ÙˆÙŠØ±. Ù…Ù‡Ù…ØªÙƒ Ø§Ù„ÙˆØ­ÙŠØ¯Ø© ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¬Ù…Ø§Ù„ÙŠØ§Øª ÙˆØ§Ù„ØªÙ†Ø³ÙŠÙ‚ ÙˆØ§Ù„Ø´ÙƒÙ„ ÙˆØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (UI/UX) Ù„Ù„ÙƒÙˆØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙ‚Ø·ØŒ Ù…Ø«Ù„ Ø§Ù„Ø£Ù„ÙˆØ§Ù†ØŒ Ø§Ù„Ø®Ø·ÙˆØ·ØŒ Ø§Ù„ØªØ¨Ø§Ø¹Ø¯ØŒ Ø§Ù„Ø±Ø³ÙˆÙ…ÙŠØ§ØªØŒ Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ø¨ØµØ±ÙŠØŒ ÙˆØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©. Ù„Ø§ ØªÙ‚ØªØ±Ø­ Ø£Ùˆ ØªÙ†ÙØ° Ø£ÙŠ ØªØºÙŠÙŠØ±Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø£Ùˆ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø£Ùˆ ØªØ¶ÙŠÙ Ù…ÙŠØ²Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©. Ø±ÙƒØ² ÙÙ‚Ø· Ø¹Ù„Ù‰ ØªØ­Ø³ÙŠÙ† CSS ÙˆHTML presentation. ÙÙŠ ÙƒÙ„ Ø¬ÙˆÙ„Ø©ØŒ Ø­Ù„Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆØ§Ù‚ØªØ±Ø­ Ø®Ø·Ø© ØªØ·ÙˆÙŠØ± Ø¬Ø¯ÙŠØ¯Ø© Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø´ÙƒÙ„ ÙˆØ§Ù„ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ø¨ØµØ±ÙŠØ© ÙÙ‚Ø·. Ø¥Ø°Ø§ Ù„Ù… ÙŠØ¹Ø¯ Ù‡Ù†Ø§Ùƒ Ù…Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ø³ÙŠÙ†Ù‡ ÙÙŠ Ø§Ù„Ø¬Ù…Ø§Ù„ÙŠØ§ØªØŒ Ø£Ø¬Ø¨ ÙÙ‚Ø·: 'Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ØªØ·ÙˆÙŠØ± Ø§Ù„Ø°Ø§ØªÙŠ.'\n\nØ§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ:\n---\n${currentCode}\n---`;
        let plan;
        try {
          const planningResponse = await callGenAI(ai => ai.models.generateContent({
            model: 'gemini-2.5-flash',
            contents: planningPrompt,
            config: {
              responseMimeType: "application/json",
              responseSchema: {
                type: Type.OBJECT,
                properties: {
                  tasks: { type: Type.ARRAY, items: { type: Type.STRING }, description: "Ø®Ø·ÙˆØ§Øª ØªØ·ÙˆÙŠØ± Ø°Ø§ØªÙŠ Ø¬Ø¯ÙŠØ¯Ø© (ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¬Ù…Ø§Ù„ÙŠØ© ÙÙ‚Ø·)." },
                  finished: { type: Type.BOOLEAN, description: "Ù‡Ù„ Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ØªØ·ÙˆÙŠØ± Ø§Ù„Ø°Ø§ØªÙŠØŸ" }
                },
                required: ["tasks", "finished"]
              }
            }
          }));
          plan = JSON.parse(planningResponse.text);
        } catch (err) {
          _createMessageElement('ÙØ´Ù„ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ Ø®Ø·Ø© ØªØ·ÙˆÙŠØ± Ø°Ø§ØªÙŠ: ' + err.message, 'ai');
          break;
        }
        if (plan.finished || !plan.tasks || plan.tasks.length === 0) {
          _createMessageElement('Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ØªØ·ÙˆÙŠØ± Ø§Ù„Ø°Ø§ØªÙŠ.', 'ai');
          taskProgressContainer.style.display = 'none';
          break;
        }
        // Ø¹Ø±Ø¶ Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù…
        renderTaskList(plan.tasks);
        let completedTasks = 0;
        for (let i = 0; i < plan.tasks.length; i++) {
          if (stopSelfImprove) break;
          const taskDesc = plan.tasks[i];
          updateTaskStatus(i, 'in-progress');
          const numberedCode = currentCode.split('\n').map((line, index) => `${index + 1}: ${line}`).join('\n');
          try {
            const executionPrompt = `Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ø¨Ø±Ù…Ø¬ÙŠ Ù…ØªØ®ØµØµ ÙÙŠ ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¬Ù…Ø§Ù„ÙŠØ§Øª ÙˆØ§Ù„ØªÙ†Ø³ÙŠÙ‚ ÙˆØ§Ù„Ø´ÙƒÙ„ (UI/UX, CSS, presentation) ÙÙ‚Ø·. Ù…Ù‡Ù…ØªÙƒ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„ØªØ­Ù‚ÙŠÙ‚ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªØ§Ù„ÙŠØ© ÙÙ‚Ø·ØŒ Ø¯ÙˆÙ† Ø£ÙŠ ØªØºÙŠÙŠØ± ÙÙŠ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø£Ùˆ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø£Ùˆ Ø¥Ø¶Ø§ÙØ© Ù…ÙŠØ²Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©.\n\nÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø±Ø¯Ùƒ ÙƒØ§Ø¦Ù† JSON ÙÙ‚Ø· Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø´ÙƒÙ„: { \"start_line\": Ø±Ù‚Ù…, \"end_line\": Ø±Ù‚Ù…, \"new_code\": \"Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯\" }\n- \"start_line\" Ùˆ\"end_line\" Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø£Ø³Ø·Ø± (1-based) Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ø£Ùˆ Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§.\n- Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª Ø¥Ø¯Ø±Ø§Ø¬ ÙƒÙˆØ¯ØŒ Ø§Ø¬Ø¹Ù„ end_line = start_line - 1.\n- Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª Ø­Ø°Ù Ø£Ø³Ø·Ø±ØŒ Ø§Ø¬Ø¹Ù„ new_code ÙØ§Ø±ØºØ§Ù‹.\n- new_code ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù†ØµØ§Ù‹ ÙˆØ§Ø­Ø¯Ø§Ù‹ Ù…Ø¹ \n Ù„Ù„ÙÙˆØ§ØµÙ„.\n\nØ§Ù„Ø®Ø·ÙˆØ©: ${taskDesc}\n\nØ§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ù…Ø¹ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø£Ø³Ø·Ø±):\n---\n${numberedCode}\n---\n\nØ£Ø¹Ø¯ ÙÙ‚Ø· ÙƒØ§Ø¦Ù† JSON Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø¨Ø¯ÙˆÙ† Ø£ÙŠ Ø´Ø±Ø­ Ø£Ùˆ Ù†Øµ Ø¥Ø¶Ø§ÙÙŠ.`;
            const response = await callGenAI(ai => ai.models.generateContent({
              model: 'gemini-2.5-flash',
              contents: executionPrompt,
              config: {
                responseMimeType: "application/json",
                responseSchema: {
                  type: Type.OBJECT,
                  properties: {
                    start_line: { type: Type.NUMBER, description: "Ø±Ù‚Ù… Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø£ÙˆÙ„ (1-based) Ù„Ù„ØªØ¹Ø¯ÙŠÙ„." },
                    end_line: { type: Type.NUMBER, description: "Ø±Ù‚Ù… Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø£Ø®ÙŠØ± (1-based) Ù„Ù„ØªØ¹Ø¯ÙŠÙ„." },
                    new_code: { type: Type.STRING, description: "Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø¥Ø¯Ø±Ø§Ø¬Ù‡ Ø£Ùˆ Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡ØŒ Ù…Ø¹ \n Ù„Ù„ÙÙˆØ§ØµÙ„." }
                  },
                  required: ["start_line", "end_line", "new_code"]
                }
              }
            }));
            const modification = JSON.parse(response.text);
            const { start_line, end_line, new_code } = modification;
            let codeLines = currentCode.split('\n');
            if (codeLines.length === 1 && codeLines[0] === '') {
                codeLines = [];
            }
            const startIdx = start_line - 1;
            const endIdx = end_line - 1;
            const deleteCount = Math.max(0, endIdx - startIdx + 1);
            if (startIdx < -1 || startIdx > codeLines.length) {
               throw new Error(`AI provided an invalid start line: ${start_line}. File has ${codeLines.length} lines.`);
            }
            const newCodeLines = (new_code === null || new_code === undefined) ? [] : new_code.split('\n');
            // Highlight the lines that will be modified (after the change)
            let lastModifiedLines = [];
            if (newCodeLines.length > 0) {
              for (let l = 0; l < newCodeLines.length; l++) {
                lastModifiedLines.push(startIdx + 1 + l);
              }
            }
            codeLines.splice(startIdx, deleteCount, ...newCodeLines);
            currentCode = codeLines.join('\n');
            updateCodeAndView(currentCode, lastModifiedLines);
            addCodeToHistory(currentCode);
            updateTaskStatus(i, 'completed');
            completedTasks++;
            taskCounter.textContent = `${completedTasks} / ${plan.tasks.length}`;
          } catch (err) {
            updateTaskStatus(i, 'failed', err.message);
            _createMessageElement('ÙØ´Ù„ ØªÙ†ÙÙŠØ° Ø®Ø·ÙˆØ© ØªØ·ÙˆÙŠØ± Ø°Ø§ØªÙŠ: ' + err.message, 'ai');
            stopSelfImprove = true;
            break;
          }
        }
        round++;
        await new Promise(res => setTimeout(res, 500));
      }
      selfImproveBtn.disabled = false;
      selfImproveBtn.textContent = 'ØªØ·ÙˆÙŠØ± Ø°Ø§ØªÙŠ';
    });
    // Ø²Ø± Ù„Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ·ÙˆÙŠØ± Ø§Ù„Ø°Ø§ØªÙŠ (ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ø³ÙŠÙ†Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹)
    selfImproveBtn.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      stopSelfImprove = true;
      selfImproveBtn.disabled = false;
      selfImproveBtn.textContent = 'ØªØ·ÙˆÙŠØ± Ø°Ø§ØªÙŠ';
      _createMessageElement('ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ·ÙˆÙŠØ± Ø§Ù„Ø°Ø§ØªÙŠ.', 'ai');
      taskProgressContainer.style.display = 'none';
    });



    // Ø¯Ø§Ù„Ø© Ù„Ø­Ø°Ù Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªØ·ÙˆÙŠØ± Ø§Ù„Ø°Ø§ØªÙŠ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù…Ù† Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
    function clearSelfImproveMessages() {
      const session = sessions[currentSessionId];
      if (!session) return;
      // Ø§Ø­Ø°Ù ÙƒÙ„ Ø±Ø³Ø§Ù„Ø© AI ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ 'Ø¬ÙˆÙ„Ø© ØªØ·ÙˆÙŠØ± Ø°Ø§ØªÙŠ' Ø£Ùˆ 'Ø§Ù„ÙƒÙˆØ¯ Ø¨Ø¹Ø¯ ØªØ·ÙˆÙŠØ± Ø§Ù„Ø®Ø·ÙˆØ©' Ø£Ùˆ 'Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ØªØ·ÙˆÙŠØ± Ø§Ù„Ø°Ø§ØªÙŠ.'
      session.messages = session.messages.filter(m => {
        if (m.sender !== 'ai') return true;
        if (/Ø¬ÙˆÙ„Ø© ØªØ·ÙˆÙŠØ± Ø°Ø§ØªÙŠ|Ø§Ù„ÙƒÙˆØ¯ Ø¨Ø¹Ø¯ ØªØ·ÙˆÙŠØ± Ø§Ù„Ø®Ø·ÙˆØ©|Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ØªØ·ÙˆÙŠØ± Ø§Ù„Ø°Ø§ØªÙŠ|ÙØ´Ù„ ØªÙ†ÙÙŠØ° Ø®Ø·ÙˆØ© ØªØ·ÙˆÙŠØ± Ø°Ø§ØªÙŠ|ÙØ´Ù„ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ Ø®Ø·Ø© ØªØ·ÙˆÙŠØ± Ø°Ø§ØªÙŠ|ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ·ÙˆÙŠØ± Ø§Ù„Ø°Ø§ØªÙŠ/.test(m.text)) return false;
        return true;
      });
      saveState();
      renderCurrentSession();
    }

    function renderChatList() {
      // Render sidebar chat list
      chatListSidebarList.innerHTML = '';
      const sessionIds = Object.keys(sessions);
      if (sessionIds.length === 0) return;
      sessionIds.forEach(sessionId => {
        const session = sessions[sessionId];
        let title = session.title || 'Ø¯Ø±Ø¯Ø´Ø© Ø¬Ø¯ÙŠØ¯Ø©';
        if (!session.title) {
          for (const msg of session.messages) {
            if (msg.sender === 'user' && msg.text.trim()) {
              title = msg.text.trim().slice(0, 24) + (msg.text.trim().length > 24 ? 'â€¦' : '');
              break;
            }
          }
        }
        const item = document.createElement('button');
        item.className = 'chat-list-item' + (sessionId === currentSessionId ? ' active' : '');
        item.innerHTML = `<svg class="chat-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg> <span>${title}</span>`;
        item.onclick = () => {
          if (currentSessionId !== sessionId) {
            currentSessionId = sessionId;
            renderCurrentSession();
            renderChatList();
            saveState();
          }
          closeChatListSidebar();
        };
        chatListSidebarList.appendChild(item);
      });
    }
    function openChatListSidebar() {
      chatListSidebar.classList.add('open');
      chatListOverlay.style.display = 'block';
    }
    function closeChatListSidebar() {
      chatListSidebar.classList.remove('open');
      chatListOverlay.style.display = 'none';
    }
    chatListToggleBtn.addEventListener('click', openChatListSidebar);
    chatListSidebarClose.addEventListener('click', closeChatListSidebar);
    chatListOverlay.addEventListener('click', closeChatListSidebar);
    chatListNewBtn.addEventListener('click', () => {
      console.log('ØªÙ… Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø¯Ø±Ø¯Ø´Ø© Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ');
      startNewChat();
      closeChatListSidebar();
    });

    deleteChatsBtn.addEventListener('click', () => {
      if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§ØªØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹.')) {
        sessions = {};
        currentSessionId = null;
        saveState();
        startNewChat();
        renderChatList();
        closeChatListSidebar();
      }
    });

    // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…ØªØ®ØµØµØ©
    function toggleToolsDropdown() {
      const isVisible = toolsDropdown.style.display !== 'none';
      toolsDropdown.style.display = isVisible ? 'none' : 'block';
    }
    
    function selectTool(mode) {
      currentMode = mode;
      toolsDropdown.style.display = 'none';
      
      const modeDescriptions = {
        'self-development': 'ØªÙ… ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„ØªØ·ÙˆÙŠØ± Ø§Ù„Ø°Ø§ØªÙŠ ğŸš€',
        'deep-thinking': 'ØªÙ… ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„ØªÙÙƒÙŠØ± Ø§Ù„Ø¹Ù…ÙŠÙ‚ ğŸ§ ',
        'code-research': 'ØªÙ… ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ ğŸ”',
        'bug-hunter': 'ØªÙ… ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ù…Ø·Ø§Ø±Ø¯ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ğŸ›',
        'performance-optimizer': 'ØªÙ… ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ù…Ø­Ø³Ù† Ø§Ù„Ø£Ø¯Ø§Ø¡ âš¡',
        'creative-mode': 'ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø¨Ø¯Ø§Ø¹ÙŠ ğŸ¨',
        'normal': 'ØªÙ… Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø§Ø¯ÙŠ ğŸ”„'
      };
      
      _createMessageElement(modeDescriptions[mode] || 'ØªÙ… ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø¬Ø¯ÙŠØ¯', 'ai');
      
      // ØªØºÙŠÙŠØ± Ù„ÙˆÙ† Ø²Ø± Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ù„ÙŠØ¹ÙƒØ³ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù†Ø´Ø·
      if (mode === 'normal') {
        toolsBtn.style.background = 'linear-gradient(135deg, var(--secondary-color), var(--primary-color))';
      } else {
        toolsBtn.style.background = `linear-gradient(135deg, ${getColorForMode(mode)})`;
      }
    }
    
    function getColorForMode(mode) {
      const colors = {
        'self-development': '#f59e0b, #d97706',
        'deep-thinking': '#7c3aed, #6d28d9',
        'code-research': '#06b6d4, #0891b2',
        'bug-hunter': '#ef4444, #dc2626',
        'performance-optimizer': '#10b981, #059669',
        'creative-mode': '#ec4899, #db2777'
      };
      return colors[mode] || '#7c3aed, #6d28d9';
    }
    
    // ØªØ­Ø³ÙŠÙ† Ø¯Ø§Ù„Ø© executeTaskPlan Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ø¯Ø¯
    async function executeAdvancedTaskPlan(tasks, prompt, mode) {
      const modePrompts = {
        'deep-thinking': 'Ø£Ù†Øª Ø®Ø¨ÙŠØ± Ù…ØªØ®ØµØµ ÙÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ‚. Ù‚Ù… Ø¨ØªØ­Ù„ÙŠÙ„ ÙƒÙ„ Ø®Ø·ÙˆØ© Ø¨Ø¹Ù…Ù‚ Ø´Ø¯ÙŠØ¯ ÙˆØ§Ù‚ØªØ±Ø­ Ø£ÙØ¶Ù„ Ø§Ù„Ø­Ù„ÙˆÙ„.',
        'bug-hunter': 'Ø£Ù†Øª Ø®Ø¨ÙŠØ± ÙÙŠ Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ø£Ø®Ø·Ø§Ø¡. Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£ÙŠ Ù…Ø´Ø§ÙƒÙ„ Ù…Ø­ØªÙ…Ù„Ø© ÙÙŠ ÙƒÙ„ Ø®Ø·ÙˆØ© ÙˆØ£ØµÙ„Ø­Ù‡Ø§.',
        'performance-optimizer': 'Ø£Ù†Øª Ø®Ø¨ÙŠØ± ÙÙŠ ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡. Ø±ÙƒØ² Ø¹Ù„Ù‰ ØªØ­Ø³ÙŠÙ† Ø³Ø±Ø¹Ø© ÙˆÙƒÙØ§Ø¡Ø© Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ ÙƒÙ„ Ø®Ø·ÙˆØ©.',
        'creative-mode': 'Ø£Ù†Øª Ø®Ø¨ÙŠØ± Ø¥Ø¨Ø¯Ø§Ø¹ÙŠ. Ø§Ù‚ØªØ±Ø­ Ø­Ù„ÙˆÙ„Ø§Ù‹ Ù…Ø¨ØªÙƒØ±Ø© ÙˆØ¬Ù…ÙŠÙ„Ø© ÙÙŠ ÙƒÙ„ Ø®Ø·ÙˆØ©.',
        'code-research': 'Ø£Ù†Øª Ø¨Ø§Ø­Ø« ÙÙŠ Ø§Ù„ÙƒÙˆØ¯. Ø§Ø´Ø±Ø­ ÙƒÙ„ Ø¬Ø²Ø¡ Ø¨ØªÙØµÙŠÙ„ ÙˆÙ‚Ø¯Ù… Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø´Ø§Ù…Ù„Ø©.',
        'self-development': 'Ø£Ù†Øª Ù†Ø¸Ø§Ù… ØªØ·ÙˆÙŠØ± Ø°Ø§ØªÙŠ. Ø­Ø³Ù† Ø§Ù„ÙƒÙˆØ¯ Ø¨Ø§Ø³ØªÙ…Ø±Ø§Ø± ÙˆØ§Ù‚ØªØ±Ø­ ØªØ·ÙˆÙŠØ±Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©.'
      };
      
      const specialPrompt = modePrompts[mode] || '';
      
      // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© ØªØ´ÙŠØ± Ø¥Ù„Ù‰ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø®ØªØ§Ø±
      _createMessageElement(`ğŸ¯ ØªÙ… ØªÙ†Ø´ÙŠØ· ${mode === 'deep-thinking' ? 'Ø§Ù„ØªÙÙƒÙŠØ± Ø§Ù„Ø¹Ù…ÙŠÙ‚' : 
                           mode === 'bug-hunter' ? 'Ù…Ø·Ø§Ø±Ø¯ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡' : 
                           mode === 'performance-optimizer' ? 'Ù…Ø­Ø³Ù† Ø§Ù„Ø£Ø¯Ø§Ø¡' : 
                           mode === 'creative-mode' ? 'Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø¨Ø¯Ø§Ø¹ÙŠ' : 
                           mode === 'code-research' ? 'Ø§Ù„Ø¨Ø§Ø­Ø« ÙÙŠ Ø§Ù„ÙƒÙˆØ¯' : 
                           'Ø§Ù„ØªØ·ÙˆÙŠØ± Ø§Ù„Ø°Ø§ØªÙŠ'}...`, 'ai');
      
      return executeTaskPlan(tasks, '', prompt, specialPrompt);
    }
    
    function init() {
      loadState();
      
      chatForm.addEventListener('submit', handleSendMessage);
      previewBtn.addEventListener('click', showPreview);
      applyBtn.addEventListener('click', applyChanges);
      closePreviewBtn.addEventListener('click', hidePreview);
      
      // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø£Ø¯ÙˆØ§Øª
      toolsBtn.addEventListener('click', toggleToolsDropdown);
      
      // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
      document.addEventListener('click', (e) => {
        if (!toolsBtn.contains(e.target) && !toolsDropdown.contains(e.target)) {
          toolsDropdown.style.display = 'none';
        }
      });
      
      // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ø¯ÙˆØ§Øª
      document.querySelectorAll('.tool-option').forEach(option => {
        option.addEventListener('click', () => {
          const mode = option.dataset.mode;
          selectTool(mode);
        });
      });

      undoBtn.addEventListener('click', undo);
      redoBtn.addEventListener('click', redo);

      // AI Discussion Modal events
      improveBtn.addEventListener('click', () => {
        aiDiscussionContent.innerHTML = '<div style="text-align:center; padding:2rem;">Ø¬Ø§Ø±ÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ù†Ù‚Ø§Ø´ Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠ Ø¨ÙŠÙ† Ø§Ù„Ø°ÙƒØ§Ø¡ÙŠÙ† Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠÙŠÙ†...</div>';
        aiDiscussionModal.style.display = 'flex';
        applyImprovedBtn.style.display = 'none';
        stopDiscussionBtn.disabled = false;
        stopDiscussionBtn.textContent = 'Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¬ÙˆÙ„Ø§Øª';
        startAIDiscussionLoop();
      });
      closeDiscussionBtn.addEventListener('click', () => {
        aiDiscussionModal.style.display = 'none';
      });
      stopDiscussionBtn.addEventListener('click', () => {
        stopAIDiscussion = true;
        stopDiscussionBtn.disabled = true;
        stopDiscussionBtn.textContent = 'ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù';
      });

      taskHeader.addEventListener('click', () => {
        taskProgressContainer.classList.toggle('collapsed');
      });
      
      promptInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            chatForm.requestSubmit();
        }
      });

      // Allow user to edit code manually
      codeDisplay.addEventListener('input', () => {
        const session = sessions[currentSessionId];
        if (!session) return;
        const newCode = codeDisplay.textContent;
        session.codeHistory[session.historyIndex] = newCode;
        saveState();
        hljs.highlightElement(codeDisplay); // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ„ÙˆÙŠÙ† Ø§Ù„ÙƒÙˆØ¯ Ø¨Ø¹Ø¯ ÙƒÙ„ ØªØ¹Ø¯ÙŠÙ„ ÙŠØ¯ÙˆÙŠ
      });
    }

    init();
  </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
